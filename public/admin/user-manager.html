<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>ANX • User Manager</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { theme: { extend: { colors: { anx: { sky: '#0ea5e9' }}}}};
  </script>
<style>
    :root {
      color-scheme: light;
      --surface: #ffffff;
      --surface-alt: #f8fafc;
      --border: #e2e8f0;
      --ink: #0f172a;
      --ink-muted: #64748b;
      --brand-primary: #2563eb;
      --brand-accent: #7c3aed;
    }

    body {
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background-color: var(--surface-alt);
      color: var(--ink);
    }

    .panel {
      border-radius: 1rem;
      border: 1px solid var(--border);
      background-color: var(--surface);
      box-shadow: 0 10px 25px -12px rgba(15, 23, 42, 0.35);
    }

    .panel-section {
      border-radius: 0.75rem;
      border: 1px solid var(--border);
      background-color: var(--surface);
    }

    .label-text {
      display: block;
      font-size: 0.75rem;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--ink-muted);
    }

    .input {
      width: 100%;
      border-radius: 0.75rem;
      border: 1px solid var(--border);
      background-color: var(--surface);
      padding: 0.5rem 0.75rem;
      font-size: 0.875rem;
      color: var(--ink);
      transition: box-shadow 0.15s ease, border-color 0.15s ease;
    }

    .input:focus {
      outline: none;
      border-color: var(--brand-primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
    }

    .textarea {
      width: 100%;
      border-radius: 0.75rem;
      border: 1px solid var(--border);
      background-color: var(--surface);
      padding: 0.75rem;
      font-size: 0.875rem;
      color: var(--ink);
      transition: box-shadow 0.15s ease, border-color 0.15s ease;
      min-height: 6rem;
      resize: vertical;
    }

    .textarea:focus {
      outline: none;
      border-color: var(--brand-primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      border-radius: 0.75rem;
      border: 1px solid var(--border);
      background-color: var(--surface);
      padding: 0.5rem 0.85rem;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--ink);
      transition: background-color 0.15s ease, color 0.15s ease, border-color 0.15s ease;
      cursor: pointer;
    }

    .btn-primary {
      border-color: var(--brand-primary);
      background-color: var(--brand-primary);
      color: #fff;
    }

    .btn-primary:hover {
      border-color: var(--brand-accent);
      background-color: var(--brand-accent);
    }

    .btn-outline {
      border-color: var(--border);
      background-color: var(--surface);
      color: var(--ink);
    }

    .btn-outline:hover {
      background-color: var(--surface-alt);
    }

    .btn-ghost {
      border-color: transparent;
      background-color: transparent;
      color: var(--ink-muted);
    }

    .btn-ghost:hover {
      background-color: var(--surface-alt);
      color: var(--ink);
    }

    .btn:disabled {
      cursor: not-allowed;
      opacity: 0.55;
    }

    .btn-danger {
      border-color: #dc2626;
      background-color: #dc2626;
      color: #fff;
    }

    .btn-danger:hover {
      border-color: #b91c1c;
      background-color: #b91c1c;
    }

    .btn-danger-outline {
      border-color: #ef4444;
      background-color: var(--surface);
      color: #b91c1c;
    }

    .btn-danger-outline:hover {
      background-color: #fef2f2;
      color: #991b1b;
    }

    body.modal-open {
      overflow: hidden;
    }

    .modal-overlay {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 1.5rem;
      background-color: rgba(15, 23, 42, 0.5);
      z-index: 50;
    }

    .modal-overlay.is-open {
      display: flex;
    }

    .modal-overlay-confirm {
      z-index: 60;
    }

    .modal {
      width: 100%;
      max-width: 36rem;
      border-radius: 1rem;
      border: 1px solid var(--border);
      background-color: var(--surface);
      box-shadow: 0 32px 64px -24px rgba(15, 23, 42, 0.5);
      display: flex;
      flex-direction: column;
    }

    .modal-sm {
      max-width: 28rem;
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      padding: 1rem 1.25rem;
      border-bottom: 1px solid var(--border);
    }

    .modal-body {
      padding: 1.25rem;
      max-height: min(70vh, 600px);
      overflow-y: auto;
    }

    .modal-footer {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 0.75rem;
      padding: 1rem 1.25rem;
      border-top: 1px solid var(--border);
      flex-wrap: wrap;
    }

    .table {
      width: 100%;
      border-collapse: collapse;
      text-align: left;
    }

    .table th,
    .table td {
      padding: 0.75rem 1rem;
      border-bottom: 1px solid var(--border);
      font-size: 0.875rem;
    }

    .table tbody tr:hover {
      background-color: var(--surface-alt);
    }

    .badge {
      display: inline-flex;
      align-items: center;
      padding: 0.125rem 0.5rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .badge-published {
      background-color: rgba(34, 197, 94, 0.18);
      color: #15803d;
    }

    .badge-draft {
      background-color: rgba(59, 130, 246, 0.18);
      color: #1d4ed8;
    }

    .badge-deprecated {
      background-color: rgba(251, 191, 36, 0.24);
      color: #b45309;
    }

    .badge-archived {
      background-color: rgba(148, 163, 184, 0.25);
      color: #475569;
    }

    .empty-row td {
      text-align: center;
      padding: 2.5rem 1rem;
      color: var(--ink-muted);
      font-size: 0.875rem;
    }
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <div class="max-w-6xl mx-auto p-4 space-y-6">
    <header class="flex items-center justify-between gap-4 flex-wrap">
      <div>
        <h1 class="text-2xl font-bold">User Manager</h1>
        <p class="text-sm text-slate-500">Invite teammates, update their profiles, and control access.</p>
      </div>

      <div class="flex items-center gap-3 flex-wrap justify-end">
        <div class="flex flex-wrap gap-2">

          <a href="/admin/user-manager" class="btn btn-primary text-sm">Users</a>
          <a href="/admin/program-template-manager.html" class="btn btn-outline text-sm">Program Templates</a>
        </div>
        <a href="/" class="text-sm text-anx-sky underline">← Back to Orientation</a>
      </div>
    </header>

    <section class="bg-white border rounded-2xl p-4 space-y-4">
      <div class="flex flex-wrap gap-3 items-end">
        <div class="flex-1 min-w-[260px]">
          <label class="block text-sm mb-1" for="q">Search users</label>
          <input id="q" class="w-full border rounded-xl px-3 py-2 text-sm" placeholder="Search by name or email…">
        </div>
        <div class="min-w-[200px]">
          <label class="block text-sm mb-1">Selected user</label>
          <div id="selectedUserSummary" class="text-sm font-medium">—</div>
        </div>
        <div class="flex items-center gap-2">
          <input id="inputImportUsers" type="file" accept=".csv,application/json,.json,text/csv" class="hidden" />
          <button id="btnImportUsers" class="inline-flex items-center gap-2 px-3 py-2 rounded-xl border text-sm">Import</button>
          <button id="btnExportUsers" class="inline-flex items-center gap-2 px-3 py-2 rounded-xl border text-sm">Export CSV</button>
          <button id="btnReloadUsers" class="inline-flex items-center gap-2 px-3 py-2 rounded-xl border text-sm">Refresh</button>
        </div>
      </div>

      <p id="importUsersStatus" class="text-sm text-slate-500"></p>

      <div class="mt-4 grid md:grid-cols-2 gap-4">
        <div>
          <div id="userList" class="bg-slate-50 border rounded-xl max-h-[380px] overflow-auto text-sm"></div>
        </div>
        <div class="space-y-4">
          <div class="border rounded-xl p-4">
            <div class="flex items-start justify-between gap-3">
              <div>
                <div id="selectedName" class="text-lg font-semibold">Select a user</div>
                <div id="selectedUsername" class="text-sm text-slate-500">Search or choose a user to view their details.</div>
                <div id="selectedOrganization" class="text-sm text-slate-500">Organization: —</div>
              </div>
              <div id="selectedStatus" class="hidden text-xs uppercase tracking-wide bg-slate-100 text-slate-600 px-3 py-1 rounded-full"></div>
            </div>
            <div class="mt-4">
              <div class="text-xs font-semibold uppercase text-slate-500">Roles</div>
              <div id="selectedRoles" class="mt-2 flex flex-wrap gap-2 text-xs text-slate-600">
                <span class="text-slate-500">Roles will appear once a user is selected.</span>
              </div>
            </div>
          </div>

          <div class="border rounded-xl p-4">
            <div class="text-sm font-semibold mb-3">User actions</div>
            <div class="grid gap-2 sm:grid-cols-2">
              <button id="btnOpenCreate" class="inline-flex items-center justify-center px-3 py-2 rounded-xl border text-sm bg-anx-sky text-white">Create / Invite</button>
              <button id="btnOpenEdit" data-requires-user class="inline-flex items-center justify-center px-3 py-2 rounded-xl border text-sm">Edit name &amp; email</button>
              <button id="btnOpenRoles" data-requires-user class="inline-flex items-center justify-center px-3 py-2 rounded-xl border text-sm">Update roles</button>
              <button id="btnOpenPrograms" data-requires-user class="inline-flex items-center justify-center px-3 py-2 rounded-xl border text-sm">Assign programs</button>
              <button id="btnRemovePrograms" type="button" data-requires-user class="inline-flex items-center justify-center px-3 py-2 rounded-xl border text-sm">Remove programs</button>
              <button id="btnLoadCalendar" data-requires-user class="inline-flex items-center justify-center px-3 py-2 rounded-xl border text-sm">Load calendar</button>
              <button id="btnOpenLifecycle" data-requires-user class="inline-flex items-center justify-center px-3 py-2 rounded-xl border text-sm sm:col-span-2">Deactivate / Reactivate / Archive</button>
              <button id="btnOpenAccess" class="inline-flex items-center justify-center px-3 py-2 rounded-xl border text-sm sm:col-span-2">Manage Users Access</button>
            </div>
            <p id="loadCalendarStatus" class="mt-3 text-sm text-slate-500"></p>
            <p id="removeProgramsStatus" class="mt-3 text-sm text-slate-500"></p>
            <p id="actionHint" class="mt-3 text-xs text-slate-500">Select a user to enable profile actions.</p>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- Drawers -->
  <div id="drawerCreate" data-drawer class="hidden fixed inset-0 z-40">
    <div class="absolute inset-0 bg-slate-900/40" data-drawer-close></div>
    <div class="absolute right-0 top-0 bottom-0 w-full max-w-md bg-white shadow-xl p-6 overflow-y-auto" data-drawer-panel>
      <div class="flex items-start justify-between gap-3">
        <div>
          <h2 class="text-lg font-semibold">Invite a new user</h2>
          <p class="text-sm text-slate-500 mt-1">Send an invitation email and assign starter roles.</p>
        </div>
        <button type="button" class="text-slate-500 hover:text-slate-900" data-drawer-close>&times;</button>
      </div>
      <form id="formCreate" class="mt-4 space-y-4">
        <div>
          <label class="block text-sm mb-1" for="createFullName">Full name</label>
          <input id="createFullName" name="fullName" class="w-full border rounded-xl px-3 py-2 text-sm" placeholder="ex: Jamie Ramirez" data-autofocus>
        </div>
        <div>
          <label class="block text-sm mb-1" for="createEmail">Email</label>
          <input id="createEmail" name="email" type="email" class="w-full border rounded-xl px-3 py-2 text-sm" placeholder="name@example.com" required>
        </div>
        <div>
          <label class="block text-sm mb-1" for="createRoles">Initial roles</label>
          <select id="createRoles" name="roles" multiple class="w-full border rounded-xl px-3 py-2 text-sm h-28">
            <option value="admin">admin</option>
            <option value="manager">manager</option>
            <option value="viewer">viewer</option>
            <option value="trainee">trainee</option>
            <option value="auditor">auditor</option>
          </select>
          <p class="text-xs text-slate-500 mt-1">Hold ⌘/Ctrl to select more than one role.</p>
        </div>
        <label class="inline-flex items-center gap-2 text-sm">
          <input id="createSendInvite" name="sendInvite" type="checkbox" class="rounded border-slate-300">
          <span>Send invitation email immediately</span>
        </label>
        <div class="flex justify-end gap-2">
          <button type="button" class="px-3 py-2 rounded-xl border text-sm" data-drawer-close>Cancel</button>
          <button type="submit" class="px-3 py-2 rounded-xl border text-sm bg-anx-sky text-white">Send invite</button>
        </div>
        <div id="createMsg" class="text-xs text-slate-500"></div>
      </form>
    </div>
  </div>

  <div id="drawerEdit" data-drawer class="hidden fixed inset-0 z-40">
    <div class="absolute inset-0 bg-slate-900/40" data-drawer-close></div>
    <div class="absolute right-0 top-0 bottom-0 w-full max-w-md bg-white shadow-xl p-6 overflow-y-auto" data-drawer-panel>
        <div class="flex items-start justify-between gap-3">
            <div>
                <h2 class="text-lg font-semibold">Edit user details</h2>
                <p class="text-sm text-slate-500 mt-1">Update the name or email address for the selected user.</p>
            </div>
            <button type="button" class="text-slate-500 hover:text-slate-900" data-drawer-close>&times;</button>
        </div>
        <form id="formEdit" class="mt-4 space-y-4">
            <div>
                <label class="block text-sm mb-1" for="editFullName">Full name</label>
                <input id="editFullName" name="fullName" class="input" placeholder="Full name">
            </div>
            <div class="grid grid-cols-1 gap-4 sm:grid-cols-3">
                <div>
                    <label class="block text-sm mb-1" for="editLastName">Last name</label>
                    <input id="editLastName" name="lastName" class="input" placeholder="Last name">
                </div>
                <div>
                    <label class="block text-sm mb-1" for="editFirstName">First name</label>
                    <input id="editFirstName" name="firstName" class="input" placeholder="First name">
                </div>
                <div>
                    <label class="block text-sm mb-1" for="editSurname">Surname</label>
                    <input id="editSurname" name="surname" class="input" placeholder="Surname">
                </div>
            </div>
            <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                <div>
                    <label class="block text-sm mb-1" for="editOrganization">Organization</label>
                    <select id="editOrganization" name="organization" class="input">
                        <option value="">None</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm mb-1" for="editSubUnit">Sub-unit</label>
                    <select id="editSubUnit" name="subUnit" class="input">
                        <option value="">None</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm mb-1" for="editDepartment">Department</label>
                    <select id="editDepartment" name="department" class="input">
                        <option value="">None</option>
                    </select>
                </div>
                <div class="sm:col-span-2">
                    <label class="block text-sm mb-1" for="editDisciplineType">Discipline type</label>
                    <select id="editDisciplineType" name="disciplineType" class="input">
                        <option value="">None</option>
                    </select>
                </div>
            </div>
            <div>
                <label class="block text-sm mb-1" for="editEmail">Email</label>
                <input id="editEmail" name="email" type="email" class="input" placeholder="name@example.com" required>
            </div>
            <div class="flex justify-end gap-2">
                <button type="button" class="px-3 py-2 rounded-xl border text-sm" data-drawer-close>Cancel</button>
                <button type="submit" class="px-3 py-2 rounded-xl border text-sm bg-anx-sky text-white">Save changes</button>
            </div>
            <div id="editMsg" class="text-xs text-slate-500"></div>
        </form>
    </div>
</div>

  <div id="drawerRoles" data-drawer class="hidden fixed inset-0 z-40">
    <div class="absolute inset-0 bg-slate-900/40" data-drawer-close></div>
    <div class="absolute right-0 top-0 bottom-0 w-full max-w-md bg-white shadow-xl p-6 overflow-y-auto" data-drawer-panel>
      <div class="flex items-start justify-between gap-3">
        <div>
          <h2 class="text-lg font-semibold">Update roles</h2>
          <p class="text-sm text-slate-500 mt-1">Choose which roles apply to <span id="rolesUserName" class="font-medium text-slate-700">this user</span>.</p>
        </div>
        <button type="button" class="text-slate-500 hover:text-slate-900" data-drawer-close>&times;</button>
      </div>
      <form id="formRoles" class="mt-4 space-y-4">
        <div id="drawerRolesBox" class="flex flex-wrap gap-2 text-sm"></div>
        <p id="rolesInfo" class="text-xs text-slate-500"></p>
        <div class="flex justify-end gap-2">
          <button type="button" class="px-3 py-2 rounded-xl border text-sm" data-drawer-close>Cancel</button>
          <button type="submit" class="px-3 py-2 rounded-xl border text-sm bg-anx-sky text-white">Save roles</button>
        </div>
        <div id="rolesDrawerMsg" class="text-xs text-slate-500"></div>
      </form>
    </div>
  </div>

  <div id="drawerPrograms" data-drawer class="hidden fixed inset-0 z-40">
    <div class="absolute inset-0 bg-slate-900/40" data-drawer-close></div>
    <div class="absolute right-0 top-0 bottom-0 w-full max-w-md bg-white shadow-xl p-6 overflow-y-auto" data-drawer-panel>
      <div class="flex items-start justify-between gap-3">
        <div>
          <h2 class="text-lg font-semibold">Assign programs</h2>
          <p class="text-sm text-slate-500 mt-1">Preload orientation programs for <span id="programsUserName" class="font-medium text-slate-700">this user</span>.</p>
        </div>
        <button type="button" class="text-slate-500 hover:text-slate-900" data-drawer-close>&times;</button>
      </div>
      <form id="formPrograms" class="mt-4 space-y-4">
        <div id="drawerProgramList" class="grid grid-cols-1 sm:grid-cols-2 gap-2 text-sm"></div>
        <div class="flex justify-end gap-2">
          <button type="button" class="px-3 py-2 rounded-xl border text-sm" data-drawer-close>Cancel</button>
          <button type="submit" class="px-3 py-2 rounded-xl border text-sm bg-anx-sky text-white">Assign programs</button>
        </div>
        <div id="programsMsg" class="text-xs text-slate-500"></div>
      </form>
    </div>
  </div>

  <div id="drawerRemovePrograms" data-drawer class="hidden fixed inset-0 z-40">
    <div class="absolute inset-0 bg-slate-900/40" data-drawer-close></div>
    <div class="absolute right-0 top-0 bottom-0 w-full max-w-md bg-white shadow-xl p-6 overflow-y-auto" data-drawer-panel>
      <div class="flex items-start justify-between gap-3">
        <div>
          <h2 class="text-lg font-semibold">Remove programs</h2>
          <p class="text-sm text-slate-500 mt-1">Select the programs you want to remove from <span id="removeProgramsUserName" class="font-medium text-slate-700">this user</span>.</p>
        </div>
        <button type="button" class="text-slate-500 hover:text-slate-900" data-drawer-close>&times;</button>
      </div>
      <form id="formRemovePrograms" class="mt-4 space-y-4">
        <div id="drawerRemoveProgramList" class="grid grid-cols-1 sm:grid-cols-2 gap-2 text-sm"></div>
        <div class="flex flex-wrap justify-end gap-2">
          <button type="button" class="btn btn-outline text-sm" data-drawer-close>Cancel</button>
          <button type="submit" class="btn text-sm" data-action="deactivate">Deactivate selected</button>
          <button type="submit" class="btn btn-primary text-sm" data-action="activate">Activate selected</button>
          <button id="btnConfirmRemovePrograms" type="submit" class="btn btn-danger text-sm" data-action="delete">Remove selected programs</button>
        </div>
        <div id="removeProgramsDrawerMsg" class="text-xs text-slate-500"></div>
      </form>
    </div>
  </div>

  <div id="drawerLifecycle" data-drawer class="hidden fixed inset-0 z-40">
    <div class="absolute inset-0 bg-slate-900/40" data-drawer-close></div>
    <div class="absolute right-0 top-0 bottom-0 w-full max-w-md bg-white shadow-xl p-6 overflow-y-auto" data-drawer-panel>
      <div class="flex items-start justify-between gap-3">
        <div>
          <h2 class="text-lg font-semibold">Manage user lifecycle</h2>
          <p class="text-sm text-slate-500 mt-1">Deactivate, reactivate, or archive <span id="lifecycleUserName" class="font-medium text-slate-700">this user</span>.</p>
        </div>
        <button type="button" class="text-slate-500 hover:text-slate-900" data-drawer-close>&times;</button>
      </div>
      <form id="formDeactivate" class="mt-4 space-y-3">
        <div>
          <label class="block text-sm mb-1" for="deactivateReason">Reason (optional)</label>
          <textarea id="deactivateReason" name="reason" rows="3" class="w-full border rounded-xl px-3 py-2 text-sm" placeholder="Share context for this change."></textarea>
        </div>
        <button id="btnDeactivate" type="submit" class="w-full inline-flex justify-center px-3 py-2 rounded-xl border text-sm">Deactivate user</button>
      </form>
      <div class="mt-4 grid gap-2">
        <button id="btnReactivate" class="px-3 py-2 rounded-xl border text-sm">Reactivate user</button>
        <button id="btnArchive" class="px-3 py-2 rounded-xl border text-sm">Archive user</button>
      </div>
      <div id="lifecycleMsg" class="text-xs text-slate-500 mt-3"></div>
    </div>
  </div>

  <div id="drawerAccess" data-drawer class="hidden fixed inset-0 z-40">
    <div class="absolute inset-0 bg-slate-900/40" data-drawer-close></div>
    <div class="absolute right-0 top-0 bottom-0 w-full max-w-lg bg-white shadow-xl p-6 overflow-y-auto" data-drawer-panel>
      <div class="flex items-start justify-between gap-3">
        <div>
          <h2 class="text-lg font-semibold">Manage users access</h2>
          <p class="text-sm text-slate-500 mt-1">Create local accounts and manage credentials for teammates.</p>
        </div>
        <button type="button" class="text-slate-500 hover:text-slate-900" data-drawer-close>&times;</button>
      </div>
      <p id="accessDrawerNotice" class="mt-3 text-sm text-rose-600 hidden">Only admins can manage user access.</p>
      <div class="mt-4 space-y-6">
        <section class="border rounded-xl p-4 space-y-3">
          <div>
            <h3 class="text-sm font-semibold">Provision credentials for <span id="accessProvisionName" class="font-semibold text-slate-900">this user</span></h3>
            <p class="text-xs text-slate-500">Assign a username and temporary password for the selected user.</p>
          </div>
          <form id="formAccessProvision" class="space-y-3">
            <div>
              <label class="block text-sm mb-1" for="provisionUsername">Username</label>
              <input id="provisionUsername" name="username" class="input" placeholder="username" autocomplete="off">
            </div>
            <div>
              <label class="block text-sm mb-1" for="provisionPassword">Temporary password</label>
              <div class="flex items-center gap-2">
                <input id="provisionPassword" name="password" type="text" class="input" placeholder="Generate a secure password">
                <button id="btnGenerateProvisionPassword" type="button" class="btn btn-outline text-xs whitespace-nowrap">Generate</button>
              </div>
            </div>
            <div class="flex justify-end">
              <button type="submit" class="btn btn-primary text-sm">Save credentials</button>
            </div>
            <p id="accessProvisionMsg" class="text-xs text-slate-500"></p>
          </form>
        </section>

        <section class="border rounded-xl p-4 space-y-3">
          <div>
            <h3 class="text-sm font-semibold">Reset password for <span id="accessResetName" class="font-semibold text-slate-900">this user</span></h3>
            <p class="text-xs text-slate-500">Provide a new temporary password and share it securely.</p>
          </div>
          <form id="formAccessReset" class="space-y-3">
            <div>
              <label class="block text-sm mb-1" for="resetPassword">New temporary password</label>
              <div class="flex items-center gap-2">
                <input id="resetPassword" name="password" type="text" class="input" placeholder="Generate a secure password">
                <button id="btnGenerateResetPassword" type="button" class="btn btn-outline text-xs whitespace-nowrap">Generate</button>
              </div>
            </div>
            <div class="flex justify-end">
              <button type="submit" class="btn text-sm">Reset password</button>
            </div>
            <p id="accessResetMsg" class="text-xs text-slate-500"></p>
          </form>
        </section>

        <section class="border rounded-xl p-4 space-y-3">
          <div>
            <h3 class="text-sm font-semibold">Create a new local user</h3>
            <p class="text-xs text-slate-500">Provision a username and initial password without sending an invitation email.</p>
          </div>
          <form id="formAccessCreate" class="space-y-3">
            <div class="grid gap-3 sm:grid-cols-2">
              <div class="sm:col-span-2">
                <label class="block text-sm mb-1" for="accessCreateFullName">Full name</label>
                <input id="accessCreateFullName" name="fullName" class="input" placeholder="Jamie Ramirez">
              </div>
              <div class="sm:col-span-2">
                <label class="block text-sm mb-1" for="accessCreateEmail">Email</label>
                <input id="accessCreateEmail" name="email" type="email" class="input" placeholder="name@example.com">
              </div>
              <div>
                <label class="block text-sm mb-1" for="accessCreateUsername">Username</label>
                <input id="accessCreateUsername" name="username" class="input" placeholder="username" autocomplete="off" data-autofocus>
              </div>
              <div>
                <label class="block text-sm mb-1" for="accessCreatePassword">Initial password</label>
                <div class="flex items-center gap-2">
                  <input id="accessCreatePassword" name="password" type="text" class="input" placeholder="Generate a secure password">
                  <button id="btnGenerateCreatePassword" type="button" class="btn btn-outline text-xs whitespace-nowrap">Generate</button>
                </div>
              </div>
            </div>
            <div class="flex justify-end">
              <button type="submit" class="btn btn-primary text-sm">Create user</button>
            </div>
            <p id="accessCreateMsg" class="text-xs text-slate-500"></p>
          </form>
        </section>
      </div>
    </div>
  </div>

  <script type="module">
import { ORGANIZATION_OPTIONS, SUB_UNIT_OPTIONS, DEPARTMENT_OPTIONS, DISCIPLINE_TYPE_OPTIONS } from '../../shared/field-options.js';

const API = window.location.origin;

const HTML_ESCAPES = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' };
function escapeHtml(value = '') {
  return String(value).replace(/[&<>"']/g, ch => HTML_ESCAPES[ch] || ch);
}

const CSV_BOM = '\uFEFF';

function normalizeCsvValue(value) {
  if (value === null || value === undefined) {
    return '';
  }
  if (value instanceof Date) {
    return value.toISOString();
  }
  if (Array.isArray(value)) {
    const parts = value
      .map(item => normalizeCsvValue(item))
      .filter(part => part !== '');
    return parts.join('; ');
  }
  if (typeof value === 'object') {
    if (typeof value.toISOString === 'function') {
      try {
        return value.toISOString();
      } catch (err) {
        // continue to other fallbacks
      }
    }
    if (typeof value.name === 'string' && value.name) {
      const id = value.id ?? value.identifier ?? value.slug ?? '';
      if (id && id !== value.name) {
        return `${value.name} (${id})`;
      }
      return value.name;
    }
    if (typeof value.title === 'string' && value.title) {
      const id = value.id ?? value.program_id ?? value.programId ?? '';
      if (id && id !== value.title) {
        return `${value.title} (${id})`;
      }
      return value.title;
    }
    try {
      return JSON.stringify(value);
    } catch (err) {
      return String(value);
    }
  }
  return String(value);
}

function escapeCsvCell(value) {
  const text = normalizeCsvValue(value).replace(/\r?\n/g, '\n');
  if (text === '') {
    return '';
  }
  if (/[",\n]/.test(text)) {
    return `"${text.replace(/"/g, '""')}"`;
  }
  return text;
}

const USER_FIELD_ALIASES = {
  google_id: ['googleId', 'googleID'],
  email: ['username'],
  full_name: ['fullName', 'name'],
  picture_url: ['pictureUrl'],
  created_at: ['createdAt'],
  updated_at: ['updatedAt'],
  username: ['email'],
  password_hash: ['passwordHash'],
  provider: ['authProvider'],
  last_login_at: ['lastLoginAt'],
  organization: ['organization_name', 'organizationName'],
  status: ['state'],
  discipline_type: ['disciplineType'],
  last_name: ['lastName'],
  surname: ['maiden_name', 'maidenName'],
  first_name: ['firstName'],
  department: ['department_name', 'departmentName'],
  sub_unit: ['subUnit'],
  program_id: ['programId', 'program', 'programID', 'program_slug', 'programSlug'],
};

const USER_EXPORT_FIELDS = [
  'id',
  'google_id',
  'email',
  'full_name',
  'picture_url',
  'created_at',
  'updated_at',
  'username',
  'password_hash',
  'provider',
  'last_login_at',
  'organization',
  'status',
  'discipline_type',
  'last_name',
  'surname',
  'first_name',
  'department',
  'sub_unit',
];

function getUserCsvRawValue(user, key) {
  if (!user || typeof user !== 'object') {
    return '';
  }
  const aliases = USER_FIELD_ALIASES[key] || [];
  const keysToCheck = [key, ...aliases];
  for (const candidateKey of keysToCheck) {
    if (!Object.prototype.hasOwnProperty.call(user, candidateKey)) {
      continue;
    }
    const rawValue = user[candidateKey];
    if (rawValue === null || rawValue === undefined) {
      continue;
    }
    if (typeof rawValue === 'string' && rawValue.trim() === '') {
      continue;
    }
    if (Array.isArray(rawValue) && rawValue.length === 0) {
      continue;
    }
    return rawValue;
  }
  return '';
}

function buildUsersCsv(users) {
  const rows = [USER_EXPORT_FIELDS.map(escapeCsvCell).join(',')];
  if (Array.isArray(users)) {
    users.forEach(user => {
      const cells = USER_EXPORT_FIELDS.map(field => {
        const value = getUserCsvRawValue(user, field);
        return escapeCsvCell(value);
      });
      rows.push(cells.join(','));
    });
  }
  return `${CSV_BOM}${rows.join('\r\n')}`;
}

function downloadUsersCsv(users) {
  try {
    const csvText = buildUsersCsv(users);
    const blob = new Blob([csvText], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    const timestamp = new Date().toISOString().replace(/[\.:]/g, '-');
    link.download = `users-${timestamp}.csv`;
    document.body.appendChild(link);
    link.click();
    const cleanup = () => {
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    };
    if (typeof requestAnimationFrame === 'function') {
      requestAnimationFrame(cleanup);
    } else {
      setTimeout(cleanup, 0);
    }
  } catch (error) {
    console.error('Failed to export users', error);
  }
}

const USER_FIELD_LOOKUP = (() => {
  const normalizeKey = key => (key || '').toString().trim().toLowerCase().replace(/[^a-z0-9]+/g, '_');
  const entries = new Map();
  Object.entries(USER_FIELD_ALIASES).forEach(([canonical, aliases = []]) => {
    const normalizedCanonical = normalizeKey(canonical);
    if (normalizedCanonical) {
      entries.set(normalizedCanonical, canonical);
    }
    aliases.forEach(alias => {
      const normalizedAlias = normalizeKey(alias);
      if (normalizedAlias) {
        entries.set(normalizedAlias, canonical);
      }
    });
  });
  entries.set('id', 'id');
  entries.set('email', 'email');
  entries.set('username', 'username');
  entries.set('google_id', 'google_id');
  entries.set('assigned_programs', 'assigned_programs');
  entries.set('program', 'program_id');
  entries.set('programid', 'program_id');
  entries.set('program_id', 'program_id');
  entries.set('programs', 'program_id');
  return entries;
})();

function normalizeUserImportKey(key) {
  if (!key) return '';
  const normalized = key.toString().trim().toLowerCase().replace(/[^a-z0-9]+/g, '_');
  return USER_FIELD_LOOKUP.get(normalized) || normalized;
}

function normalizeUserImportRecord(record) {
  if (!record || typeof record !== 'object') {
    return null;
  }
  const normalized = {};
  Object.entries(record).forEach(([key, value]) => {
    if (!key) return;
    const canonicalKey = normalizeUserImportKey(key);
    if (!canonicalKey) return;
    if (value === null || value === undefined) return;
    if (typeof value === 'string') {
      const trimmed = value.trim();
      if (trimmed === '') return;
      normalized[canonicalKey] = trimmed;
      return;
    }
    if (Array.isArray(value)) {
      if (!value.length) return;
      normalized[canonicalKey] = value;
      return;
    }
    if (typeof value === 'object') {
      normalized[canonicalKey] = value;
      return;
    }
    normalized[canonicalKey] = value;
  });
  return Object.keys(normalized).length ? normalized : null;
}

function readFileAsText(file) {
  if (!(file instanceof File)) {
    return Promise.reject(new Error('A valid file must be selected.'));
  }
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => {
      resolve(typeof reader.result === 'string' ? reader.result : '');
    };
    reader.onerror = () => {
      reject(reader.error || new Error('Unable to read the selected file.'));
    };
    reader.readAsText(file);
  });
}

function stripBom(text) {
  if (typeof text !== 'string') {
    return '';
  }
  return text.replace(/^\uFEFF/, '');
}

function parseImportCsv(text) {
  const input = stripBom(text);
  if (!input) return [];
  const rows = [];
  let current = '';
  let insideQuotes = false;
  const pushCell = () => {
    rows[rows.length - 1].push(current);
    current = '';
  };
  const ensureRow = () => {
    if (!rows.length) {
      rows.push([]);
    }
  };
  for (let index = 0; index < input.length; index += 1) {
    const char = input[index];
    if (char === '"') {
      if (insideQuotes && input[index + 1] === '"') {
        current += '"';
        index += 1;
      } else {
        insideQuotes = !insideQuotes;
      }
      continue;
    }
    if (!insideQuotes && (char === '\n' || char === '\r')) {
      ensureRow();
      pushCell();
      if (char === '\r' && input[index + 1] === '\n') {
        index += 1;
      }
      rows.push([]);
      continue;
    }
    if (!insideQuotes && char === ',') {
      ensureRow();
      pushCell();
      continue;
    }
    current += char;
  }
  if (!rows.length) {
    rows.push([]);
  }
  pushCell();
  if (!rows.length) return [];
  const [headerRow, ...dataRows] = rows;
  const headers = headerRow.map(header => header && header.trim()).map(header => header || null);
  if (!headers.some(Boolean)) return [];
  const records = [];
  dataRows.forEach(cells => {
    const isEmptyRow = cells.every(cell => (cell || '').trim() === '');
    if (isEmptyRow) return;
    const record = {};
    headers.forEach((header, index) => {
      if (!header) return;
      record[header] = cells[index] ?? '';
    });
    if (Object.keys(record).length) {
      records.push(record);
    }
  });
  return records;
}

function extractImportRecords(payload, keys = []) {
  if (Array.isArray(payload)) {
    return payload;
  }
  if (!payload || typeof payload !== 'object') {
    return [];
  }
  const fallbackKeys = ['users', 'data', 'items', 'results', 'records'];
  const searchKeys = Array.from(new Set([...(Array.isArray(keys) ? keys : []), ...fallbackKeys]));
  for (const key of searchKeys) {
    if (!key) continue;
    const value = payload[key];
    if (Array.isArray(value)) {
      return value;
    }
    if (value && typeof value === 'object') {
      const nested = extractImportRecords(value, keys);
      if (nested.length) {
        return nested;
      }
    }
  }
  return [];
}

function parseImportJson(text, keys = []) {
  if (!text) return [];
  try {
    const parsed = JSON.parse(stripBom(text));
    const extracted = extractImportRecords(parsed, keys);
    if (extracted.length) {
      return extracted;
    }
    if (parsed && typeof parsed === 'object' && !Array.isArray(parsed)) {
      return [parsed];
    }
    return Array.isArray(parsed) ? parsed : [];
  } catch (error) {
    console.error('Failed to parse import JSON.', error);
    return [];
  }
}

const USER_PROFILE_MUTABLE_FIELDS = new Set([
  'full_name',
  'email',
  'organization',
  'last_name',
  'first_name',
  'surname',
  'sub_unit',
  'discipline_type',
  'department',
  'status',
  'username',
  'picture_url',
  'provider',
  'google_id',
  'password_hash',
  'last_login_at',
]);

const USER_IMPORT_RECORD_KEYS = ['users', 'data', 'items', 'records'];

function buildUserProfilePayload(record) {
  const payload = {};
  if (!record || typeof record !== 'object') {
    return payload;
  }
  USER_PROFILE_MUTABLE_FIELDS.forEach(field => {
    if (!(field in record)) return;
    const value = record[field];
    if (value === null || value === undefined) return;
    if (typeof value === 'string') {
      const trimmed = value.trim();
      if (!trimmed) return;
      payload[field] = trimmed;
      return;
    }
    payload[field] = value;
  });
  return payload;
}

function parseRolesFromRecord(record) {
  if (!record || typeof record !== 'object') return [];
  const value = record.roles;
  if (!value && value !== 0) return [];
  if (Array.isArray(value)) {
    return value
      .map(role => (role === null || role === undefined ? '' : String(role).trim()))
      .filter(Boolean);
  }
  if (typeof value === 'string') {
    const trimmed = value.trim();
    if (!trimmed) return [];
    try {
      if ((trimmed.startsWith('[') && trimmed.endsWith(']')) || (trimmed.startsWith('"') && trimmed.endsWith('"'))) {
        const parsed = JSON.parse(trimmed);
        if (Array.isArray(parsed)) {
          return parsed
            .map(role => (role === null || role === undefined ? '' : String(role).trim()))
            .filter(Boolean);
        }
      }
    } catch (error) {
      // ignore JSON parse errors and fall back to splitting
    }
    return trimmed
      .split(/[;,]/)
      .map(part => part.trim())
      .filter(Boolean);
  }
  return [];
}

function buildUserCreatePayload(record) {
  const payload = buildUserProfilePayload(record);
  if (record && typeof record.email === 'string' && record.email.trim() && !payload.email) {
    payload.email = record.email.trim();
  }
  if (payload.email && !payload.username) {
    payload.username = payload.email;
  }
  const roles = parseRolesFromRecord(record);
  if (roles.length) {
    payload.roles = roles;
  }
  if (!('sendInvite' in payload)) {
    payload.sendInvite = false;
  }
  return payload;
}

function parseProgramIdentifiers(value, results) {
  if (!results) {
    results = [];
  }
  if (value === null || value === undefined) {
    return results;
  }
  if (Array.isArray(value)) {
    value.forEach(item => parseProgramIdentifiers(item, results));
    return results;
  }
  if (typeof value === 'object') {
    const programId = extractProgramId(value);
    if (programId) {
      results.push(programId);
    }
    return results;
  }
  if (typeof value === 'string') {
    const trimmed = value.trim();
    if (!trimmed) {
      return results;
    }
    try {
      if ((trimmed.startsWith('[') && trimmed.endsWith(']')) || (trimmed.startsWith('{') && trimmed.endsWith('}'))) {
        const parsed = JSON.parse(trimmed);
        return parseProgramIdentifiers(parsed, results);
      }
    } catch (error) {
      // ignore JSON parse errors and fall back to delimiter parsing
    }
    trimmed
      .split(/[;,\n]/)
      .map(part => part.trim())
      .filter(Boolean)
      .forEach(part => results.push(part));
    return results;
  }
  const stringValue = String(value).trim();
  if (stringValue) {
    results.push(stringValue);
  }
  return results;
}

function collectProgramIds(record) {
  if (!record || typeof record !== 'object') {
    return [];
  }
  const values = [];
  if ('program_id' in record) {
    parseProgramIdentifiers(record.program_id, values);
  }
  if ('assigned_programs' in record) {
    parseProgramIdentifiers(record.assigned_programs, values);
  }
  const unique = Array.from(new Set(values.map(id => (id === null || id === undefined ? '' : String(id).trim()))));
  return unique.filter(Boolean);
}

function isKnownProgram(programId) {
  if (!programId) return false;
  const id = String(programId);
  return PROGRAMS.some(program => extractProgramId(program) === id);
}

function findUserMatchForRecord(record, programId) {
  if (programId) {
    const byProgram = USERS.find(user => {
      if (!user || !Array.isArray(user.assigned_programs)) return false;
      return user.assigned_programs.some(assignment => extractProgramId(assignment) === programId);
    });
    if (byProgram) {
      return byProgram;
    }
  }
  const candidateKeys = ['id', 'email', 'username', 'google_id'];
  const candidates = candidateKeys
    .map(key => {
      if (!record || !(key in record)) return null;
      const value = record[key];
      if (value === null || value === undefined) return null;
      const stringValue = typeof value === 'string' ? value.trim() : String(value).trim();
      if (!stringValue) return null;
      return { key, value: stringValue.toLowerCase() };
    })
    .filter(Boolean);
  if (!candidates.length) {
    return null;
  }
  for (const user of USERS) {
    if (!user) continue;
    for (const candidate of candidates) {
      const userValue = getUserCsvRawValue(user, candidate.key);
      if (!userValue && userValue !== 0) continue;
      const stringValue = typeof userValue === 'string' ? userValue.trim() : String(userValue).trim();
      if (!stringValue) continue;
      if (stringValue.toLowerCase() === candidate.value) {
        return user;
      }
    }
  }
  return null;
}

async function assignProgramsForImport(userId, programIds, baseUser) {
  const unique = Array.from(new Set((Array.isArray(programIds) ? programIds : []).map(id => String(id)))).filter(Boolean);
  if (!unique.length) {
    return { assigned: 0, failed: 0 };
  }
  let assigned = 0;
  let failed = 0;
  const knownIds = unique.filter(isKnownProgram);
  const unknownIds = unique.filter(programId => !isKnownProgram(programId));
  failed += unknownIds.length;
  for (const programId of knownIds) {
    const alreadyAssigned = baseUser && Array.isArray(baseUser.assigned_programs)
      ? baseUser.assigned_programs.some(program => extractProgramId(program) === programId)
      : false;
    if (alreadyAssigned) {
      continue;
    }
    try {
      const res = await preloadForUser(userId, programId);
      if (res.ok) {
        assigned += 1;
        if (baseUser) {
          if (!Array.isArray(baseUser.assigned_programs)) {
            baseUser.assigned_programs = [];
          }
          const exists = baseUser.assigned_programs.some(program => extractProgramId(program) === programId);
          if (!exists) {
            baseUser.assigned_programs.push({ program_id: programId });
          }
        }
      } else {
        failed += 1;
      }
    } catch (error) {
      console.error('Failed to assign program to user.', error);
      failed += 1;
    }
  }
  return { assigned, failed };
}

async function handleUserImportSelection(event) {
  const inputElement = event && event.target instanceof HTMLInputElement ? event.target : elInputImportUsers;
  const file = inputElement && inputElement.files ? inputElement.files[0] : null;
  if (!file) {
    return;
  }
  try {
    const fileName = file.name || 'selected file';
    setStatusText(elImportUsersStatus, `Reading ${fileName}…`, 'neutral');
    const fileText = await readFileAsText(file);
    const fileType = (file.type || '').toLowerCase();
    const isJson = fileName.toLowerCase().endsWith('.json') || fileType.includes('json');
    const rawRecords = isJson ? parseImportJson(fileText, USER_IMPORT_RECORD_KEYS) : parseImportCsv(fileText);
    if (!Array.isArray(rawRecords) || !rawRecords.length) {
      setStatusText(elImportUsersStatus, 'No users were imported. Please verify the file contents and try again.', 'error');
      return;
    }
    const normalizedEntries = rawRecords
      .map((record, index) => ({ index, record: normalizeUserImportRecord(record) }))
      .filter(entry => entry.record);
    if (!normalizedEntries.length) {
      setStatusText(elImportUsersStatus, 'No users were imported. Please verify the file contents and try again.', 'error');
      return;
    }
    const total = normalizedEntries.length;
    let success = 0;
    let failure = 0;
    for (let i = 0; i < total; i += 1) {
      const { record, index: originalIndex } = normalizedEntries[i];
      const recordNumber = originalIndex + 1;
      setStatusText(elImportUsersStatus, `Importing users (${i + 1}/${total})…`, 'neutral');
      const programIds = collectProgramIds(record);
      const primaryProgramId = programIds[0] || '';
      const roles = parseRolesFromRecord(record);
      const targetUser = findUserMatchForRecord(record, primaryProgramId);
      try {
        if (targetUser && targetUser.id) {
          const payload = buildUserProfilePayload(record);
          let resolvedUser = targetUser;
          if (payload && Object.keys(payload).length) {
            const res = await updateUserProfile(targetUser.id, payload);
            if (!res.ok) {
              const message = await res.text().catch(() => '');
              throw new Error(message || `Failed to update user ${targetUser.id}.`);
            }
            const contentType = res.headers.get('content-type') || '';
            if (contentType.includes('application/json')) {
              try {
                const data = await res.json();
                if (data && typeof data === 'object') {
                  resolvedUser = { ...targetUser, ...data };
                }
              } catch (parseError) {
                console.warn('Failed to parse update response', parseError);
                resolvedUser = mergeUserProfilePayload(targetUser, payload) || targetUser;
              }
            } else {
              resolvedUser = mergeUserProfilePayload(targetUser, payload) || targetUser;
            }
          }
          if (roles.length) {
            const resRoles = await saveUserRoles(targetUser.id, roles);
            if (!resRoles.ok) {
              throw new Error('Failed to update user roles.');
            }
            resolvedUser = { ...resolvedUser, roles };
          }
          const assignmentResult = await assignProgramsForImport(targetUser.id, programIds, resolvedUser);
          if (assignmentResult.failed > 0 && programIds.length) {
            throw new Error('Failed to assign one or more programs.');
          }
          const userIndex = USERS.findIndex(user => user && user.id === targetUser.id);
          if (userIndex !== -1) {
            USERS[userIndex] = { ...USERS[userIndex], ...resolvedUser };
          }
          success += 1;
        } else {
          const createPayload = buildUserCreatePayload(record);
          if (!createPayload.email) {
            throw new Error('Email is required to create a user.');
          }
          const res = await createUser(createPayload);
          if (!res.ok) {
            const message = await res.text().catch(() => '');
            throw new Error(message || 'Failed to create user.');
          }
          const contentType = res.headers.get('content-type') || '';
          let createdUser = null;
          if (contentType.includes('application/json')) {
            try {
              createdUser = await res.json();
            } catch (parseError) {
              console.warn('Failed to parse create response', parseError);
            }
          }
          const createdUserId = createdUser?.id || createPayload.id || null;
          if (!createdUserId) {
            throw new Error('User ID missing from create response.');
          }
          const trackingUser = createdUser
            ? { ...createdUser }
            : {
                id: createdUserId,
                email: createPayload.email,
                username: createPayload.username || createPayload.email,
                full_name: createPayload.full_name || record.full_name || '',
                assigned_programs: [],
              };
          if (!Array.isArray(trackingUser.assigned_programs)) {
            trackingUser.assigned_programs = [];
          }
          if (!trackingUser.roles && createPayload.roles) {
            trackingUser.roles = createPayload.roles;
          }
          const assignmentResult = await assignProgramsForImport(createdUserId, programIds, trackingUser);
          if (assignmentResult.failed > 0 && programIds.length) {
            throw new Error('Failed to assign one or more programs.');
          }
          USERS.push(trackingUser);
          success += 1;
        }
      } catch (recordError) {
        failure += 1;
        console.error(`Failed to import user record ${recordNumber}`, recordError);
      }
    }
    const summary = `Import complete — ${success} succeeded, ${failure} failed.`;
    const tone = failure === 0 ? 'success' : success === 0 ? 'error' : 'neutral';
    setStatusText(elImportUsersStatus, summary, tone);
    try {
      await reloadUsers(true);
    } catch (refreshError) {
      console.error('Failed to reload users after import.', refreshError);
      setStatusText(elImportUsersStatus, `${summary} Unable to refresh users automatically.`, 'error');
    }
  } catch (error) {
    console.error('User import failed.', error);
    setStatusText(elImportUsersStatus, 'User import failed. Please review the file and try again.', 'error');
  } finally {
    if (inputElement) {
      inputElement.value = '';
    }
  }
}

function populateSelectOptions(selectElement, options) {
  if (!(selectElement instanceof HTMLSelectElement) || !Array.isArray(options)) {
    return;
  }
  const existingValues = new Set(Array.from(selectElement.options, option => option.value));
  options.forEach(optionValue => {
    if (!optionValue || existingValues.has(optionValue)) {
      return;
    }
    const option = document.createElement('option');
    option.value = optionValue;
    option.textContent = optionValue;
    selectElement.appendChild(option);
    existingValues.add(optionValue);
  });
}

function setStatusText(element, message, tone = 'neutral') {
  if (!element) return;
  element.textContent = message;
  element.classList.remove('text-slate-500', 'text-emerald-600', 'text-rose-600');
  if (tone === 'success') {
    element.classList.add('text-emerald-600');
  } else if (tone === 'error') {
    element.classList.add('text-rose-600');
  } else {
    element.classList.add('text-slate-500');
  }
}

function clearStatusText(element) {
  if (!element) return;
  element.textContent = '';
  element.classList.remove('text-emerald-600', 'text-rose-600');
  element.classList.add('text-slate-500');
}

function extractProgramId(program) {
  if (!program) return '';
  const id = program.program_id ?? program.id ?? program.programId ?? program.programID ?? program.slug ?? '';
  return id != null ? String(id) : '';
}

function ensureSelectValue(selectElement, value) {
  if (!(selectElement instanceof HTMLSelectElement)) {
    return;
  }
  if (value === null || value === undefined || value === '') {
    selectElement.value = '';
    return;
  }
  const stringValue = String(value);
  const hasOption = Array.from(selectElement.options).some(option => option.value === stringValue);
  if (!hasOption) {
    const option = document.createElement('option');
    option.value = stringValue;
    option.textContent = stringValue;
    selectElement.appendChild(option);
  }
  selectElement.value = stringValue;
}

function createSearchParams(params) {
  if (!params) {
    return new URLSearchParams();
  }
  if (params instanceof URLSearchParams) {
    return new URLSearchParams(params);
  }
  if (typeof params === 'string') {
    return params.trim() ? new URLSearchParams(params) : new URLSearchParams();
  }
  const searchParams = new URLSearchParams();
  if (typeof params === 'object') {
    Object.entries(params).forEach(([key, rawValue]) => {
      if (rawValue === null || rawValue === undefined) return;
      if (Array.isArray(rawValue)) {
        rawValue.forEach(item => {
          if (item === null || item === undefined || item === '') return;
          searchParams.append(key, String(item));
        });
      } else if (rawValue !== '') {
        searchParams.append(key, String(rawValue));
      }
    });
  }
  return searchParams;
}

function isOrganizationFilterKey(key) {
  if (!key) return false;
  const normalized = String(key).trim().toLowerCase();
  return normalized === 'organization' || normalized === 'organization_id' || normalized === 'organizationid' || normalized === 'organization-id';
}

const meRes = await fetch(`${API}/me`, { credentials: 'include' });
if (!meRes.ok) {
  location.href = '/';
}
const me = await meRes.json();
const IS_ADMIN = (me.roles || []).includes('admin');
const IS_MANAGER = (me.roles || []).includes('manager');
const managerOrganizationId = me?.organization_id ?? me?.organizationId ?? me?.organization ?? null;
const HAS_MANAGER_ORG_SCOPE = Boolean(IS_MANAGER && !IS_ADMIN && managerOrganizationId);
const managerOrganizationQueryValue = HAS_MANAGER_ORG_SCOPE ? String(managerOrganizationId) : '';

function buildUserListUrl(params) {
  const searchParams = createSearchParams(params);
  const hasOrganizationFilter = Array.from(searchParams.keys()).some(isOrganizationFilterKey);
  if (HAS_MANAGER_ORG_SCOPE && managerOrganizationQueryValue && !hasOrganizationFilter) {
    searchParams.set('organization_id', managerOrganizationQueryValue);
  }
  const queryString = searchParams.toString();
  return `${API}/rbac/users${queryString ? `?${queryString}` : ''}`;
}

async function listUsers(params) {
  const url = buildUserListUrl(params);
  const r = await fetch(url, { credentials: 'include' });
  if (!r.ok) throw new Error('GET /rbac/users failed');
  return r.json();
}
async function listPrograms() {
  const r = await fetch(`${API}/programs`, { credentials: 'include' });
  if (!r.ok) throw new Error('GET /programs failed');
  return r.json();
}
async function saveUserRoles(userId, roles) {
  return fetch(`${API}/rbac/users/${userId}/roles`, {
    method: 'PATCH',
    credentials: 'include',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ roles })
  });
}
async function preloadForUser(userId, programId) {
  return fetch(`${API}/rbac/users/${userId}/programs/${encodeURIComponent(programId)}/instantiate`, {
    method: 'POST',
    credentials: 'include'
  });
}
async function deleteProgramForUser(userId, programId) {
  return fetch(`${API}/rbac/users/${userId}/programs/${encodeURIComponent(programId)}`, {
    method: 'DELETE',
    credentials: 'include'
  });
}
async function createUser(payload) {
  return fetch(`${API}/api/users`, {
    method: 'POST',
    credentials: 'include',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });
}
async function updateUserProfile(userId, payload) {
  return fetch(`${API}/api/users/${userId}`, {
    method: 'PATCH',
    credentials: 'include',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });
}
async function deactivateUserRequest(userId, reason) {
  return fetch(`${API}/api/users/${userId}/deactivate`, {
    method: 'POST',
    credentials: 'include',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ reason })
  });
}
async function reactivateUserRequest(userId) {
  return fetch(`${API}/api/users/${userId}/reactivate`, {
    method: 'POST',
    credentials: 'include'
  });
}
async function archiveUserRequest(userId) {
  return fetch(`${API}/api/users/${userId}/archive`, {
    method: 'POST',
    credentials: 'include'
  });
}

async function createLocalUserAccess(payload) {
  return fetch(`${API}/api/users/local`, {
    method: 'POST',
    credentials: 'include',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });
}

async function provisionUserAccess(userId, payload) {
  return fetch(`${API}/api/users/${userId}/provision`, {
    method: 'POST',
    credentials: 'include',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });
}

async function resetUserPasswordRequest(userId, payload) {
  return fetch(`${API}/api/users/${userId}/reset-password`, {
    method: 'POST',
    credentials: 'include',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });
}

function persistSelectedTraineeSession(trainee) {
  try {
    if (!trainee || !trainee.id) {
      sessionStorage.removeItem('anx_selected_trainee');
      return;
    }
    const payload = {
      id: trainee.id,
      name: trainee.name || ''
    };
    sessionStorage.setItem('anx_selected_trainee', JSON.stringify(payload));
  } catch (error) {
    console.warn('Failed to persist trainee selection', error);
  }
}

const HIDDEN_PROGRAMS_STORAGE_KEY = 'anx_hidden_programs';

function readHiddenProgramsMap() {
  try {
    const raw = sessionStorage.getItem(HIDDEN_PROGRAMS_STORAGE_KEY);
    if (!raw) {
      return {};
    }
    const parsed = JSON.parse(raw);
    if (!parsed || typeof parsed !== 'object') {
      return {};
    }
    const sanitized = {};
    for (const [userId, programList] of Object.entries(parsed)) {
      if (!programList) continue;
      const values = Array.isArray(programList)
        ? programList
        : typeof programList === 'string'
          ? [programList]
          : [];
      const unique = Array.from(new Set(values.map(value => String(value)).filter(Boolean)));
      if (unique.length) {
        sanitized[String(userId)] = unique;
      }
    }
    return sanitized;
  } catch (error) {
    console.warn('Failed to read hidden program state', error);
    return {};
  }
}

function writeHiddenProgramsMap(map) {
  try {
    if (!map || typeof map !== 'object') {
      sessionStorage.removeItem(HIDDEN_PROGRAMS_STORAGE_KEY);
      return;
    }
    const payload = {};
    for (const [userId, programList] of Object.entries(map)) {
      if (!programList) continue;
      const list = Array.isArray(programList)
        ? programList.map(value => String(value)).filter(Boolean)
        : [];
      if (list.length) {
        payload[String(userId)] = list;
      }
    }
    if (Object.keys(payload).length) {
      sessionStorage.setItem(HIDDEN_PROGRAMS_STORAGE_KEY, JSON.stringify(payload));
    } else {
      sessionStorage.removeItem(HIDDEN_PROGRAMS_STORAGE_KEY);
    }
  } catch (error) {
    console.warn('Failed to persist hidden program state', error);
  }
}

function getHiddenProgramsForUser(userId) {
  if (!userId) {
    return new Set();
  }
  const map = readHiddenProgramsMap();
  const list = Array.isArray(map[String(userId)]) ? map[String(userId)] : [];
  return new Set(list.map(value => String(value)).filter(Boolean));
}

function updateHiddenProgramsForUser(userId, programIds, hidden) {
  if (!userId || !programIds || !programIds.length) {
    return getHiddenProgramsForUser(userId);
  }
  const map = readHiddenProgramsMap();
  const key = String(userId);
  const current = new Set(Array.isArray(map[key]) ? map[key].map(value => String(value)).filter(Boolean) : []);
  for (const programId of programIds) {
    const value = String(programId || '');
    if (!value) continue;
    if (hidden) {
      current.add(value);
    } else {
      current.delete(value);
    }
  }
  if (current.size) {
    map[key] = Array.from(current);
  } else {
    delete map[key];
  }
  writeHiddenProgramsMap(map);
  return current;
}

async function updatePreferredTrainee(userId) {
  return fetch(`${API}/prefs`, {
    method: 'PATCH',
    credentials: 'include',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ trainee: userId })
  });
}

let USERS = [];
let PROGRAMS = [];
let selectedUser = null;

const elQ = document.getElementById('q');
const elUserList = document.getElementById('userList');
const elSelectedSummary = document.getElementById('selectedUserSummary');
const elSelectedName = document.getElementById('selectedName');
const elSelectedUsername = document.getElementById('selectedUsername');
const elSelectedOrganization = document.getElementById('selectedOrganization');
const elSelectedStatus = document.getElementById('selectedStatus');
const elSelectedRoles = document.getElementById('selectedRoles');
const elBtnReloadUsers = document.getElementById('btnReloadUsers');
const elBtnExportUsers = document.getElementById('btnExportUsers');
const elBtnImportUsers = document.getElementById('btnImportUsers');
const elInputImportUsers = document.getElementById('inputImportUsers');
const elImportUsersStatus = document.getElementById('importUsersStatus');
const actionHint = document.getElementById('actionHint');

const btnOpenCreate = document.getElementById('btnOpenCreate');
const btnOpenEdit = document.getElementById('btnOpenEdit');
const btnOpenRoles = document.getElementById('btnOpenRoles');
const btnOpenPrograms = document.getElementById('btnOpenPrograms');
const btnOpenLifecycle = document.getElementById('btnOpenLifecycle');
const btnOpenAccess = document.getElementById('btnOpenAccess');
const userActionButtons = document.querySelectorAll('[data-requires-user]');

const formCreate = document.getElementById('formCreate');
const formEdit = document.getElementById('formEdit');
const formRoles = document.getElementById('formRoles');
const formPrograms = document.getElementById('formPrograms');
const formRemovePrograms = document.getElementById('formRemovePrograms');
const formDeactivate = document.getElementById('formDeactivate');
const formAccessProvision = document.getElementById('formAccessProvision');
const formAccessReset = document.getElementById('formAccessReset');
const formAccessCreate = document.getElementById('formAccessCreate');

const createMsg = document.getElementById('createMsg');
const editMsg = document.getElementById('editMsg');
const rolesDrawerMsg = document.getElementById('rolesDrawerMsg');
const programsMsg = document.getElementById('programsMsg');
const removeProgramsDrawerMsg = document.getElementById('removeProgramsDrawerMsg');
const lifecycleMsg = document.getElementById('lifecycleMsg');
const accessProvisionMsg = document.getElementById('accessProvisionMsg');
const accessResetMsg = document.getElementById('accessResetMsg');
const accessCreateMsg = document.getElementById('accessCreateMsg');
const btnLoadCalendar = document.getElementById('btnLoadCalendar');
const btnRemovePrograms = document.getElementById('btnRemovePrograms');
const loadCalendarStatus = document.getElementById('loadCalendarStatus');
const removeProgramsStatus = document.getElementById('removeProgramsStatus');

const rolesInfo = document.getElementById('rolesInfo');
const rolesUserName = document.getElementById('rolesUserName');
const programsUserName = document.getElementById('programsUserName');
const removeProgramsUserName = document.getElementById('removeProgramsUserName');
const lifecycleUserName = document.getElementById('lifecycleUserName');
const accessProvisionName = document.getElementById('accessProvisionName');
const accessResetName = document.getElementById('accessResetName');

const drawerRolesBox = document.getElementById('drawerRolesBox');
const drawerProgramList = document.getElementById('drawerProgramList');
const drawerRemoveProgramList = document.getElementById('drawerRemoveProgramList');

const inputEditFullName = document.getElementById('editFullName');
const inputEditLastName = document.getElementById('editLastName');
const inputEditFirstName = document.getElementById('editFirstName');
const inputEditSurname = document.getElementById('editSurname');
const inputEditSubUnit = document.getElementById('editSubUnit');
const inputEditDepartment = document.getElementById('editDepartment');
const inputEditDisciplineType = document.getElementById('editDisciplineType');
const inputEditOrganization = document.getElementById('editOrganization');
const inputEditEmail = document.getElementById('editEmail');
const inputCreateRoles = document.getElementById('createRoles');
const textareaDeactivateReason = document.getElementById('deactivateReason');
const provisionUsernameInput = document.getElementById('provisionUsername');
const provisionPasswordInput = document.getElementById('provisionPassword');
const resetPasswordInput = document.getElementById('resetPassword');
const createFullNameInput = document.getElementById('accessCreateFullName');
const createEmailInput = document.getElementById('accessCreateEmail');
const createUsernameInput = document.getElementById('accessCreateUsername');
const createPasswordInput = document.getElementById('accessCreatePassword');
const btnGenerateProvisionPassword = document.getElementById('btnGenerateProvisionPassword');
const btnGenerateResetPassword = document.getElementById('btnGenerateResetPassword');
const btnGenerateCreatePassword = document.getElementById('btnGenerateCreatePassword');
const accessDrawerNotice = document.getElementById('accessDrawerNotice');

populateSelectOptions(inputEditOrganization, ORGANIZATION_OPTIONS);
populateSelectOptions(inputEditSubUnit, SUB_UNIT_OPTIONS);
populateSelectOptions(inputEditDepartment, DEPARTMENT_OPTIONS);
populateSelectOptions(inputEditDisciplineType, DISCIPLINE_TYPE_OPTIONS);

const organizationFilterSelect = (() => {
  const selectors = [
    '[data-organization-filter]',
    '#organizationFilter',
    '#filterOrganization',
    'select[name="organizationFilter"]',
  ];
  for (const selector of selectors) {
    const candidate = document.querySelector(selector);
    if (candidate instanceof HTMLSelectElement && candidate !== inputEditOrganization) {
      return candidate;
    }
  }
  return null;
})();

if (organizationFilterSelect && HAS_MANAGER_ORG_SCOPE && managerOrganizationQueryValue) {
  ensureSelectValue(organizationFilterSelect, managerOrganizationQueryValue);
  organizationFilterSelect.disabled = true;
  organizationFilterSelect.classList.add('opacity-60', 'cursor-not-allowed');
}

const btnDeactivate = document.getElementById('btnDeactivate');
const btnReactivate = document.getElementById('btnReactivate');
const btnArchive = document.getElementById('btnArchive');

function setUserActionState(enabled) {
  userActionButtons.forEach(btn => {
    btn.disabled = !enabled;
    btn.classList.toggle('opacity-50', !enabled);
    btn.classList.toggle('pointer-events-none', !enabled);
  });
}
setUserActionState(false);

function mergeUserProfilePayload(baseUser, payload) {
  if (!baseUser || !payload) {
    return null;
  }
  const merged = { ...baseUser };
  if ('full_name' in payload) {
    merged.full_name = payload.full_name;
    merged.name = payload.full_name;
  }
  if ('email' in payload) {
    merged.email = payload.email;
    if (payload.email) {
      merged.username = payload.email;
    }
  }
  if ('organization' in payload) {
    merged.organization = payload.organization;
  }
  if ('last_name' in payload) {
    merged.last_name = payload.last_name;
  }
  if ('first_name' in payload) {
    merged.first_name = payload.first_name;
  }
  if ('surname' in payload) {
    merged.surname = payload.surname;
  }
  if ('sub_unit' in payload) {
    merged.sub_unit = payload.sub_unit;
  }
  if ('department' in payload) {
    merged.department = payload.department;
  }
  if ('discipline_type' in payload) {
    merged.discipline_type = payload.discipline_type;
  }
  return merged;
}

function renderUsers(filter = '') {
  const f = filter.trim().toLowerCase();
  const rows = USERS
    .filter(u => {
      const fullName = (u.full_name || '').toLowerCase();
      const email = (u.email || u.username || '').toLowerCase();
      return fullName.includes(f) || email.includes(f);
    })
    .sort((a, b) => (a.full_name || '').localeCompare(b.full_name || ''));
  if (!rows.length) {
    elUserList.innerHTML = '<div class="p-4 text-sm text-slate-500">No users match your search.</div>';
    return;
  }
  elUserList.innerHTML = rows.map(u => {
    const active = selectedUser && selectedUser.id === u.id;
    const idAttr = escapeHtml(u.id || '');
    const displayName = escapeHtml(u.full_name || '—');
    const email = escapeHtml(u.email || u.username || '');
    const organization = escapeHtml(u.organization || '—');
    const status = escapeHtml(u.status || 'active');
    const roles = escapeHtml((u.roles || []).join(', ') || '—');
    const classes = active ? 'bg-white shadow-sm' : '';
    return `
    <button data-id="${idAttr}" class="w-full text-left px-3 py-2 border-b hover:bg-white ${classes}">
      <div class="font-medium">${displayName}</div>
      <div class="text-xs text-slate-500">${email}</div>
      <div class="text-xs text-slate-500">Organization: ${organization}</div>
      <div class="text-xs text-slate-500">Status: ${status}</div>
      <div class="text-xs text-slate-500">Roles: ${roles}</div>
    </button>
    `;
  }).join('');
}

function renderRolesChips(user) {
  const roles = user && Array.isArray(user.roles) ? user.roles : [];
  if (!roles.length) {
    elSelectedRoles.innerHTML = '<span class="text-xs text-slate-500">No roles assigned.</span>';
    return;
  }
  elSelectedRoles.innerHTML = roles.map(role => `
    <span class="inline-flex items-center px-2 py-1 rounded-full border text-xs capitalize">${escapeHtml(role)}</span>
  `).join('');
}

function setLifecycleButtons(status) {
  const normalized = (status || '').toLowerCase();
  const allowDeactivate = normalized ? ['active', 'pending'].includes(normalized) : true;
  const allowReactivate = normalized ? normalized === 'suspended' : true;
  const allowArchive = normalized ? normalized === 'suspended' : true;

  btnDeactivate.disabled = !allowDeactivate;
  btnReactivate.disabled = !allowReactivate;
  btnArchive.disabled = !allowArchive;

  [btnDeactivate, btnReactivate, btnArchive].forEach(btn => {
    btn.classList.toggle('opacity-50', btn.disabled);
    btn.classList.toggle('pointer-events-none', btn.disabled);
  });
}

function generateSecurePassword(length = 12) {
  const alphabet = 'ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz23456789!@$%&*?';
  const size = Math.max(8, length);
  if (window.crypto && typeof window.crypto.getRandomValues === 'function') {
    const buffer = new Uint32Array(size);
    window.crypto.getRandomValues(buffer);
    return Array.from(buffer, value => alphabet[value % alphabet.length]).join('');
  }
  let password = '';
  for (let i = 0; i < size; i += 1) {
    const index = Math.floor(Math.random() * alphabet.length);
    password += alphabet[index];
  }
  return password;
}

function assignGeneratedPassword(input) {
  if (!input) return;
  const value = generateSecurePassword();
  input.value = value;
  if (typeof input.focus === 'function') input.focus();
  if (typeof input.select === 'function') {
    try {
      input.select();
    } catch (_err) {
      /* ignore */
    }
  }
}

async function extractErrorMessage(response, fallback) {
  if (!response) return fallback;
  const contentType = response.headers?.get ? response.headers.get('content-type') || '' : '';
  if (contentType.includes('application/json')) {
    try {
      const data = await response.json();
      const message = typeof data?.message === 'string' ? data.message.trim() : '';
      const error = typeof data?.error === 'string' ? data.error.trim() : '';
      if (message) return message;
      if (error) return error;
    } catch (_err) {
      // fall through to text parsing
    }
  }
  try {
    const text = await response.text();
    if (text && text.trim()) {
      return text.trim();
    }
  } catch (_err) {
    // ignore
  }
  return fallback;
}

function updateAccessDrawerContext(user) {
  const hasUser = Boolean(user && user.id);
  const displayName = hasUser ? (user.full_name || user.username || 'this user') : 'this user';
  if (accessProvisionName) accessProvisionName.textContent = displayName;
  if (accessResetName) accessResetName.textContent = displayName;

  if (provisionUsernameInput) {
    provisionUsernameInput.disabled = !hasUser;
    provisionUsernameInput.value = hasUser ? (user.username || user.email || '') : '';
  }
  if (provisionPasswordInput) {
    provisionPasswordInput.disabled = !hasUser;
    if (!hasUser) provisionPasswordInput.value = '';
  }
  if (btnGenerateProvisionPassword) {
    btnGenerateProvisionPassword.disabled = !hasUser;
  }
  if (formAccessProvision) {
    const submit = formAccessProvision.querySelector('button[type="submit"]');
    if (submit) {
      submit.disabled = !hasUser;
      submit.classList.toggle('opacity-50', !hasUser);
      submit.classList.toggle('pointer-events-none', !hasUser);
    }
  }

  if (resetPasswordInput) {
    resetPasswordInput.disabled = !hasUser;
    if (!hasUser) resetPasswordInput.value = '';
  }
  if (btnGenerateResetPassword) {
    btnGenerateResetPassword.disabled = !hasUser;
  }
  if (formAccessReset) {
    const submit = formAccessReset.querySelector('button[type="submit"]');
    if (submit) {
      submit.disabled = !hasUser;
      submit.classList.toggle('opacity-50', !hasUser);
      submit.classList.toggle('pointer-events-none', !hasUser);
    }
  }
}

function resetAccessDrawerForms() {
  if (formAccessProvision) formAccessProvision.reset();
  if (formAccessReset) formAccessReset.reset();
  if (formAccessCreate) formAccessCreate.reset();
  if (provisionPasswordInput) provisionPasswordInput.value = '';
  if (resetPasswordInput) resetPasswordInput.value = '';
  if (createPasswordInput) createPasswordInput.value = '';
  clearStatusText(accessProvisionMsg);
  clearStatusText(accessResetMsg);
  clearStatusText(accessCreateMsg);
}

function renderSelectedUser(user) {
  const previousUser = selectedUser;
  const previousUserId = previousUser ? previousUser.id : null;
  if (user && previousUser && user.id && previousUser.id === user.id) {
    user = { ...previousUser, ...user };
  }
  if (!user) {
    selectedUser = null;
    elSelectedSummary.textContent = '—';
    elSelectedName.textContent = 'Select a user';
    elSelectedUsername.textContent = 'Search or choose a user to view their details.';
    if (elSelectedOrganization) elSelectedOrganization.textContent = 'Organization: —';
    elSelectedStatus.textContent = '';
    elSelectedStatus.classList.add('hidden');
    elSelectedRoles.innerHTML = '<span class="text-xs text-slate-500">Roles will appear once a user is selected.</span>';
    actionHint.textContent = 'Select a user to enable profile actions.';
    if (loadCalendarStatus) {
      loadCalendarStatus.textContent = '';
      loadCalendarStatus.classList.remove('text-emerald-600', 'text-rose-600');
      loadCalendarStatus.classList.add('text-slate-500');
    }
    if (removeProgramsStatus) {
      removeProgramsStatus.textContent = '';
      removeProgramsStatus.classList.remove('text-emerald-600', 'text-rose-600');
      removeProgramsStatus.classList.add('text-slate-500');
    }
    if (removeProgramsDrawerMsg) {
      setStatusText(removeProgramsDrawerMsg, '', 'neutral');
    }
    if (removeProgramsUserName) {
      removeProgramsUserName.textContent = 'this user';
    }
    renderRemoveProgramsDrawer(null);
    setUserActionState(false);
    setLifecycleButtons('');
    if (inputEditFullName) inputEditFullName.value = '';
    if (inputEditLastName) inputEditLastName.value = '';
    if (inputEditFirstName) inputEditFirstName.value = '';
    if (inputEditSurname) inputEditSurname.value = '';
    if (inputEditSubUnit) ensureSelectValue(inputEditSubUnit, '');
    if (inputEditDepartment) ensureSelectValue(inputEditDepartment, '');
    if (inputEditDisciplineType) ensureSelectValue(inputEditDisciplineType, '');
    if (inputEditOrganization) ensureSelectValue(inputEditOrganization, '');
    if (inputEditEmail) inputEditEmail.value = '';
    updateAccessDrawerContext(null);
    return;
  }

  selectedUser = user;
  const displayName = user.full_name || user.username || '—';
  const email = user.email || user.username || '—';
  elSelectedSummary.textContent = email;
  elSelectedName.textContent = displayName;
  const emailDisplay = user.email || user.username || '—';
  elSelectedUsername.textContent = emailDisplay;
  const organization = (user.organization || '').trim();
  if (elSelectedOrganization) {
    elSelectedOrganization.textContent = `Organization: ${organization || '—'}`;
  }
  const status = user.status || '';
  if (status) {
    elSelectedStatus.textContent = status;
    elSelectedStatus.classList.remove('hidden');
  } else {
    elSelectedStatus.textContent = '';
    elSelectedStatus.classList.add('hidden');
  }
  renderRolesChips(user);
  actionHint.textContent = `Managing ${displayName}.`;
  rolesUserName.textContent = displayName;
  programsUserName.textContent = displayName;
  if (removeProgramsUserName) {
    removeProgramsUserName.textContent = displayName;
  }
  lifecycleUserName.textContent = displayName;
  updateAccessDrawerContext(user);
  if (inputEditFullName) inputEditFullName.value = user.full_name || '';
  if (inputEditLastName) inputEditLastName.value = user.last_name || '';
  if (inputEditFirstName) inputEditFirstName.value = user.first_name || '';
  if (inputEditSurname) inputEditSurname.value = user.surname || '';
  if (inputEditSubUnit) ensureSelectValue(inputEditSubUnit, user.sub_unit ?? '');
  if (inputEditDepartment) ensureSelectValue(inputEditDepartment, user.department ?? '');
  if (inputEditDisciplineType) ensureSelectValue(inputEditDisciplineType, user.discipline_type ?? '');
  if (inputEditOrganization) ensureSelectValue(inputEditOrganization, user.organization ?? '');

  if (inputEditEmail) inputEditEmail.value = user.email || user.username || '';

  if (loadCalendarStatus) {
    loadCalendarStatus.textContent = '';
    loadCalendarStatus.classList.remove('text-emerald-600', 'text-rose-600');
    loadCalendarStatus.classList.add('text-slate-500');
  }
  if (removeProgramsStatus && previousUserId !== user.id) {
    removeProgramsStatus.textContent = '';
    removeProgramsStatus.classList.remove('text-emerald-600', 'text-rose-600');
    removeProgramsStatus.classList.add('text-slate-500');
  }
  if (removeProgramsDrawerMsg && previousUserId !== user.id) {
    setStatusText(removeProgramsDrawerMsg, '', 'neutral');
  }
  renderRemoveProgramsDrawer(user);
  setUserActionState(true);
  setLifecycleButtons(status);
}

function openDrawer(id) {
  const el = document.getElementById(id);
  if (!el) return;
  el.classList.remove('hidden');
  const focusTarget = el.querySelector('[data-autofocus]') || el.querySelector('input, textarea, select, button');
  if (focusTarget) focusTarget.focus();
}
function closeDrawer(id) {
  const el = document.getElementById(id);
  if (!el) return;
  el.classList.add('hidden');
}
function closeAllDrawers() {
  document.querySelectorAll('[data-drawer]').forEach(el => el.classList.add('hidden'));
}

document.querySelectorAll('[data-drawer-close]').forEach(btn => {
  btn.addEventListener('click', () => {
    const drawer = btn.closest('[data-drawer]');
    if (drawer) drawer.classList.add('hidden');
  });
});
document.querySelectorAll('[data-drawer-panel]').forEach(panel => {
  panel.addEventListener('click', e => e.stopPropagation());
});
document.querySelectorAll('[data-drawer]').forEach(drawer => {
  drawer.addEventListener('click', () => drawer.classList.add('hidden'));
});

document.addEventListener('keydown', e => {
  if (e.key === 'Escape') closeAllDrawers();
});

elQ.addEventListener('input', e => renderUsers(e.target.value || ''));
elUserList.addEventListener('click', e => {
  const btn = e.target.closest('button[data-id]');
  if (!btn) return;
  const id = btn.getAttribute('data-id');
  const found = USERS.find(u => u.id === id);
  renderSelectedUser(found || null);
  renderUsers(elQ.value || '');
});

elBtnReloadUsers.addEventListener('click', async () => {
  await reloadUsers();
});

if (elBtnExportUsers) {
  elBtnExportUsers.addEventListener('click', () => {
    const usersToExport = Array.isArray(USERS) ? USERS : [];
    downloadUsersCsv(usersToExport);
  });
}

if (elBtnImportUsers && elInputImportUsers) {
  elBtnImportUsers.addEventListener('click', () => {
    elInputImportUsers.click();
  });
}

if (elInputImportUsers) {
  elInputImportUsers.addEventListener('change', handleUserImportSelection);
}

btnOpenCreate.addEventListener('click', () => {
  formCreate.reset();
  createMsg.textContent = '';
  Array.from(inputCreateRoles ? inputCreateRoles.options : []).forEach(opt => (opt.selected = false));
  openDrawer('drawerCreate');
});

btnOpenEdit.addEventListener('click', () => {
  if (!selectedUser) return;
  editMsg.textContent = '';
  openDrawer('drawerEdit');
});

btnOpenRoles.addEventListener('click', () => {
  if (!selectedUser) return;
  rolesDrawerMsg.textContent = '';
  renderRolesDrawer(selectedUser);
  openDrawer('drawerRoles');
});

btnOpenPrograms.addEventListener('click', () => {
  if (!selectedUser) return;
  programsMsg.textContent = '';
  renderProgramDrawer();
  openDrawer('drawerPrograms');
});

btnRemovePrograms.addEventListener('click', event => {
  event.preventDefault();
  if (!selectedUser) return;
  if (removeProgramsDrawerMsg) {
    setStatusText(removeProgramsDrawerMsg, '', 'neutral');
  }
  if (removeProgramsStatus) {
    setStatusText(removeProgramsStatus, '', 'neutral');
  }
  renderRemoveProgramsDrawer(selectedUser);
  openDrawer('drawerRemovePrograms');
});

btnOpenLifecycle.addEventListener('click', () => {
  if (!selectedUser) return;
  lifecycleMsg.textContent = '';
  textareaDeactivateReason.value = '';
  openDrawer('drawerLifecycle');
});

if (btnOpenAccess) {
  if (!IS_ADMIN) {
    btnOpenAccess.disabled = true;
    btnOpenAccess.classList.add('opacity-50', 'cursor-not-allowed');
  }
  btnOpenAccess.addEventListener('click', () => {
    if (!IS_ADMIN) return;
    resetAccessDrawerForms();
    updateAccessDrawerContext(selectedUser);
    if (accessDrawerNotice) accessDrawerNotice.classList.add('hidden');
    openDrawer('drawerAccess');
  });
}

if (btnGenerateProvisionPassword && provisionPasswordInput) {
  btnGenerateProvisionPassword.addEventListener('click', () => assignGeneratedPassword(provisionPasswordInput));
}

if (btnGenerateResetPassword && resetPasswordInput) {
  btnGenerateResetPassword.addEventListener('click', () => assignGeneratedPassword(resetPasswordInput));
}

if (btnGenerateCreatePassword && createPasswordInput) {
  btnGenerateCreatePassword.addEventListener('click', () => assignGeneratedPassword(createPasswordInput));
}

if (btnLoadCalendar) {
  btnLoadCalendar.addEventListener('click', async () => {
    if (!selectedUser) return;
    if (loadCalendarStatus) {
      loadCalendarStatus.textContent = 'Loading calendar…';
      loadCalendarStatus.classList.remove('text-emerald-600', 'text-rose-600');
      loadCalendarStatus.classList.add('text-slate-500');
    }
    const trainee = {
      id: selectedUser.id,
      name: selectedUser.full_name || selectedUser.username || ''
    };
    try {
      persistSelectedTraineeSession(trainee);
      const res = await updatePreferredTrainee(selectedUser.id);
      if (!res.ok) {
        throw new Error('Failed to update preferences');
      }
      if (loadCalendarStatus) {
        loadCalendarStatus.textContent = 'Success! Redirecting…';
        loadCalendarStatus.classList.add('text-emerald-600');
        loadCalendarStatus.classList.remove('text-rose-600', 'text-slate-500');
      }
      setTimeout(() => {
        window.location.href = '/';
      }, 600);
    } catch (error) {
      console.error(error);
      if (loadCalendarStatus) {
        loadCalendarStatus.textContent = 'Failed to load calendar. Please try again or contact support if the issue continues.';
        loadCalendarStatus.classList.add('text-rose-600');
        loadCalendarStatus.classList.remove('text-emerald-600', 'text-slate-500');
      }
    }
  });
}
formCreate.addEventListener('submit', async e => {
  e.preventDefault();
  createMsg.textContent = '';
  const formData = new FormData(formCreate);
  const payload = {
    full_name: (formData.get('fullName') || '').toString().trim(),
    email: (formData.get('email') || '').toString().trim(),
    roles: formData.getAll('roles').map(String),
    sendInvite: formData.get('sendInvite') === 'on'
  };
  if (!payload.email) {
    createMsg.textContent = 'Email is required.';
    return;
  }
  createMsg.textContent = 'Sending invite…';
  try {
    const res = await createUser(payload);
    if (res.ok) {
      createMsg.textContent = 'Invitation sent.';
      formCreate.reset();
      await reloadUsers(false);
    } else if (res.status === 403) {
      createMsg.textContent = 'You do not have permission to invite users.';
    } else {
      const error = await res.text();
      createMsg.textContent = error || 'Failed to invite user.';
    }
  } catch (err) {
    console.error(err);
    createMsg.textContent = 'Failed to invite user.';
  }
});

if (formAccessProvision) {
  formAccessProvision.addEventListener('submit', async event => {
    event.preventDefault();
    clearStatusText(accessProvisionMsg);
    if (!IS_ADMIN) {
      setStatusText(accessProvisionMsg, 'Only admins can provision user access.', 'error');
      return;
    }
    if (!selectedUser || !selectedUser.id) {
      setStatusText(accessProvisionMsg, 'Select a user to provision access.', 'error');
      return;
    }
    const username = (provisionUsernameInput?.value || '').toString().trim();
    const password = (provisionPasswordInput?.value || '').toString().trim();
    if (!username) {
      setStatusText(accessProvisionMsg, 'Username is required.', 'error');
      return;
    }
    if (!password || password.length < 8) {
      setStatusText(accessProvisionMsg, 'Password must be at least 8 characters long.', 'error');
      return;
    }
    setStatusText(accessProvisionMsg, 'Saving credentials…', 'neutral');
    try {
      const res = await provisionUserAccess(selectedUser.id, { username, password });
      if (!res.ok) {
        const message = await extractErrorMessage(res, 'Unable to provision access.');
        setStatusText(accessProvisionMsg, message, 'error');
        return;
      }
      try {
        const data = await res.json();
        if (data && typeof data === 'object' && data.id) {
          const index = USERS.findIndex(user => user && user.id === data.id);
          if (index !== -1) {
            USERS[index] = { ...USERS[index], ...data };
            renderSelectedUser(USERS[index]);
          }
        }
      } catch (_err) {
        // ignore parse errors
      }
      if (provisionPasswordInput) {
        provisionPasswordInput.value = '';
      }
      setStatusText(accessProvisionMsg, 'Credentials saved. Share the password securely.', 'success');
      await reloadUsers();
    } catch (error) {
      console.error(error);
      setStatusText(accessProvisionMsg, 'Unable to provision access. Please try again.', 'error');
    }
  });
}

if (formAccessReset) {
  formAccessReset.addEventListener('submit', async event => {
    event.preventDefault();
    clearStatusText(accessResetMsg);
    if (!IS_ADMIN) {
      setStatusText(accessResetMsg, 'Only admins can reset passwords.', 'error');
      return;
    }
    if (!selectedUser || !selectedUser.id) {
      setStatusText(accessResetMsg, 'Select a user to reset their password.', 'error');
      return;
    }
    const password = (resetPasswordInput?.value || '').toString().trim();
    if (!password || password.length < 8) {
      setStatusText(accessResetMsg, 'Password must be at least 8 characters long.', 'error');
      return;
    }
    setStatusText(accessResetMsg, 'Resetting password…', 'neutral');
    try {
      const res = await resetUserPasswordRequest(selectedUser.id, { password });
      if (!res.ok) {
        const message = await extractErrorMessage(res, 'Unable to reset password.');
        setStatusText(accessResetMsg, message, 'error');
        return;
      }
      if (resetPasswordInput) {
        resetPasswordInput.value = '';
      }
      setStatusText(accessResetMsg, 'Password updated. Share the new password securely.', 'success');
    } catch (error) {
      console.error(error);
      setStatusText(accessResetMsg, 'Unable to reset password. Please try again.', 'error');
    }
  });
}

if (formAccessCreate) {
  formAccessCreate.addEventListener('submit', async event => {
    event.preventDefault();
    clearStatusText(accessCreateMsg);
    if (!IS_ADMIN) {
      setStatusText(accessCreateMsg, 'Only admins can create users.', 'error');
      return;
    }
    const fullName = (createFullNameInput?.value || '').toString().trim();
    const email = (createEmailInput?.value || '').toString().trim();
    const username = (createUsernameInput?.value || '').toString().trim();
    const password = (createPasswordInput?.value || '').toString().trim();
    if (!username) {
      setStatusText(accessCreateMsg, 'Username is required.', 'error');
      return;
    }
    if (!password || password.length < 8) {
      setStatusText(accessCreateMsg, 'Password must be at least 8 characters long.', 'error');
      return;
    }
    setStatusText(accessCreateMsg, 'Creating user…', 'neutral');
    try {
      const res = await createLocalUserAccess({ full_name: fullName, email, username, password });
      if (!res.ok) {
        const message = await extractErrorMessage(res, 'Unable to create user.');
        setStatusText(accessCreateMsg, message, 'error');
        return;
      }
      let createdId = null;
      try {
        const data = await res.json();
        if (data && typeof data === 'object') {
          createdId = data.id || data.user_id || null;
        }
      } catch (_err) {
        // ignore parse errors
      }
      if (formAccessCreate) formAccessCreate.reset();
      if (createPasswordInput) createPasswordInput.value = '';
      setStatusText(accessCreateMsg, 'User created. Share credentials securely.', 'success');
      await reloadUsers(false);
      if (createdId) {
        const created = USERS.find(user => user && user.id === createdId);
        if (created) {
          renderSelectedUser(created);
        }
      }
    } catch (error) {
      console.error(error);
      setStatusText(accessCreateMsg, 'Unable to create user. Please try again.', 'error');
    }
  });
}

formEdit.addEventListener('submit', async e => {
  e.preventDefault();
  if (!selectedUser) return;
  editMsg.textContent = '';
  const formData = new FormData(formEdit);
  const getNullableField = name => {
    const value = (formData.get(name) || '').toString().trim();
    return value ? value : null;
  };
  const payload = {
    full_name: (formData.get('fullName') || '').toString().trim(),
    email: (formData.get('email') || '').toString().trim(),
    organization: getNullableField('organization'),
    last_name: getNullableField('lastName'),
    first_name: getNullableField('firstName'),
    surname: getNullableField('surname'),
    sub_unit: getNullableField('subUnit'),
    department: getNullableField('department'),
    discipline_type: getNullableField('disciplineType')
  };
  if (!payload.email) {
    editMsg.textContent = 'Email is required.';
    return;
  }
  editMsg.textContent = 'Saving…';
  try {
    const res = await updateUserProfile(selectedUser.id, payload);
    if (res.ok) {
      let updatedUser = null;
      const contentType = res.headers.get('content-type') || '';
      if (contentType.includes('application/json')) {
        try {
          updatedUser = await res.json();
        } catch (parseError) {
          console.warn('Failed to parse update response', parseError);
        }
      }
      let baseUser = selectedUser ? { ...selectedUser } : null;
      if (!baseUser && updatedUser && updatedUser.id) {
        baseUser = { ...updatedUser };
      } else if (baseUser && updatedUser && updatedUser.id) {
        Object.assign(baseUser, updatedUser);
      }
      const mergedUser = mergeUserProfilePayload(baseUser, payload);
      if (mergedUser) {
        renderSelectedUser(mergedUser);
      } else if (updatedUser && updatedUser.id) {
        renderSelectedUser(updatedUser);
      }
      editMsg.textContent = 'Profile updated.';
      await reloadUsers(true);
    } else if (res.status === 403) {
      editMsg.textContent = 'You do not have permission to update this user.';
    } else {
      const error = await res.text();
      editMsg.textContent = error || 'Update failed.';
    }
  } catch (err) {
    console.error(err);
    editMsg.textContent = 'Update failed.';
  }
});

function renderRolesDrawer(user) {
  const roleKeys = ['admin', 'manager', 'viewer', 'trainee', 'auditor'];
  const has = new Set(user.roles || []);
  drawerRolesBox.innerHTML = roleKeys.map(role => {
    let disabled = '';
    if (!IS_ADMIN) {
      if (IS_MANAGER && ['viewer', 'trainee'].includes(role)) {
        disabled = '';
      } else {
        disabled = 'disabled';
      }
    }
    const checked = has.has(role) ? 'checked' : '';
    return `
      <label class="inline-flex items-center gap-2 border rounded-xl px-3 py-2 bg-slate-50">
        <input type="checkbox" name="roles" value="${role}" ${checked} ${disabled}>
        <span class="capitalize">${role}</span>
      </label>
    `;
  }).join('');
  if (IS_ADMIN) {
    rolesInfo.textContent = '';
  } else if (IS_MANAGER) {
    rolesInfo.textContent = 'Managers can only toggle viewer or trainee roles.';
  } else {
    rolesInfo.textContent = 'You can view assigned roles but not modify them.';
  }
}

formRoles.addEventListener('submit', async e => {
  e.preventDefault();
  if (!selectedUser) return;
  rolesDrawerMsg.textContent = '';
  if (!(IS_ADMIN || IS_MANAGER)) {
    rolesDrawerMsg.textContent = 'Only admins or managers can update roles.';
    return;
  }
  const formData = new FormData(formRoles);
  let roles = formData.getAll('roles').map(String);
  if (IS_MANAGER && !IS_ADMIN) {
    const allowed = ['viewer', 'trainee'];
    const original = new Set(selectedUser.roles || []);
    roles = Array.from(new Set([
      ...roles.filter(r => allowed.includes(r)),
      ...Array.from(original).filter(r => !allowed.includes(r))
    ]));
  }
  rolesDrawerMsg.textContent = 'Saving roles…';
  try {
    const res = await saveUserRoles(selectedUser.id, roles);
    if (res.ok) {
      rolesDrawerMsg.textContent = 'Roles updated.';
      await reloadUsers(true);
    } else if (res.status === 403) {
      rolesDrawerMsg.textContent = 'You do not have permission to update roles.';
    } else {
      rolesDrawerMsg.textContent = 'Failed to update roles.';
    }
  } catch (err) {
    console.error(err);
    rolesDrawerMsg.textContent = 'Failed to update roles.';
  }
});

function renderProgramDrawer() {
  if (!PROGRAMS.length) {
    drawerProgramList.innerHTML = '<div class="text-sm text-slate-500">No programs available.</div>';
    return;
  }
  drawerProgramList.innerHTML = PROGRAMS.map(program => `
    <label class="inline-flex items-center gap-2 border rounded-xl px-3 py-2 bg-slate-50">
      <input type="checkbox" name="programs" value="${escapeHtml(program.program_id ?? '')}">
      <span class="truncate" title="${escapeHtml(program.title || '')}">📘 ${escapeHtml(program.title || '')}</span>
    </label>
  `).join('');
}

function renderRemoveProgramsDrawer(user) {
  if (!drawerRemoveProgramList) return;
  const assignedPrograms = Array.isArray(user && user.assigned_programs)
    ? user.assigned_programs
    : [];
  const hiddenPrograms = user ? getHiddenProgramsForUser(user.id) : new Set();
  const items = assignedPrograms
    .map(program => {
      const programId = extractProgramId(program);
      if (!programId) return null;
      const title = program?.title
        ?? program?.program_title
        ?? program?.name
        ?? program?.program_name
        ?? program?.programTitle
        ?? '';
      const displayTitle = title ? String(title) : `Program ${programId}`;
      return {
        id: String(programId),
        title: String(displayTitle)
      };
    })
    .filter(Boolean);
  if (!items.length) {
    drawerRemoveProgramList.innerHTML = '<div class="text-sm text-slate-500">No programs assigned.</div>';
    return;
  }
  drawerRemoveProgramList.innerHTML = items.map(item => {
    const isHidden = hiddenPrograms.has(item.id);
    const badgeText = isHidden ? 'Inactive' : 'Active';
    const badgeClass = isHidden
      ? 'bg-rose-100 text-rose-600'
      : 'bg-emerald-100 text-emerald-600';
    const labelClass = isHidden
      ? 'bg-rose-50 border-rose-200'
      : 'bg-slate-50 border-slate-200';
    return `
      <label class="inline-flex items-center justify-between gap-2 border rounded-xl px-3 py-2 ${labelClass}" data-program-id="${escapeHtml(item.id)}" data-program-state="${isHidden ? 'inactive' : 'active'}">
        <span class="flex items-center gap-2 truncate">
          <input type="checkbox" name="programs" value="${escapeHtml(item.id)}" data-program-id="${escapeHtml(item.id)}" data-program-state="${isHidden ? 'inactive' : 'active'}">
          <span class="truncate" title="${escapeHtml(item.title)}">🗑️ ${escapeHtml(item.title)}</span>
        </span>
        <span class="text-[11px] font-semibold px-2 py-0.5 rounded-full ${badgeClass}" data-program-status>
          ${badgeText}
        </span>
      </label>
    `;
  }).join('');
}

formPrograms.addEventListener('submit', async e => {
  e.preventDefault();
  programsMsg.textContent = '';
  if (!selectedUser) return;
  const formData = new FormData(formPrograms);
  const chosen = formData.getAll('programs').map(String);
  if (!chosen.length) {
    programsMsg.textContent = 'Select at least one program.';
    return;
  }
  programsMsg.textContent = 'Assigning programs…';
  let ok = 0;
  let fail = 0;
  for (const pid of chosen) {
    try {
      const res = await preloadForUser(selectedUser.id, pid);
      if (res.ok) ok++; else fail++;
    } catch (err) {
      console.error(err);
      fail++;
    }
  }
  programsMsg.textContent = `Programs assigned — ${ok} succeeded, ${fail} failed.`;
});

if (formRemovePrograms) {
  formRemovePrograms.addEventListener('submit', async e => {
    e.preventDefault();
    if (!selectedUser) return;

    const submitter = e.submitter;
    const action = submitter && submitter.dataset ? submitter.dataset.action : 'delete';
    const checkedInputs = Array.from(formRemovePrograms.querySelectorAll('input[name="programs"]:checked'));
    const chosen = checkedInputs.map(input => String(input.value)).filter(Boolean);
    if (!chosen.length) {
      const message = action === 'delete'
        ? 'Select at least one program to remove.'
        : 'Select at least one program to update.';
      setStatusText(removeProgramsDrawerMsg, message, 'error');
      if (removeProgramsStatus) {
        setStatusText(removeProgramsStatus, message, 'error');
      }
      return;
    }

    if (action === 'deactivate' || action === 'activate') {
      const shouldHide = action === 'deactivate';
      const changed = checkedInputs.reduce((count, input) => {
        const currentState = input.dataset.programState === 'inactive';
        if (shouldHide && !currentState) {
          return count + 1;
        }
        if (!shouldHide && currentState) {
          return count + 1;
        }
        return count;
      }, 0);

      updateHiddenProgramsForUser(selectedUser.id, chosen, shouldHide);
      renderRemoveProgramsDrawer(selectedUser);

      const summary = changed
        ? `Programs ${shouldHide ? 'deactivated' : 'activated'} — ${changed} updated.`
        : `All selected programs are already ${shouldHide ? 'inactive' : 'active'}.`;
      const tone = changed ? 'success' : 'neutral';
      setStatusText(removeProgramsDrawerMsg, summary, tone);
      if (removeProgramsStatus) {
        setStatusText(removeProgramsStatus, summary, tone);
      }
      return;
    }

    const submitBtn = submitter instanceof HTMLButtonElement
      ? submitter
      : document.getElementById('btnConfirmRemovePrograms')
        || formRemovePrograms.querySelector('button[type="submit"]');
    const originalLabel = submitBtn ? submitBtn.textContent : '';
    if (submitBtn) {
      submitBtn.disabled = true;
      submitBtn.textContent = 'Removing…';
    }

    setStatusText(removeProgramsDrawerMsg, 'Removing programs…', 'neutral');
    if (removeProgramsStatus) {
      setStatusText(removeProgramsStatus, 'Removing programs…', 'neutral');
    }

    let ok = 0;
    let fail = 0;
    const removedIds = new Set();

    for (const pid of chosen) {
      const programId = String(pid);
      try {
        const res = await deleteProgramForUser(selectedUser.id, programId);
        if (res.ok) {
          ok++;
          removedIds.add(programId);
        } else {
          fail++;
        }
      } catch (err) {
        console.error(err);
        fail++;
      }
    }

    if (removedIds.size) {
      updateHiddenProgramsForUser(selectedUser.id, Array.from(removedIds), false);
    }

    if (selectedUser && removedIds.size) {
      const remaining = Array.isArray(selectedUser.assigned_programs)
        ? selectedUser.assigned_programs.filter(program => {
            const pid = extractProgramId(program);
            return !removedIds.has(pid);
          })
        : [];
      selectedUser.assigned_programs = remaining;
    }

    renderRemoveProgramsDrawer(selectedUser);

    const summary = `Programs removed — ${ok} succeeded, ${fail} failed.`;
    const tone = fail === 0 ? 'success' : 'error';
    setStatusText(removeProgramsDrawerMsg, summary, tone);
    if (removeProgramsStatus) {
      setStatusText(removeProgramsStatus, summary, tone);
    }

    try {
      await reloadUsers(true);
    } catch (err) {
      console.error(err);
      const errorMsg = summary + ' Unable to refresh users.';
      setStatusText(removeProgramsDrawerMsg, errorMsg, 'error');
      if (removeProgramsStatus) {
        setStatusText(removeProgramsStatus, errorMsg, 'error');
      }
    } finally {
      if (submitBtn) {
        submitBtn.disabled = false;
        submitBtn.textContent = originalLabel;
      }
    }
  });
}

formDeactivate.addEventListener('submit', async e => {
  e.preventDefault();
  lifecycleMsg.textContent = '';
  if (!selectedUser) return;
  const reason = textareaDeactivateReason.value.trim();
  lifecycleMsg.textContent = 'Deactivating…';
  try {
    const res = await deactivateUserRequest(selectedUser.id, reason);
    if (res.ok) {
      lifecycleMsg.textContent = 'User deactivated.';
      await reloadUsers(true);
    } else if (res.status === 403) {
      lifecycleMsg.textContent = 'You do not have permission to deactivate users.';
    } else {
      const error = await res.text();
      lifecycleMsg.textContent = error || 'Failed to deactivate user.';
    }
  } catch (err) {
    console.error(err);
    lifecycleMsg.textContent = 'Failed to deactivate user.';
  }
});

btnReactivate.addEventListener('click', async () => {
  lifecycleMsg.textContent = '';
  if (!selectedUser) return;
  lifecycleMsg.textContent = 'Reactivating…';
  try {
    const res = await reactivateUserRequest(selectedUser.id);
    if (res.ok) {
      lifecycleMsg.textContent = 'User reactivated.';
      await reloadUsers(true);
    } else if (res.status === 403) {
      lifecycleMsg.textContent = 'You do not have permission to reactivate users.';
    } else {
      const error = await res.text();
      lifecycleMsg.textContent = error || 'Failed to reactivate user.';
    }
  } catch (err) {
    console.error(err);
    lifecycleMsg.textContent = 'Failed to reactivate user.';
  }
});

btnArchive.addEventListener('click', async () => {
  lifecycleMsg.textContent = '';
  if (!selectedUser) return;
  lifecycleMsg.textContent = 'Archiving…';
  try {
    const res = await archiveUserRequest(selectedUser.id);
    if (res.ok) {
      lifecycleMsg.textContent = 'User archived.';
      await reloadUsers(true);
    } else if (res.status === 403) {
      lifecycleMsg.textContent = 'You do not have permission to archive users.';
    } else {
      const error = await res.text();
      lifecycleMsg.textContent = error || 'Failed to archive user.';
    }
  } catch (err) {
    console.error(err);
    lifecycleMsg.textContent = 'Failed to archive user.';
  }
});

async function reloadUsers(preserveSelection = true, params) {
  try {
    const currentId = preserveSelection && selectedUser ? selectedUser.id : null;
    USERS = await listUsers(params);
    if (currentId) {
      const refreshed = USERS.find(u => u.id === currentId);
      renderSelectedUser(refreshed || null);
    } else if (selectedUser) {
      const refreshed = USERS.find(u => u.id === selectedUser.id);
      renderSelectedUser(refreshed || null);
    } else {
      renderSelectedUser(null);
    }
    renderUsers(elQ.value || '');
  } catch (err) {
    console.error(err);
    elUserList.innerHTML = '<div class="p-4 text-sm text-red-500">Failed to load users.</div>';
  }
}

try {
  USERS = await listUsers();
} catch (err) {
  console.error(err);
}
try {
  PROGRAMS = await listPrograms();
} catch (err) {
  console.error(err);
}
renderSelectedUser(null);
renderUsers();
  </script>
</body>
</html>
