<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>ANX • User Manager</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { theme: { extend: { colors: { anx: { sky: '#0ea5e9' }}}}};
  </script>
<style>
    :root {
      color-scheme: light;
      --surface: #ffffff;
      --surface-alt: #f8fafc;
      --border: #e2e8f0;
      --ink: #0f172a;
      --ink-muted: #64748b;
      --brand-primary: #2563eb;
      --brand-accent: #7c3aed;
    }

    body {
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background-color: var(--surface-alt);
      color: var(--ink);
    }

    .panel {
      border-radius: 1rem;
      border: 1px solid var(--border);
      background-color: var(--surface);
      box-shadow: 0 10px 25px -12px rgba(15, 23, 42, 0.35);
    }

    .panel-section {
      border-radius: 0.75rem;
      border: 1px solid var(--border);
      background-color: var(--surface);
    }

    .label-text {
      display: block;
      font-size: 0.75rem;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--ink-muted);
    }

    .input {
      width: 100%;
      border-radius: 0.75rem;
      border: 1px solid var(--border);
      background-color: var(--surface);
      padding: 0.5rem 0.75rem;
      font-size: 0.875rem;
      color: var(--ink);
      transition: box-shadow 0.15s ease, border-color 0.15s ease;
    }

    .input:focus {
      outline: none;
      border-color: var(--brand-primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
    }

    .textarea {
      width: 100%;
      border-radius: 0.75rem;
      border: 1px solid var(--border);
      background-color: var(--surface);
      padding: 0.75rem;
      font-size: 0.875rem;
      color: var(--ink);
      transition: box-shadow 0.15s ease, border-color 0.15s ease;
      min-height: 6rem;
      resize: vertical;
    }

    .textarea:focus {
      outline: none;
      border-color: var(--brand-primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      border-radius: 0.75rem;
      border: 1px solid var(--border);
      background-color: var(--surface);
      padding: 0.5rem 0.85rem;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--ink);
      transition: background-color 0.15s ease, color 0.15s ease, border-color 0.15s ease;
      cursor: pointer;
    }

    .btn-primary {
      border-color: var(--brand-primary);
      background-color: var(--brand-primary);
      color: #fff;
    }

    .btn-primary:hover {
      border-color: var(--brand-accent);
      background-color: var(--brand-accent);
    }

    .btn-outline {
      border-color: var(--border);
      background-color: var(--surface);
      color: var(--ink);
    }

    .btn-outline:hover {
      background-color: var(--surface-alt);
    }

    .btn-ghost {
      border-color: transparent;
      background-color: transparent;
      color: var(--ink-muted);
    }

    .btn-ghost:hover {
      background-color: var(--surface-alt);
      color: var(--ink);
    }

    .btn:disabled {
      cursor: not-allowed;
      opacity: 0.55;
    }

    .btn-danger {
      border-color: #dc2626;
      background-color: #dc2626;
      color: #fff;
    }

    .btn-danger:hover {
      border-color: #b91c1c;
      background-color: #b91c1c;
    }

    .btn-danger-outline {
      border-color: #ef4444;
      background-color: var(--surface);
      color: #b91c1c;
    }

    .btn-danger-outline:hover {
      background-color: #fef2f2;
      color: #991b1b;
    }

    body.modal-open {
      overflow: hidden;
    }

    .modal-overlay {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 1.5rem;
      background-color: rgba(15, 23, 42, 0.5);
      z-index: 50;
    }

    .modal-overlay.is-open {
      display: flex;
    }

    .modal-overlay-confirm {
      z-index: 60;
    }

    .modal {
      width: 100%;
      max-width: 36rem;
      border-radius: 1rem;
      border: 1px solid var(--border);
      background-color: var(--surface);
      box-shadow: 0 32px 64px -24px rgba(15, 23, 42, 0.5);
      display: flex;
      flex-direction: column;
    }

    .modal-sm {
      max-width: 28rem;
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      padding: 1rem 1.25rem;
      border-bottom: 1px solid var(--border);
    }

    .modal-body {
      padding: 1.25rem;
      max-height: min(70vh, 600px);
      overflow-y: auto;
    }

    .modal-footer {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 0.75rem;
      padding: 1rem 1.25rem;
      border-top: 1px solid var(--border);
      flex-wrap: wrap;
    }

    .table {
      width: 100%;
      border-collapse: collapse;
      text-align: left;
    }

    .table th,
    .table td {
      padding: 0.75rem 1rem;
      border-bottom: 1px solid var(--border);
      font-size: 0.875rem;
    }

    .table tbody tr:hover {
      background-color: var(--surface-alt);
    }

    .badge {
      display: inline-flex;
      align-items: center;
      padding: 0.125rem 0.5rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .badge-published {
      background-color: rgba(34, 197, 94, 0.18);
      color: #15803d;
    }

    .badge-draft {
      background-color: rgba(59, 130, 246, 0.18);
      color: #1d4ed8;
    }

    .badge-deprecated {
      background-color: rgba(251, 191, 36, 0.24);
      color: #b45309;
    }

    .badge-archived {
      background-color: rgba(148, 163, 184, 0.25);
      color: #475569;
    }

    .empty-row td {
      text-align: center;
      padding: 2.5rem 1rem;
      color: var(--ink-muted);
      font-size: 0.875rem;
    }
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <div class="max-w-6xl mx-auto p-4 space-y-6">
    <header class="flex items-center justify-between gap-4 flex-wrap">
      <div>
        <h1 class="text-2xl font-bold">User Manager</h1>
        <p class="text-sm text-slate-500">Invite teammates, update their profiles, and control access.</p>
      </div>

      <div class="flex items-center gap-3 flex-wrap justify-end">
        <div class="flex flex-wrap gap-2">

          <a href="/admin/user-manager" class="btn btn-primary text-sm">Users</a>
          <a href="/admin/program-template-manager.html" class="btn btn-outline text-sm">Program Templates</a>
        </div>
        <a href="/" class="text-sm text-anx-sky underline">← Back to Orientation</a>
      </div>
    </header>

    <section class="bg-white border rounded-2xl p-4 space-y-4">
      <div class="flex flex-wrap gap-3 items-end">
        <div class="flex-1 min-w-[260px]">
          <label class="block text-sm mb-1" for="q">Search users</label>
          <input id="q" class="w-full border rounded-xl px-3 py-2 text-sm" placeholder="Search by name or email…">
        </div>
        <div class="min-w-[200px]">
          <label class="block text-sm mb-1">Selected user</label>
          <div id="selectedUserSummary" class="text-sm font-medium">—</div>
        </div>
        <div class="flex items-center gap-2">
          <button id="btnExportUsers" class="inline-flex items-center gap-2 px-3 py-2 rounded-xl border text-sm">Export CSV</button>
          <button id="btnReloadUsers" class="inline-flex items-center gap-2 px-3 py-2 rounded-xl border text-sm">Refresh</button>
        </div>
      </div>

      <div class="mt-4 grid md:grid-cols-2 gap-4">
        <div>
          <div id="userList" class="bg-slate-50 border rounded-xl max-h-[380px] overflow-auto text-sm"></div>
        </div>
        <div class="space-y-4">
          <div class="border rounded-xl p-4">
            <div class="flex items-start justify-between gap-3">
              <div>
                <div id="selectedName" class="text-lg font-semibold">Select a user</div>
                <div id="selectedUsername" class="text-sm text-slate-500">Search or choose a user to view their details.</div>
                <div id="selectedOrganization" class="text-sm text-slate-500">Organization: —</div>
              </div>
              <div id="selectedStatus" class="hidden text-xs uppercase tracking-wide bg-slate-100 text-slate-600 px-3 py-1 rounded-full"></div>
            </div>
            <div class="mt-4">
              <div class="text-xs font-semibold uppercase text-slate-500">Roles</div>
              <div id="selectedRoles" class="mt-2 flex flex-wrap gap-2 text-xs text-slate-600">
                <span class="text-slate-500">Roles will appear once a user is selected.</span>
              </div>
            </div>
          </div>

          <div class="border rounded-xl p-4">
            <div class="text-sm font-semibold mb-3">User actions</div>
            <div class="grid gap-2 sm:grid-cols-2">
              <button id="btnOpenCreate" class="inline-flex items-center justify-center px-3 py-2 rounded-xl border text-sm bg-anx-sky text-white">Create / Invite</button>
              <button id="btnOpenEdit" data-requires-user class="inline-flex items-center justify-center px-3 py-2 rounded-xl border text-sm">Edit name &amp; email</button>
              <button id="btnOpenRoles" data-requires-user class="inline-flex items-center justify-center px-3 py-2 rounded-xl border text-sm">Update roles</button>
              <button id="btnOpenPrograms" data-requires-user class="inline-flex items-center justify-center px-3 py-2 rounded-xl border text-sm">Assign programs</button>
              <button id="btnRemovePrograms" type="button" data-requires-user class="inline-flex items-center justify-center px-3 py-2 rounded-xl border text-sm">Remove programs</button>
              <button id="btnLoadCalendar" data-requires-user class="inline-flex items-center justify-center px-3 py-2 rounded-xl border text-sm">Load calendar</button>
              <button id="btnOpenLifecycle" data-requires-user class="inline-flex items-center justify-center px-3 py-2 rounded-xl border text-sm sm:col-span-2">Deactivate / Reactivate / Archive</button>
            </div>
            <p id="loadCalendarStatus" class="mt-3 text-sm text-slate-500"></p>
            <p id="removeProgramsStatus" class="mt-3 text-sm text-slate-500"></p>
            <p id="actionHint" class="mt-3 text-xs text-slate-500">Select a user to enable profile actions.</p>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- Drawers -->
  <div id="drawerCreate" data-drawer class="hidden fixed inset-0 z-40">
    <div class="absolute inset-0 bg-slate-900/40" data-drawer-close></div>
    <div class="absolute right-0 top-0 bottom-0 w-full max-w-md bg-white shadow-xl p-6 overflow-y-auto" data-drawer-panel>
      <div class="flex items-start justify-between gap-3">
        <div>
          <h2 class="text-lg font-semibold">Invite a new user</h2>
          <p class="text-sm text-slate-500 mt-1">Send an invitation email and assign starter roles.</p>
        </div>
        <button type="button" class="text-slate-500 hover:text-slate-900" data-drawer-close>&times;</button>
      </div>
      <form id="formCreate" class="mt-4 space-y-4">
        <div>
          <label class="block text-sm mb-1" for="createFullName">Full name</label>
          <input id="createFullName" name="fullName" class="w-full border rounded-xl px-3 py-2 text-sm" placeholder="ex: Jamie Ramirez" data-autofocus>
        </div>
        <div>
          <label class="block text-sm mb-1" for="createEmail">Email</label>
          <input id="createEmail" name="email" type="email" class="w-full border rounded-xl px-3 py-2 text-sm" placeholder="name@example.com" required>
        </div>
        <div>
          <label class="block text-sm mb-1" for="createRoles">Initial roles</label>
          <select id="createRoles" name="roles" multiple class="w-full border rounded-xl px-3 py-2 text-sm h-28">
            <option value="admin">admin</option>
            <option value="manager">manager</option>
            <option value="viewer">viewer</option>
            <option value="trainee">trainee</option>
            <option value="auditor">auditor</option>
          </select>
          <p class="text-xs text-slate-500 mt-1">Hold ⌘/Ctrl to select more than one role.</p>
        </div>
        <label class="inline-flex items-center gap-2 text-sm">
          <input id="createSendInvite" name="sendInvite" type="checkbox" class="rounded border-slate-300">
          <span>Send invitation email immediately</span>
        </label>
        <div class="flex justify-end gap-2">
          <button type="button" class="px-3 py-2 rounded-xl border text-sm" data-drawer-close>Cancel</button>
          <button type="submit" class="px-3 py-2 rounded-xl border text-sm bg-anx-sky text-white">Send invite</button>
        </div>
        <div id="createMsg" class="text-xs text-slate-500"></div>
      </form>
    </div>
  </div>

  <div id="drawerEdit" data-drawer class="hidden fixed inset-0 z-40">
    <div class="absolute inset-0 bg-slate-900/40" data-drawer-close></div>
    <div class="absolute right-0 top-0 bottom-0 w-full max-w-md bg-white shadow-xl p-6 overflow-y-auto" data-drawer-panel>
        <div class="flex items-start justify-between gap-3">
            <div>
                <h2 class="text-lg font-semibold">Edit user details</h2>
                <p class="text-sm text-slate-500 mt-1">Update the name or email address for the selected user.</p>
            </div>
            <button type="button" class="text-slate-500 hover:text-slate-900" data-drawer-close>&times;</button>
        </div>
        <form id="formEdit" class="mt-4 space-y-4">
            <div>
                <label class="block text-sm mb-1" for="editFullName">Full name</label>
                <input id="editFullName" name="fullName" class="input" placeholder="Full name">
            </div>
            <div class="grid grid-cols-1 gap-4 sm:grid-cols-3">
                <div>
                    <label class="block text-sm mb-1" for="editLastName">Last name</label>
                    <input id="editLastName" name="lastName" class="input" placeholder="Last name">
                </div>
                <div>
                    <label class="block text-sm mb-1" for="editFirstName">First name</label>
                    <input id="editFirstName" name="firstName" class="input" placeholder="First name">
                </div>
                <div>
                    <label class="block text-sm mb-1" for="editSurname">Surname</label>
                    <input id="editSurname" name="surname" class="input" placeholder="Surname">
                </div>
            </div>
            <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                <div>
                    <label class="block text-sm mb-1" for="editOrganization">Organization</label>
                    <select id="editOrganization" name="organization" class="input">
                        <option value="">None</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm mb-1" for="editSubUnit">Sub-unit</label>
                    <select id="editSubUnit" name="subUnit" class="input">
                        <option value="">None</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm mb-1" for="editDiscipline">Discipline</label>
                    <select id="editDiscipline" name="discipline" class="input">
                        <option value="">None</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm mb-1" for="editDepartment">Department</label>
                    <select id="editDepartment" name="department" class="input">
                        <option value="">None</option>
                    </select>
                </div>
                <div class="sm:col-span-2">
                    <label class="block text-sm mb-1" for="editDisciplineType">Discipline type</label>
                    <select id="editDisciplineType" name="disciplineType" class="input">
                        <option value="">None</option>
                    </select>
                </div>
            </div>
            <div>
                <label class="block text-sm mb-1" for="editEmail">Email</label>
                <input id="editEmail" name="email" type="email" class="input" placeholder="name@example.com" required>
            </div>
            <div class="flex justify-end gap-2">
                <button type="button" class="px-3 py-2 rounded-xl border text-sm" data-drawer-close>Cancel</button>
                <button type="submit" class="px-3 py-2 rounded-xl border text-sm bg-anx-sky text-white">Save changes</button>
            </div>
            <div id="editMsg" class="text-xs text-slate-500"></div>
        </form>
    </div>
</div>

  <div id="drawerRoles" data-drawer class="hidden fixed inset-0 z-40">
    <div class="absolute inset-0 bg-slate-900/40" data-drawer-close></div>
    <div class="absolute right-0 top-0 bottom-0 w-full max-w-md bg-white shadow-xl p-6 overflow-y-auto" data-drawer-panel>
      <div class="flex items-start justify-between gap-3">
        <div>
          <h2 class="text-lg font-semibold">Update roles</h2>
          <p class="text-sm text-slate-500 mt-1">Choose which roles apply to <span id="rolesUserName" class="font-medium text-slate-700">this user</span>.</p>
        </div>
        <button type="button" class="text-slate-500 hover:text-slate-900" data-drawer-close>&times;</button>
      </div>
      <form id="formRoles" class="mt-4 space-y-4">
        <div id="drawerRolesBox" class="flex flex-wrap gap-2 text-sm"></div>
        <p id="rolesInfo" class="text-xs text-slate-500"></p>
        <div class="flex justify-end gap-2">
          <button type="button" class="px-3 py-2 rounded-xl border text-sm" data-drawer-close>Cancel</button>
          <button type="submit" class="px-3 py-2 rounded-xl border text-sm bg-anx-sky text-white">Save roles</button>
        </div>
        <div id="rolesDrawerMsg" class="text-xs text-slate-500"></div>
      </form>
    </div>
  </div>

  <div id="drawerPrograms" data-drawer class="hidden fixed inset-0 z-40">
    <div class="absolute inset-0 bg-slate-900/40" data-drawer-close></div>
    <div class="absolute right-0 top-0 bottom-0 w-full max-w-md bg-white shadow-xl p-6 overflow-y-auto" data-drawer-panel>
      <div class="flex items-start justify-between gap-3">
        <div>
          <h2 class="text-lg font-semibold">Assign programs</h2>
          <p class="text-sm text-slate-500 mt-1">Preload orientation programs for <span id="programsUserName" class="font-medium text-slate-700">this user</span>.</p>
        </div>
        <button type="button" class="text-slate-500 hover:text-slate-900" data-drawer-close>&times;</button>
      </div>
      <form id="formPrograms" class="mt-4 space-y-4">
        <div id="drawerProgramList" class="grid grid-cols-1 sm:grid-cols-2 gap-2 text-sm"></div>
        <div class="flex justify-end gap-2">
          <button type="button" class="px-3 py-2 rounded-xl border text-sm" data-drawer-close>Cancel</button>
          <button type="submit" class="px-3 py-2 rounded-xl border text-sm bg-anx-sky text-white">Assign programs</button>
        </div>
        <div id="programsMsg" class="text-xs text-slate-500"></div>
      </form>
    </div>
  </div>

  <div id="drawerRemovePrograms" data-drawer class="hidden fixed inset-0 z-40">
    <div class="absolute inset-0 bg-slate-900/40" data-drawer-close></div>
    <div class="absolute right-0 top-0 bottom-0 w-full max-w-md bg-white shadow-xl p-6 overflow-y-auto" data-drawer-panel>
      <div class="flex items-start justify-between gap-3">
        <div>
          <h2 class="text-lg font-semibold">Remove programs</h2>
          <p class="text-sm text-slate-500 mt-1">Select the programs you want to remove from <span id="removeProgramsUserName" class="font-medium text-slate-700">this user</span>.</p>
        </div>
        <button type="button" class="text-slate-500 hover:text-slate-900" data-drawer-close>&times;</button>
      </div>
      <form id="formRemovePrograms" class="mt-4 space-y-4">
        <div id="drawerRemoveProgramList" class="grid grid-cols-1 sm:grid-cols-2 gap-2 text-sm"></div>
        <div class="flex justify-end gap-2">
          <button type="button" class="px-3 py-2 rounded-xl border text-sm" data-drawer-close>Cancel</button>
          <button id="btnConfirmRemovePrograms" type="submit" class="px-3 py-2 rounded-xl border text-sm bg-rose-500 text-white">Remove selected programs</button>
        </div>
        <div id="removeProgramsDrawerMsg" class="text-xs text-slate-500"></div>
      </form>
    </div>
  </div>

  <div id="drawerLifecycle" data-drawer class="hidden fixed inset-0 z-40">
    <div class="absolute inset-0 bg-slate-900/40" data-drawer-close></div>
    <div class="absolute right-0 top-0 bottom-0 w-full max-w-md bg-white shadow-xl p-6 overflow-y-auto" data-drawer-panel>
      <div class="flex items-start justify-between gap-3">
        <div>
          <h2 class="text-lg font-semibold">Manage user lifecycle</h2>
          <p class="text-sm text-slate-500 mt-1">Deactivate, reactivate, or archive <span id="lifecycleUserName" class="font-medium text-slate-700">this user</span>.</p>
        </div>
        <button type="button" class="text-slate-500 hover:text-slate-900" data-drawer-close>&times;</button>
      </div>
      <form id="formDeactivate" class="mt-4 space-y-3">
        <div>
          <label class="block text-sm mb-1" for="deactivateReason">Reason (optional)</label>
          <textarea id="deactivateReason" name="reason" rows="3" class="w-full border rounded-xl px-3 py-2 text-sm" placeholder="Share context for this change."></textarea>
        </div>
        <button id="btnDeactivate" type="submit" class="w-full inline-flex justify-center px-3 py-2 rounded-xl border text-sm">Deactivate user</button>
      </form>
      <div class="mt-4 grid gap-2">
        <button id="btnReactivate" class="px-3 py-2 rounded-xl border text-sm">Reactivate user</button>
        <button id="btnArchive" class="px-3 py-2 rounded-xl border text-sm">Archive user</button>
      </div>
      <div id="lifecycleMsg" class="text-xs text-slate-500 mt-3"></div>
    </div>
  </div>

  <script type="module">
import { ORGANIZATION_OPTIONS, SUB_UNIT_OPTIONS, DEPARTMENT_OPTIONS, DISCIPLINE_TYPE_OPTIONS } from '../../shared/field-options.js';

const API = window.location.origin;

const HTML_ESCAPES = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' };
function escapeHtml(value = '') {
  return String(value).replace(/[&<>"']/g, ch => HTML_ESCAPES[ch] || ch);
}

const CSV_BOM = '\uFEFF';

function normalizeCsvValue(value) {
  if (value === null || value === undefined) {
    return '';
  }
  if (value instanceof Date) {
    return value.toISOString();
  }
  if (Array.isArray(value)) {
    const parts = value
      .map(item => normalizeCsvValue(item))
      .filter(part => part !== '');
    return parts.join('; ');
  }
  if (typeof value === 'object') {
    if (typeof value.toISOString === 'function') {
      try {
        return value.toISOString();
      } catch (err) {
        // continue to other fallbacks
      }
    }
    if (typeof value.name === 'string' && value.name) {
      const id = value.id ?? value.identifier ?? value.slug ?? '';
      if (id && id !== value.name) {
        return `${value.name} (${id})`;
      }
      return value.name;
    }
    if (typeof value.title === 'string' && value.title) {
      const id = value.id ?? value.program_id ?? value.programId ?? '';
      if (id && id !== value.title) {
        return `${value.title} (${id})`;
      }
      return value.title;
    }
    try {
      return JSON.stringify(value);
    } catch (err) {
      return String(value);
    }
  }
  return String(value);
}

function escapeCsvCell(value) {
  const text = normalizeCsvValue(value).replace(/\r?\n/g, '\n');
  if (text === '') {
    return '';
  }
  if (/[",\n]/.test(text)) {
    return `"${text.replace(/"/g, '""')}"`;
  }
  return text;
}

const USER_FIELD_ALIASES = {
  google_id: ['googleId', 'googleID'],
  email: ['username'],
  full_name: ['fullName', 'name'],
  picture_url: ['pictureUrl'],
  created_at: ['createdAt'],
  updated_at: ['updatedAt'],
  username: ['email'],
  password_hash: ['passwordHash'],
  provider: ['authProvider'],
  last_login_at: ['lastLoginAt'],
  organization: ['organization_name', 'organizationName'],
  status: ['state'],
  discipline_type: ['disciplineType', 'discipline'],
  last_name: ['lastName'],
  surname: ['maiden_name', 'maidenName'],
  first_name: ['firstName'],
  department: ['department_name', 'departmentName'],
  sub_unit: ['subUnit'],
};

const USER_EXPORT_FIELDS = [
  'id',
  'google_id',
  'email',
  'full_name',
  'picture_url',
  'created_at',
  'updated_at',
  'username',
  'password_hash',
  'provider',
  'last_login_at',
  'organization',
  'status',
  'discipline_type',
  'last_name',
  'surname',
  'first_name',
  'department',
  'sub_unit',
];

function getUserCsvRawValue(user, key) {
  if (!user || typeof user !== 'object') {
    return '';
  }
  const aliases = USER_FIELD_ALIASES[key] || [];
  const keysToCheck = [key, ...aliases];
  for (const candidateKey of keysToCheck) {
    if (!Object.prototype.hasOwnProperty.call(user, candidateKey)) {
      continue;
    }
    const rawValue = user[candidateKey];
    if (rawValue === null || rawValue === undefined) {
      continue;
    }
    if (typeof rawValue === 'string' && rawValue.trim() === '') {
      continue;
    }
    if (Array.isArray(rawValue) && rawValue.length === 0) {
      continue;
    }
    return rawValue;
  }
  return '';
}

function buildUsersCsv(users) {
  const rows = [USER_EXPORT_FIELDS.map(escapeCsvCell).join(',')];
  if (Array.isArray(users)) {
    users.forEach(user => {
      const cells = USER_EXPORT_FIELDS.map(field => {
        const value = getUserCsvRawValue(user, field);
        return escapeCsvCell(value);
      });
      rows.push(cells.join(','));
    });
  }
  return `${CSV_BOM}${rows.join('\r\n')}`;
}

function downloadUsersCsv(users) {
  try {
    const csvText = buildUsersCsv(users);
    const blob = new Blob([csvText], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    const timestamp = new Date().toISOString().replace(/[\.:]/g, '-');
    link.download = `users-${timestamp}.csv`;
    document.body.appendChild(link);
    link.click();
    const cleanup = () => {
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    };
    if (typeof requestAnimationFrame === 'function') {
      requestAnimationFrame(cleanup);
    } else {
      setTimeout(cleanup, 0);
    }
  } catch (error) {
    console.error('Failed to export users', error);
  }
}

function populateSelectOptions(selectElement, options) {
  if (!(selectElement instanceof HTMLSelectElement) || !Array.isArray(options)) {
    return;
  }
  const existingValues = new Set(Array.from(selectElement.options, option => option.value));
  options.forEach(optionValue => {
    if (!optionValue || existingValues.has(optionValue)) {
      return;
    }
    const option = document.createElement('option');
    option.value = optionValue;
    option.textContent = optionValue;
    selectElement.appendChild(option);
    existingValues.add(optionValue);
  });
}

function setStatusText(element, message, tone = 'neutral') {
  if (!element) return;
  element.textContent = message;
  element.classList.remove('text-slate-500', 'text-emerald-600', 'text-rose-600');
  if (tone === 'success') {
    element.classList.add('text-emerald-600');
  } else if (tone === 'error') {
    element.classList.add('text-rose-600');
  } else {
    element.classList.add('text-slate-500');
  }
}

function extractProgramId(program) {
  if (!program) return '';
  const id = program.program_id ?? program.id ?? program.programId ?? program.programID ?? program.slug ?? '';
  return id != null ? String(id) : '';
}

function ensureSelectValue(selectElement, value) {
  if (!(selectElement instanceof HTMLSelectElement)) {
    return;
  }
  if (value === null || value === undefined || value === '') {
    selectElement.value = '';
    return;
  }
  const stringValue = String(value);
  const hasOption = Array.from(selectElement.options).some(option => option.value === stringValue);
  if (!hasOption) {
    const option = document.createElement('option');
    option.value = stringValue;
    option.textContent = stringValue;
    selectElement.appendChild(option);
  }
  selectElement.value = stringValue;
}

function createSearchParams(params) {
  if (!params) {
    return new URLSearchParams();
  }
  if (params instanceof URLSearchParams) {
    return new URLSearchParams(params);
  }
  if (typeof params === 'string') {
    return params.trim() ? new URLSearchParams(params) : new URLSearchParams();
  }
  const searchParams = new URLSearchParams();
  if (typeof params === 'object') {
    Object.entries(params).forEach(([key, rawValue]) => {
      if (rawValue === null || rawValue === undefined) return;
      if (Array.isArray(rawValue)) {
        rawValue.forEach(item => {
          if (item === null || item === undefined || item === '') return;
          searchParams.append(key, String(item));
        });
      } else if (rawValue !== '') {
        searchParams.append(key, String(rawValue));
      }
    });
  }
  return searchParams;
}

function isOrganizationFilterKey(key) {
  if (!key) return false;
  const normalized = String(key).trim().toLowerCase();
  return normalized === 'organization' || normalized === 'organization_id' || normalized === 'organizationid' || normalized === 'organization-id';
}

const meRes = await fetch(`${API}/me`, { credentials: 'include' });
if (!meRes.ok) {
  location.href = '/';
}
const me = await meRes.json();
const IS_ADMIN = (me.roles || []).includes('admin');
const IS_MANAGER = (me.roles || []).includes('manager');
const managerOrganizationId = me?.organization_id ?? me?.organizationId ?? me?.organization ?? null;
const HAS_MANAGER_ORG_SCOPE = Boolean(IS_MANAGER && !IS_ADMIN && managerOrganizationId);
const managerOrganizationQueryValue = HAS_MANAGER_ORG_SCOPE ? String(managerOrganizationId) : '';

function buildUserListUrl(params) {
  const searchParams = createSearchParams(params);
  const hasOrganizationFilter = Array.from(searchParams.keys()).some(isOrganizationFilterKey);
  if (HAS_MANAGER_ORG_SCOPE && managerOrganizationQueryValue && !hasOrganizationFilter) {
    searchParams.set('organization_id', managerOrganizationQueryValue);
  }
  const queryString = searchParams.toString();
  return `${API}/rbac/users${queryString ? `?${queryString}` : ''}`;
}

async function listUsers(params) {
  const url = buildUserListUrl(params);
  const r = await fetch(url, { credentials: 'include' });
  if (!r.ok) throw new Error('GET /rbac/users failed');
  return r.json();
}
async function listPrograms() {
  const r = await fetch(`${API}/programs`, { credentials: 'include' });
  if (!r.ok) throw new Error('GET /programs failed');
  return r.json();
}
async function saveUserRoles(userId, roles) {
  return fetch(`${API}/rbac/users/${userId}/roles`, {
    method: 'PATCH',
    credentials: 'include',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ roles })
  });
}
async function preloadForUser(userId, programId) {
  return fetch(`${API}/rbac/users/${userId}/programs/${encodeURIComponent(programId)}/instantiate`, {
    method: 'POST',
    credentials: 'include'
  });
}
async function deleteProgramForUser(userId, programId) {
  return fetch(`${API}/rbac/users/${userId}/programs/${encodeURIComponent(programId)}`, {
    method: 'DELETE',
    credentials: 'include'
  });
}
async function createUser(payload) {
  return fetch(`${API}/api/users`, {
    method: 'POST',
    credentials: 'include',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });
}
async function updateUserProfile(userId, payload) {
  return fetch(`${API}/api/users/${userId}`, {
    method: 'PATCH',
    credentials: 'include',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });
}
async function deactivateUserRequest(userId, reason) {
  return fetch(`${API}/api/users/${userId}/deactivate`, {
    method: 'POST',
    credentials: 'include',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ reason })
  });
}
async function reactivateUserRequest(userId) {
  return fetch(`${API}/api/users/${userId}/reactivate`, {
    method: 'POST',
    credentials: 'include'
  });
}
async function archiveUserRequest(userId) {
  return fetch(`${API}/api/users/${userId}/archive`, {
    method: 'POST',
    credentials: 'include'
  });
}

function persistSelectedTraineeSession(trainee) {
  try {
    if (!trainee || !trainee.id) {
      sessionStorage.removeItem('anx_selected_trainee');
      return;
    }
    const payload = {
      id: trainee.id,
      name: trainee.name || ''
    };
    sessionStorage.setItem('anx_selected_trainee', JSON.stringify(payload));
  } catch (error) {
    console.warn('Failed to persist trainee selection', error);
  }
}

async function updatePreferredTrainee(userId) {
  return fetch(`${API}/prefs`, {
    method: 'PATCH',
    credentials: 'include',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ trainee: userId })
  });
}

let USERS = [];
let PROGRAMS = [];
let selectedUser = null;

const elQ = document.getElementById('q');
const elUserList = document.getElementById('userList');
const elSelectedSummary = document.getElementById('selectedUserSummary');
const elSelectedName = document.getElementById('selectedName');
const elSelectedUsername = document.getElementById('selectedUsername');
const elSelectedOrganization = document.getElementById('selectedOrganization');
const elSelectedStatus = document.getElementById('selectedStatus');
const elSelectedRoles = document.getElementById('selectedRoles');
const elBtnReloadUsers = document.getElementById('btnReloadUsers');
const elBtnExportUsers = document.getElementById('btnExportUsers');
const actionHint = document.getElementById('actionHint');

const btnOpenCreate = document.getElementById('btnOpenCreate');
const btnOpenEdit = document.getElementById('btnOpenEdit');
const btnOpenRoles = document.getElementById('btnOpenRoles');
const btnOpenPrograms = document.getElementById('btnOpenPrograms');
const btnOpenLifecycle = document.getElementById('btnOpenLifecycle');
const userActionButtons = document.querySelectorAll('[data-requires-user]');

const formCreate = document.getElementById('formCreate');
const formEdit = document.getElementById('formEdit');
const formRoles = document.getElementById('formRoles');
const formPrograms = document.getElementById('formPrograms');
const formRemovePrograms = document.getElementById('formRemovePrograms');
const formDeactivate = document.getElementById('formDeactivate');

const createMsg = document.getElementById('createMsg');
const editMsg = document.getElementById('editMsg');
const rolesDrawerMsg = document.getElementById('rolesDrawerMsg');
const programsMsg = document.getElementById('programsMsg');
const removeProgramsDrawerMsg = document.getElementById('removeProgramsDrawerMsg');
const lifecycleMsg = document.getElementById('lifecycleMsg');
const btnLoadCalendar = document.getElementById('btnLoadCalendar');
const btnRemovePrograms = document.getElementById('btnRemovePrograms');
const loadCalendarStatus = document.getElementById('loadCalendarStatus');
const removeProgramsStatus = document.getElementById('removeProgramsStatus');

const rolesInfo = document.getElementById('rolesInfo');
const rolesUserName = document.getElementById('rolesUserName');
const programsUserName = document.getElementById('programsUserName');
const removeProgramsUserName = document.getElementById('removeProgramsUserName');
const lifecycleUserName = document.getElementById('lifecycleUserName');

const drawerRolesBox = document.getElementById('drawerRolesBox');
const drawerProgramList = document.getElementById('drawerProgramList');
const drawerRemoveProgramList = document.getElementById('drawerRemoveProgramList');

const inputEditFullName = document.getElementById('editFullName');
const inputEditLastName = document.getElementById('editLastName');
const inputEditFirstName = document.getElementById('editFirstName');
const inputEditSurname = document.getElementById('editSurname');
const inputEditSubUnit = document.getElementById('editSubUnit');
const inputEditDiscipline = document.getElementById('editDiscipline');
const inputEditDepartment = document.getElementById('editDepartment');
const inputEditDisciplineType = document.getElementById('editDisciplineType');
const inputEditOrganization = document.getElementById('editOrganization');
const inputEditEmail = document.getElementById('editEmail');
const inputCreateRoles = document.getElementById('createRoles');
const textareaDeactivateReason = document.getElementById('deactivateReason');

populateSelectOptions(inputEditOrganization, ORGANIZATION_OPTIONS);
populateSelectOptions(inputEditSubUnit, SUB_UNIT_OPTIONS);
populateSelectOptions(inputEditDiscipline, DISCIPLINE_TYPE_OPTIONS);
populateSelectOptions(inputEditDepartment, DEPARTMENT_OPTIONS);
populateSelectOptions(inputEditDisciplineType, DISCIPLINE_TYPE_OPTIONS);

const organizationFilterSelect = (() => {
  const selectors = [
    '[data-organization-filter]',
    '#organizationFilter',
    '#filterOrganization',
    'select[name="organizationFilter"]',
  ];
  for (const selector of selectors) {
    const candidate = document.querySelector(selector);
    if (candidate instanceof HTMLSelectElement && candidate !== inputEditOrganization) {
      return candidate;
    }
  }
  return null;
})();

if (organizationFilterSelect && HAS_MANAGER_ORG_SCOPE && managerOrganizationQueryValue) {
  ensureSelectValue(organizationFilterSelect, managerOrganizationQueryValue);
  organizationFilterSelect.disabled = true;
  organizationFilterSelect.classList.add('opacity-60', 'cursor-not-allowed');
}

const btnDeactivate = document.getElementById('btnDeactivate');
const btnReactivate = document.getElementById('btnReactivate');
const btnArchive = document.getElementById('btnArchive');

function setUserActionState(enabled) {
  userActionButtons.forEach(btn => {
    btn.disabled = !enabled;
    btn.classList.toggle('opacity-50', !enabled);
    btn.classList.toggle('pointer-events-none', !enabled);
  });
}
setUserActionState(false);

function mergeUserProfilePayload(baseUser, payload) {
  if (!baseUser || !payload) {
    return null;
  }
  const merged = { ...baseUser };
  if ('full_name' in payload) {
    merged.full_name = payload.full_name;
    merged.name = payload.full_name;
  }
  if ('email' in payload) {
    merged.email = payload.email;
    if (payload.email) {
      merged.username = payload.email;
    }
  }
  if ('organization' in payload) {
    merged.organization = payload.organization;
  }
  if ('last_name' in payload) {
    merged.last_name = payload.last_name;
  }
  if ('first_name' in payload) {
    merged.first_name = payload.first_name;
  }
  if ('surname' in payload) {
    merged.surname = payload.surname;
  }
  if ('sub_unit' in payload) {
    merged.sub_unit = payload.sub_unit;
  }
  if ('discipline' in payload) {
    merged.discipline = payload.discipline;
  }
  if ('department' in payload) {
    merged.department = payload.department;
  }
  if ('discipline_type' in payload) {
    merged.discipline_type = payload.discipline_type;
  }
  return merged;
}

function renderUsers(filter = '') {
  const f = filter.trim().toLowerCase();
  const rows = USERS
    .filter(u => {
      const fullName = (u.full_name || '').toLowerCase();
      const email = (u.email || u.username || '').toLowerCase();
      return fullName.includes(f) || email.includes(f);
    })
    .sort((a, b) => (a.full_name || '').localeCompare(b.full_name || ''));
  if (!rows.length) {
    elUserList.innerHTML = '<div class="p-4 text-sm text-slate-500">No users match your search.</div>';
    return;
  }
  elUserList.innerHTML = rows.map(u => {
    const active = selectedUser && selectedUser.id === u.id;
    const idAttr = escapeHtml(u.id || '');
    const displayName = escapeHtml(u.full_name || '—');
    const email = escapeHtml(u.email || u.username || '');
    const organization = escapeHtml(u.organization || '—');
    const status = escapeHtml(u.status || 'active');
    const roles = escapeHtml((u.roles || []).join(', ') || '—');
    const classes = active ? 'bg-white shadow-sm' : '';
    return `
    <button data-id="${idAttr}" class="w-full text-left px-3 py-2 border-b hover:bg-white ${classes}">
      <div class="font-medium">${displayName}</div>
      <div class="text-xs text-slate-500">${email}</div>
      <div class="text-xs text-slate-500">Organization: ${organization}</div>
      <div class="text-xs text-slate-500">Status: ${status}</div>
      <div class="text-xs text-slate-500">Roles: ${roles}</div>
    </button>
    `;
  }).join('');
}

function renderRolesChips(user) {
  const roles = user && Array.isArray(user.roles) ? user.roles : [];
  if (!roles.length) {
    elSelectedRoles.innerHTML = '<span class="text-xs text-slate-500">No roles assigned.</span>';
    return;
  }
  elSelectedRoles.innerHTML = roles.map(role => `
    <span class="inline-flex items-center px-2 py-1 rounded-full border text-xs capitalize">${escapeHtml(role)}</span>
  `).join('');
}

function setLifecycleButtons(status) {
  const normalized = (status || '').toLowerCase();
  const allowDeactivate = normalized ? ['active', 'pending'].includes(normalized) : true;
  const allowReactivate = normalized ? normalized === 'suspended' : true;
  const allowArchive = normalized ? normalized === 'suspended' : true;

  btnDeactivate.disabled = !allowDeactivate;
  btnReactivate.disabled = !allowReactivate;
  btnArchive.disabled = !allowArchive;

  [btnDeactivate, btnReactivate, btnArchive].forEach(btn => {
    btn.classList.toggle('opacity-50', btn.disabled);
    btn.classList.toggle('pointer-events-none', btn.disabled);
  });
}

function renderSelectedUser(user) {
  const previousUser = selectedUser;
  const previousUserId = previousUser ? previousUser.id : null;
  if (user && previousUser && user.id && previousUser.id === user.id) {
    user = { ...previousUser, ...user };
  }
  if (!user) {
    selectedUser = null;
    elSelectedSummary.textContent = '—';
    elSelectedName.textContent = 'Select a user';
    elSelectedUsername.textContent = 'Search or choose a user to view their details.';
    if (elSelectedOrganization) elSelectedOrganization.textContent = 'Organization: —';
    elSelectedStatus.textContent = '';
    elSelectedStatus.classList.add('hidden');
    elSelectedRoles.innerHTML = '<span class="text-xs text-slate-500">Roles will appear once a user is selected.</span>';
    actionHint.textContent = 'Select a user to enable profile actions.';
    if (loadCalendarStatus) {
      loadCalendarStatus.textContent = '';
      loadCalendarStatus.classList.remove('text-emerald-600', 'text-rose-600');
      loadCalendarStatus.classList.add('text-slate-500');
    }
    if (removeProgramsStatus) {
      removeProgramsStatus.textContent = '';
      removeProgramsStatus.classList.remove('text-emerald-600', 'text-rose-600');
      removeProgramsStatus.classList.add('text-slate-500');
    }
    if (removeProgramsDrawerMsg) {
      setStatusText(removeProgramsDrawerMsg, '', 'neutral');
    }
    if (removeProgramsUserName) {
      removeProgramsUserName.textContent = 'this user';
    }
    renderRemoveProgramsDrawer(null);
    setUserActionState(false);
    setLifecycleButtons('');
    if (inputEditFullName) inputEditFullName.value = '';
    if (inputEditLastName) inputEditLastName.value = '';
    if (inputEditFirstName) inputEditFirstName.value = '';
    if (inputEditSurname) inputEditSurname.value = '';
    if (inputEditSubUnit) ensureSelectValue(inputEditSubUnit, '');
    if (inputEditDiscipline) ensureSelectValue(inputEditDiscipline, '');
    if (inputEditDepartment) ensureSelectValue(inputEditDepartment, '');
    if (inputEditDisciplineType) ensureSelectValue(inputEditDisciplineType, '');
    if (inputEditOrganization) ensureSelectValue(inputEditOrganization, '');
    if (inputEditEmail) inputEditEmail.value = '';
    return;
  }

  selectedUser = user;
  const displayName = user.full_name || user.username || '—';
  const email = user.email || user.username || '—';
  elSelectedSummary.textContent = email;
  elSelectedName.textContent = displayName;
  const emailDisplay = user.email || user.username || '—';
  elSelectedUsername.textContent = emailDisplay;
  const organization = (user.organization || '').trim();
  if (elSelectedOrganization) {
    elSelectedOrganization.textContent = `Organization: ${organization || '—'}`;
  }
  const status = user.status || '';
  if (status) {
    elSelectedStatus.textContent = status;
    elSelectedStatus.classList.remove('hidden');
  } else {
    elSelectedStatus.textContent = '';
    elSelectedStatus.classList.add('hidden');
  }
  renderRolesChips(user);
  actionHint.textContent = `Managing ${displayName}.`;
  rolesUserName.textContent = displayName;
  programsUserName.textContent = displayName;
  if (removeProgramsUserName) {
    removeProgramsUserName.textContent = displayName;
  }
  lifecycleUserName.textContent = displayName;
  if (inputEditFullName) inputEditFullName.value = user.full_name || '';
  if (inputEditLastName) inputEditLastName.value = user.last_name || '';
  if (inputEditFirstName) inputEditFirstName.value = user.first_name || '';
  if (inputEditSurname) inputEditSurname.value = user.surname || '';
  if (inputEditSubUnit) ensureSelectValue(inputEditSubUnit, user.sub_unit ?? '');
  if (inputEditDiscipline) ensureSelectValue(inputEditDiscipline, user.discipline ?? '');
  if (inputEditDepartment) ensureSelectValue(inputEditDepartment, user.department ?? '');
  if (inputEditDisciplineType) ensureSelectValue(inputEditDisciplineType, user.discipline_type ?? '');
  if (inputEditOrganization) ensureSelectValue(inputEditOrganization, user.organization ?? '');

  if (inputEditEmail) inputEditEmail.value = user.email || user.username || '';

  if (loadCalendarStatus) {
    loadCalendarStatus.textContent = '';
    loadCalendarStatus.classList.remove('text-emerald-600', 'text-rose-600');
    loadCalendarStatus.classList.add('text-slate-500');
  }
  if (removeProgramsStatus && previousUserId !== user.id) {
    removeProgramsStatus.textContent = '';
    removeProgramsStatus.classList.remove('text-emerald-600', 'text-rose-600');
    removeProgramsStatus.classList.add('text-slate-500');
  }
  if (removeProgramsDrawerMsg && previousUserId !== user.id) {
    setStatusText(removeProgramsDrawerMsg, '', 'neutral');
  }
  renderRemoveProgramsDrawer(user);
  setUserActionState(true);
  setLifecycleButtons(status);
}

function openDrawer(id) {
  const el = document.getElementById(id);
  if (!el) return;
  el.classList.remove('hidden');
  const focusTarget = el.querySelector('[data-autofocus]') || el.querySelector('input, textarea, select, button');
  if (focusTarget) focusTarget.focus();
}
function closeDrawer(id) {
  const el = document.getElementById(id);
  if (!el) return;
  el.classList.add('hidden');
}
function closeAllDrawers() {
  document.querySelectorAll('[data-drawer]').forEach(el => el.classList.add('hidden'));
}

document.querySelectorAll('[data-drawer-close]').forEach(btn => {
  btn.addEventListener('click', () => {
    const drawer = btn.closest('[data-drawer]');
    if (drawer) drawer.classList.add('hidden');
  });
});
document.querySelectorAll('[data-drawer-panel]').forEach(panel => {
  panel.addEventListener('click', e => e.stopPropagation());
});
document.querySelectorAll('[data-drawer]').forEach(drawer => {
  drawer.addEventListener('click', () => drawer.classList.add('hidden'));
});

document.addEventListener('keydown', e => {
  if (e.key === 'Escape') closeAllDrawers();
});

elQ.addEventListener('input', e => renderUsers(e.target.value || ''));
elUserList.addEventListener('click', e => {
  const btn = e.target.closest('button[data-id]');
  if (!btn) return;
  const id = btn.getAttribute('data-id');
  const found = USERS.find(u => u.id === id);
  renderSelectedUser(found || null);
  renderUsers(elQ.value || '');
});

elBtnReloadUsers.addEventListener('click', async () => {
  await reloadUsers();
});

if (elBtnExportUsers) {
  elBtnExportUsers.addEventListener('click', () => {
    const usersToExport = Array.isArray(USERS) ? USERS : [];
    downloadUsersCsv(usersToExport);
  });
}

btnOpenCreate.addEventListener('click', () => {
  formCreate.reset();
  createMsg.textContent = '';
  Array.from(inputCreateRoles ? inputCreateRoles.options : []).forEach(opt => (opt.selected = false));
  openDrawer('drawerCreate');
});

btnOpenEdit.addEventListener('click', () => {
  if (!selectedUser) return;
  editMsg.textContent = '';
  openDrawer('drawerEdit');
});

btnOpenRoles.addEventListener('click', () => {
  if (!selectedUser) return;
  rolesDrawerMsg.textContent = '';
  renderRolesDrawer(selectedUser);
  openDrawer('drawerRoles');
});

btnOpenPrograms.addEventListener('click', () => {
  if (!selectedUser) return;
  programsMsg.textContent = '';
  renderProgramDrawer();
  openDrawer('drawerPrograms');
});

btnRemovePrograms.addEventListener('click', event => {
  event.preventDefault();
  if (!selectedUser) return;
  if (removeProgramsDrawerMsg) {
    setStatusText(removeProgramsDrawerMsg, '', 'neutral');
  }
  if (removeProgramsStatus) {
    setStatusText(removeProgramsStatus, '', 'neutral');
  }
  renderRemoveProgramsDrawer(selectedUser);
  openDrawer('drawerRemovePrograms');
});

btnOpenLifecycle.addEventListener('click', () => {
  if (!selectedUser) return;
  lifecycleMsg.textContent = '';
  textareaDeactivateReason.value = '';
  openDrawer('drawerLifecycle');
});

if (btnLoadCalendar) {
  btnLoadCalendar.addEventListener('click', async () => {
    if (!selectedUser) return;
    if (loadCalendarStatus) {
      loadCalendarStatus.textContent = 'Loading calendar…';
      loadCalendarStatus.classList.remove('text-emerald-600', 'text-rose-600');
      loadCalendarStatus.classList.add('text-slate-500');
    }
    const trainee = {
      id: selectedUser.id,
      name: selectedUser.full_name || selectedUser.username || ''
    };
    try {
      persistSelectedTraineeSession(trainee);
      const res = await updatePreferredTrainee(selectedUser.id);
      if (!res.ok) {
        throw new Error('Failed to update preferences');
      }
      if (loadCalendarStatus) {
        loadCalendarStatus.textContent = 'Success! Redirecting…';
        loadCalendarStatus.classList.add('text-emerald-600');
        loadCalendarStatus.classList.remove('text-rose-600', 'text-slate-500');
      }
      setTimeout(() => {
        window.location.href = '/';
      }, 600);
    } catch (error) {
      console.error(error);
      if (loadCalendarStatus) {
        loadCalendarStatus.textContent = 'Failed to load calendar. Please try again or contact support if the issue continues.';
        loadCalendarStatus.classList.add('text-rose-600');
        loadCalendarStatus.classList.remove('text-emerald-600', 'text-slate-500');
      }
    }
  });
}
formCreate.addEventListener('submit', async e => {
  e.preventDefault();
  createMsg.textContent = '';
  const formData = new FormData(formCreate);
  const payload = {
    full_name: (formData.get('fullName') || '').toString().trim(),
    email: (formData.get('email') || '').toString().trim(),
    roles: formData.getAll('roles').map(String),
    sendInvite: formData.get('sendInvite') === 'on'
  };
  if (!payload.email) {
    createMsg.textContent = 'Email is required.';
    return;
  }
  createMsg.textContent = 'Sending invite…';
  try {
    const res = await createUser(payload);
    if (res.ok) {
      createMsg.textContent = 'Invitation sent.';
      formCreate.reset();
      await reloadUsers(false);
    } else if (res.status === 403) {
      createMsg.textContent = 'You do not have permission to invite users.';
    } else {
      const error = await res.text();
      createMsg.textContent = error || 'Failed to invite user.';
    }
  } catch (err) {
    console.error(err);
    createMsg.textContent = 'Failed to invite user.';
  }
});

formEdit.addEventListener('submit', async e => {
  e.preventDefault();
  if (!selectedUser) return;
  editMsg.textContent = '';
  const formData = new FormData(formEdit);
  const getNullableField = name => {
    const value = (formData.get(name) || '').toString().trim();
    return value ? value : null;
  };
  const payload = {
    full_name: (formData.get('fullName') || '').toString().trim(),
    email: (formData.get('email') || '').toString().trim(),
    organization: getNullableField('organization'),
    last_name: getNullableField('lastName'),
    first_name: getNullableField('firstName'),
    surname: getNullableField('surname'),
    sub_unit: getNullableField('subUnit'),
    discipline: getNullableField('discipline'),
    department: getNullableField('department'),
    discipline_type: getNullableField('disciplineType')
  };
  if (!payload.email) {
    editMsg.textContent = 'Email is required.';
    return;
  }
  editMsg.textContent = 'Saving…';
  try {
    const res = await updateUserProfile(selectedUser.id, payload);
    if (res.ok) {
      let updatedUser = null;
      const contentType = res.headers.get('content-type') || '';
      if (contentType.includes('application/json')) {
        try {
          updatedUser = await res.json();
        } catch (parseError) {
          console.warn('Failed to parse update response', parseError);
        }
      }
      let baseUser = selectedUser ? { ...selectedUser } : null;
      if (!baseUser && updatedUser && updatedUser.id) {
        baseUser = { ...updatedUser };
      } else if (baseUser && updatedUser && updatedUser.id) {
        Object.assign(baseUser, updatedUser);
      }
      const mergedUser = mergeUserProfilePayload(baseUser, payload);
      if (mergedUser) {
        renderSelectedUser(mergedUser);
      } else if (updatedUser && updatedUser.id) {
        renderSelectedUser(updatedUser);
      }
      editMsg.textContent = 'Profile updated.';
      await reloadUsers(true);
    } else if (res.status === 403) {
      editMsg.textContent = 'You do not have permission to update this user.';
    } else {
      const error = await res.text();
      editMsg.textContent = error || 'Update failed.';
    }
  } catch (err) {
    console.error(err);
    editMsg.textContent = 'Update failed.';
  }
});

function renderRolesDrawer(user) {
  const roleKeys = ['admin', 'manager', 'viewer', 'trainee', 'auditor'];
  const has = new Set(user.roles || []);
  drawerRolesBox.innerHTML = roleKeys.map(role => {
    let disabled = '';
    if (!IS_ADMIN) {
      if (IS_MANAGER && ['viewer', 'trainee'].includes(role)) {
        disabled = '';
      } else {
        disabled = 'disabled';
      }
    }
    const checked = has.has(role) ? 'checked' : '';
    return `
      <label class="inline-flex items-center gap-2 border rounded-xl px-3 py-2 bg-slate-50">
        <input type="checkbox" name="roles" value="${role}" ${checked} ${disabled}>
        <span class="capitalize">${role}</span>
      </label>
    `;
  }).join('');
  if (IS_ADMIN) {
    rolesInfo.textContent = '';
  } else if (IS_MANAGER) {
    rolesInfo.textContent = 'Managers can only toggle viewer or trainee roles.';
  } else {
    rolesInfo.textContent = 'You can view assigned roles but not modify them.';
  }
}

formRoles.addEventListener('submit', async e => {
  e.preventDefault();
  if (!selectedUser) return;
  rolesDrawerMsg.textContent = '';
  if (!(IS_ADMIN || IS_MANAGER)) {
    rolesDrawerMsg.textContent = 'Only admins or managers can update roles.';
    return;
  }
  const formData = new FormData(formRoles);
  let roles = formData.getAll('roles').map(String);
  if (IS_MANAGER && !IS_ADMIN) {
    const allowed = ['viewer', 'trainee'];
    const original = new Set(selectedUser.roles || []);
    roles = Array.from(new Set([
      ...roles.filter(r => allowed.includes(r)),
      ...Array.from(original).filter(r => !allowed.includes(r))
    ]));
  }
  rolesDrawerMsg.textContent = 'Saving roles…';
  try {
    const res = await saveUserRoles(selectedUser.id, roles);
    if (res.ok) {
      rolesDrawerMsg.textContent = 'Roles updated.';
      await reloadUsers(true);
    } else if (res.status === 403) {
      rolesDrawerMsg.textContent = 'You do not have permission to update roles.';
    } else {
      rolesDrawerMsg.textContent = 'Failed to update roles.';
    }
  } catch (err) {
    console.error(err);
    rolesDrawerMsg.textContent = 'Failed to update roles.';
  }
});

function renderProgramDrawer() {
  if (!PROGRAMS.length) {
    drawerProgramList.innerHTML = '<div class="text-sm text-slate-500">No programs available.</div>';
    return;
  }
  drawerProgramList.innerHTML = PROGRAMS.map(program => `
    <label class="inline-flex items-center gap-2 border rounded-xl px-3 py-2 bg-slate-50">
      <input type="checkbox" name="programs" value="${escapeHtml(program.program_id ?? '')}">
      <span class="truncate" title="${escapeHtml(program.title || '')}">📘 ${escapeHtml(program.title || '')}</span>
    </label>
  `).join('');
}

function renderRemoveProgramsDrawer(user) {
  if (!drawerRemoveProgramList) return;
  const assignedPrograms = Array.isArray(user && user.assigned_programs)
    ? user.assigned_programs
    : [];
  const items = assignedPrograms
    .map(program => {
      const programId = extractProgramId(program);
      if (!programId) return null;
      const title = program?.title
        ?? program?.program_title
        ?? program?.name
        ?? program?.program_name
        ?? program?.programTitle
        ?? '';
      const displayTitle = title ? String(title) : `Program ${programId}`;
      return {
        id: String(programId),
        title: String(displayTitle)
      };
    })
    .filter(Boolean);
  if (!items.length) {
    drawerRemoveProgramList.innerHTML = '<div class="text-sm text-slate-500">No programs assigned.</div>';
    return;
  }
  drawerRemoveProgramList.innerHTML = items.map(item => `
    <label class="inline-flex items-center gap-2 border rounded-xl px-3 py-2 bg-slate-50">
      <input type="checkbox" name="programs" value="${escapeHtml(item.id)}">
      <span class="truncate" title="${escapeHtml(item.title)}">🗑️ ${escapeHtml(item.title)}</span>
    </label>
  `).join('');
}

formPrograms.addEventListener('submit', async e => {
  e.preventDefault();
  programsMsg.textContent = '';
  if (!selectedUser) return;
  const formData = new FormData(formPrograms);
  const chosen = formData.getAll('programs').map(String);
  if (!chosen.length) {
    programsMsg.textContent = 'Select at least one program.';
    return;
  }
  programsMsg.textContent = 'Assigning programs…';
  let ok = 0;
  let fail = 0;
  for (const pid of chosen) {
    try {
      const res = await preloadForUser(selectedUser.id, pid);
      if (res.ok) ok++; else fail++;
    } catch (err) {
      console.error(err);
      fail++;
    }
  }
  programsMsg.textContent = `Programs assigned — ${ok} succeeded, ${fail} failed.`;
});

if (formRemovePrograms) {
  formRemovePrograms.addEventListener('submit', async e => {
    e.preventDefault();
    if (!selectedUser) return;
    const formData = new FormData(formRemovePrograms);
    const chosen = formData.getAll('programs').map(String).filter(Boolean);
    if (!chosen.length) {
      if (removeProgramsDrawerMsg) {
        setStatusText(removeProgramsDrawerMsg, 'Select at least one program to remove.', 'error');
      }
      return;
    }

    const submitBtn = document.getElementById('btnConfirmRemovePrograms')
      || formRemovePrograms.querySelector('button[type="submit"]');
    const originalLabel = submitBtn ? submitBtn.textContent : '';
    if (submitBtn) {
      submitBtn.disabled = true;
      submitBtn.textContent = 'Removing…';
    }

    setStatusText(removeProgramsDrawerMsg, 'Removing programs…', 'neutral');
    if (removeProgramsStatus) {
      setStatusText(removeProgramsStatus, 'Removing programs…', 'neutral');
    }

    let ok = 0;
    let fail = 0;
    const removedIds = new Set();

    for (const pid of chosen) {
      const programId = String(pid);
      try {
        const res = await deleteProgramForUser(selectedUser.id, programId);
        if (res.ok) {
          ok++;
          removedIds.add(programId);
        } else {
          fail++;
        }
      } catch (err) {
        console.error(err);
        fail++;
      }
    }

    if (selectedUser && removedIds.size) {
      const remaining = Array.isArray(selectedUser.assigned_programs)
        ? selectedUser.assigned_programs.filter(program => {
            const pid = extractProgramId(program);
            return !removedIds.has(pid);
          })
        : [];
      selectedUser.assigned_programs = remaining;
    }

    renderRemoveProgramsDrawer(selectedUser);

    const summary = `Programs removed — ${ok} succeeded, ${fail} failed.`;
    const tone = fail === 0 ? 'success' : 'error';
    setStatusText(removeProgramsDrawerMsg, summary, tone);
    if (removeProgramsStatus) {
      setStatusText(removeProgramsStatus, summary, tone);
    }

    try {
      await reloadUsers(true);
    } catch (err) {
      console.error(err);
      const errorMsg = summary + ' Unable to refresh users.';
      setStatusText(removeProgramsDrawerMsg, errorMsg, 'error');
      if (removeProgramsStatus) {
        setStatusText(removeProgramsStatus, errorMsg, 'error');
      }
    } finally {
      if (submitBtn) {
        submitBtn.disabled = false;
        submitBtn.textContent = originalLabel;
      }
    }
  });
}

formDeactivate.addEventListener('submit', async e => {
  e.preventDefault();
  lifecycleMsg.textContent = '';
  if (!selectedUser) return;
  const reason = textareaDeactivateReason.value.trim();
  lifecycleMsg.textContent = 'Deactivating…';
  try {
    const res = await deactivateUserRequest(selectedUser.id, reason);
    if (res.ok) {
      lifecycleMsg.textContent = 'User deactivated.';
      await reloadUsers(true);
    } else if (res.status === 403) {
      lifecycleMsg.textContent = 'You do not have permission to deactivate users.';
    } else {
      const error = await res.text();
      lifecycleMsg.textContent = error || 'Failed to deactivate user.';
    }
  } catch (err) {
    console.error(err);
    lifecycleMsg.textContent = 'Failed to deactivate user.';
  }
});

btnReactivate.addEventListener('click', async () => {
  lifecycleMsg.textContent = '';
  if (!selectedUser) return;
  lifecycleMsg.textContent = 'Reactivating…';
  try {
    const res = await reactivateUserRequest(selectedUser.id);
    if (res.ok) {
      lifecycleMsg.textContent = 'User reactivated.';
      await reloadUsers(true);
    } else if (res.status === 403) {
      lifecycleMsg.textContent = 'You do not have permission to reactivate users.';
    } else {
      const error = await res.text();
      lifecycleMsg.textContent = error || 'Failed to reactivate user.';
    }
  } catch (err) {
    console.error(err);
    lifecycleMsg.textContent = 'Failed to reactivate user.';
  }
});

btnArchive.addEventListener('click', async () => {
  lifecycleMsg.textContent = '';
  if (!selectedUser) return;
  lifecycleMsg.textContent = 'Archiving…';
  try {
    const res = await archiveUserRequest(selectedUser.id);
    if (res.ok) {
      lifecycleMsg.textContent = 'User archived.';
      await reloadUsers(true);
    } else if (res.status === 403) {
      lifecycleMsg.textContent = 'You do not have permission to archive users.';
    } else {
      const error = await res.text();
      lifecycleMsg.textContent = error || 'Failed to archive user.';
    }
  } catch (err) {
    console.error(err);
    lifecycleMsg.textContent = 'Failed to archive user.';
  }
});

async function reloadUsers(preserveSelection = true, params) {
  try {
    const currentId = preserveSelection && selectedUser ? selectedUser.id : null;
    USERS = await listUsers(params);
    if (currentId) {
      const refreshed = USERS.find(u => u.id === currentId);
      renderSelectedUser(refreshed || null);
    } else if (selectedUser) {
      const refreshed = USERS.find(u => u.id === selectedUser.id);
      renderSelectedUser(refreshed || null);
    } else {
      renderSelectedUser(null);
    }
    renderUsers(elQ.value || '');
  } catch (err) {
    console.error(err);
    elUserList.innerHTML = '<div class="p-4 text-sm text-red-500">Failed to load users.</div>';
  }
}

try {
  USERS = await listUsers();
} catch (err) {
  console.error(err);
}
try {
  PROGRAMS = await listPrograms();
} catch (err) {
  console.error(err);
}
renderSelectedUser(null);
renderUsers();
  </script>
</body>
</html>
