<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ANX • Orientation – Auth + Calendar</title>
  <!-- Tailwind (Play CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { theme: { extend: { colors: { anx: { sky: '#0ea5e9', mint:'#10b981', slate:'#1f2937' }}}}};
  </script>
  <!-- React UMD + Babel (web-only JSX) -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- Day.js -->
  <script src="https://unpkg.com/dayjs@1.11.11/dayjs.min.js"></script>
  <script src="https://unpkg.com/dayjs@1.11.11/plugin/isoWeek.js"></script>
  <style>
    .card{ @apply bg-white rounded-2xl shadow-sm border border-slate-100; }
    .btn{ @apply inline-flex items-center gap-2 px-3 py-2 rounded-xl border text-sm; }
    .btn-ghost{ @apply border-transparent hover:bg-slate-50; }
    .btn-outline{ @apply border-slate-300 hover:bg-slate-50; }
    .btn-primary{ @apply bg-anx-sky text-white border-anx-sky hover:brightness-95; }
    .tag{ @apply inline-flex items-center px-2 py-0.5 rounded-md text-[11px] border bg-slate-50 text-slate-700; }
    .input{ @apply w-full border rounded-xl px-3 py-2 text-sm; }
    .textarea{ @apply w-full border rounded-xl px-3 py-2 text-sm; }
    .outline-dashed{ outline-style: dashed; }

    button:focus,
    [tabindex]:focus,
    input:focus,
    textarea:focus,
    select:focus{
      @apply outline-none ring-2 ring-anx-sky;
    }

    /* Web Viewer safe modal */
    .fm-modal-overlay{
      position: fixed; inset: 0; background: rgba(0,0,0,.45);
      z-index: 2147483000; display:flex; align-items:center; justify-content:center;
      padding: 1rem; transform: translateZ(0); isolation: isolate; touch-action:none; overscroll-behavior: contain;
    }
    .fm-modal{
      position: relative; background:#fff; border-radius: 1rem; border:1px solid #e5e7eb;
      box-shadow: 0 12px 30px rgba(0,0,0,.24); width: 100%; max-width: 1200px; z-index: 2147483640;
    }
    .fm-modal-header{ display:flex; align-items:center; justify-content:space-between; padding:.75rem 1rem; border-bottom:1px solid #e5e7eb; }
    .fm-modal-body{ max-height: min(70vh, 720px); overflow:auto; padding: 1rem; }
    html, body { height: 100%; }
  </style>
</head>
<body class="min-h-screen bg-slate-50 text-slate-900">
<div id="root" class="max-w-7xl mx-auto px-4"></div>

<script type="text/babel" data-presets="env,react">
const { useEffect, useMemo, useState, useRef } = React;
const dayjsIso = dayjs.extend(window.dayjs_plugin_isoWeek);

/* Use same origin the page is served from */
const API = window.location.origin;
const qs = new URLSearchParams(location.search);
let QS_PROGRAM_ID = qs.get('program_id') || localStorage.getItem('anx_program_id') || null;
let CURRENT_USER_ID = null;
let TARGET_USER_ID = null;
let TARGET_USER_NAME = null;
const TRAINEE_PREF_KEY = 'anx_selected_trainee';

const sameId = (a, b) => String(a ?? '') === String(b ?? '');

function readStoredTrainee(){
  if (typeof sessionStorage === 'undefined') return null;
  try {
    const raw = sessionStorage.getItem(TRAINEE_PREF_KEY);
    if (!raw) return null;
    const parsed = JSON.parse(raw);
    if (!parsed || typeof parsed !== 'object' || !parsed.id) return null;
    return { id: String(parsed.id), name: parsed.name || '' };
  } catch (err) {
    return null;
  }
}

function writeStoredTrainee(id, name = ''){
  if (typeof sessionStorage === 'undefined') return;
  try {
    if (!id) {
      sessionStorage.removeItem(TRAINEE_PREF_KEY);
    } else {
      sessionStorage.setItem(TRAINEE_PREF_KEY, JSON.stringify({ id: String(id), name: name || '' }));
    }
  } catch (err) {
    // Ignore storage errors (e.g., private browsing)
  }
}

/* Helpers */
const fmt = (d) => dayjs(d).format('MMM D, YYYY');
const inRange = (d, start, numWeeks) => {
  const s = dayjs(start);
  const e = s.add((numWeeks*7)-1,'day');
  const x = dayjs(d);
  return x.isSame(s,'day') || (x.isAfter(s,'day') && x.isBefore(e,'day')) || x.isSame(e,'day');
};
const uid = () => Math.random().toString(36).slice(2);
const withUser = (url) => {
  if (TARGET_USER_ID && CURRENT_USER_ID && TARGET_USER_ID !== CURRENT_USER_ID) {
    const sep = url.includes('?') ? '&' : '?';
    return `${url}${sep}user_id=${encodeURIComponent(TARGET_USER_ID)}`;
  }
  return url;
};
const withUserBody = (data = {}) => (
  (TARGET_USER_ID && CURRENT_USER_ID && TARGET_USER_ID !== CURRENT_USER_ID)
    ? { ...data, user_id: TARGET_USER_ID }
    : data
);

function useFocusTrap(active, ref) {
  useEffect(() => {
    if (!active) return;
    const node = ref.current;
    if (!node) return;
    const selector =
      'a[href], button:not([disabled]), textarea, input, select, [tabindex]:not([tabindex="-1"])';
    const getFocusable = () => node.querySelectorAll(selector);
    const handleKey = (e) => {
      if (e.key !== 'Tab') return;
      const focusable = getFocusable();
      if (!focusable.length) return;
      const first = focusable[0];
      const last = focusable[focusable.length - 1];
      if (e.shiftKey) {
        if (document.activeElement === first) {
          e.preventDefault();
          last.focus();
        }
      } else {
        if (document.activeElement === last) {
          e.preventDefault();
          first.focus();
        }
      }
    };
    document.addEventListener('keydown', handleKey);
    const focusable = getFocusable();
    focusable[0] && focusable[0].focus();
    return () => document.removeEventListener('keydown', handleKey);
  }, [active, ref]);
}

function useLocalStorageState(key, initial) {
  const [value, setValue] = useState(() => {
    const stored = localStorage.getItem(key);
    return stored !== null ? JSON.parse(stored) : initial;
  });
  useEffect(() => {
    localStorage.setItem(key, JSON.stringify(value));
  }, [key, value]);
  return [value, setValue];
}

function useRafThrottle(fn) {
  const frame = useRef(null);
  return (...args) => {
    if (frame.current) return;
    frame.current = requestAnimationFrame(() => {
      fn(...args);
      frame.current = null;
    });
  };
}

/* ---- AUTH PANEL (Local + Google) ---- */
function AuthPanel({ onAuthed }){
  const [mode, setMode] = useState('login');
  const [u, setU] = useState('');
  const [p, setP] = useState('');
  const [name, setName] = useState('');
  const [email, setEmail] = useState('');
  const [err, setErr] = useState('');

  async function doLogin(e){
    e.preventDefault(); setErr('');
    const r = await fetch(`${API}/auth/local/login`, {
      method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include',
      body: JSON.stringify({ username: u.trim(), password: p })
    });
    if(!r.ok){ setErr('Login failed.'); return; }
    onAuthed();
  }
  async function doRegister(e){
    e.preventDefault(); setErr('');
    const r = await fetch(`${API}/auth/local/register`, {
      method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include',
      body: JSON.stringify({ username: u.trim(), password: p, full_name: name.trim(), email: email.trim() })
    });
    if(!r.ok){ setErr('Registration failed (username taken?).'); return; }
    onAuthed();
  }
  function doGoogle(){
    window.location.href = `${API}/auth/google`;
  }

  return (
    <div className="max-w-4xl mx-auto grid md:grid-cols-2 gap-8">
      <div className="card p-6">
        <h2 className="text-xl font-semibold mb-4">{mode === 'login' ? 'Sign in' : 'Create an account'}</h2>
        <p className="text-sm text-slate-500 mb-4">Use a local account as an alternate to Google SSO.</p>
        {mode === 'register' && (
          <>
            <div className="mb-4">
              <label htmlFor="fullName" className="text-sm block mb-1">Full name</label>
              <input id="fullName" className="input" value={name} onChange={e=>setName(e.target.value)} placeholder="Your name" />
            </div>
            <div className="mb-4">
              <label htmlFor="email" className="text-sm block mb-1">Email</label>
              <input id="email" className="input" value={email} onChange={e=>setEmail(e.target.value)} placeholder="you@anx.com" />
            </div>
          </>
        )}
        <div className="mb-4">
          <label htmlFor="username" className="text-sm block mb-1">Username</label>
          <input id="username" className="input" value={u} onChange={e=>setU(e.target.value)} placeholder="e.g., halle" />
        </div>
        <div className="mb-4">
          <label htmlFor="password" className="text-sm block mb-1">Password</label>
          <input id="password" className="input" type="password" value={p} onChange={e=>setP(e.target.value)} placeholder="••••••••" />
        </div>
              <div className="flex flex-col items-center space-y-2 mt-2">
  {mode === 'login' ? (
    <button className="btn btn-primary w-full" onClick={doLogin}>Sign in</button>
  ) : (
    <button className="btn btn-primary w-full" onClick={doRegister}>Create account</button>
  )}

  <div className="flex justify-between w-full text-sm text-center">
    <button
      className="btn btn-ghost flex-1"
      onClick={() => setMode(mode === 'login' ? 'register' : 'login')}
    >
      {mode === 'login'
        ? 'Need an account? Register'
        : 'Already have an account? Sign in'}
    </button>

    <a href="/reset.html" className="btn btn-ghost flex-1">
      Reset Password
    </a>
  </div>
</div>
        <div className="h-px bg-slate-200 my-4"></div>
        <button className="btn btn-outline w-full" onClick={doGoogle}>Continue with Google</button>
      </div>
      <div className="card p-6">
        <h3 className="text-lg font-semibold mb-4">Welcome to ANX Orientation</h3>
        <p className="text-sm text-slate-600 mb-4">
          Sign in to load your calendar, tasks, and preferences. Your session is stored securely and restores your last view.
        </p>
        <ul className="list-disc pl-5 text-sm text-slate-600 space-y-1">
          <li>Use <strong>local username/password</strong> or <strong>Google SSO</strong>.</li>
          <li>Your tasks are tied to your account and won’t mix with others.</li>
          <li>Safe for FileMaker Web Viewer (cookies: SameSite=Lax).</li>
        </ul>
      </div>
    </div>
  );
}

/* ---- API helpers with credentials ---- */
async function apiGetMe(){
  const r = await fetch(`${API}/me`, { credentials:'include' });
  if(!r.ok) return null;
  const u = await r.json();
  u.perms = new Set(u.perms || []);
  u.roles = u.roles || [];
  return u;
}
async function apiLogout(){
  const r = await fetch(`${API}/auth/logout`, { method:'POST', credentials:'include' });
  if(r.status === 403){ alert('You do not have permission to perform this action.'); return null; }
  if(!r.ok) throw new Error('POST /auth/logout failed');
  return true;
}

async function apiGetPrefs(){
  const r = await fetch(withUser(`${API}/prefs`), { credentials:'include' });
  if(!r.ok) return {};
  return r.json();
}
async function apiPatchPrefs(data, opts = {}){
  const { skipUser = false } = opts;
  const url = skipUser ? `${API}/prefs` : withUser(`${API}/prefs`);
  const bodyData = skipUser ? data : withUserBody(data);
  const r = await fetch(url, {
    method:'PATCH', credentials:'include',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(bodyData)
  });
  if(r.status === 403){ alert('You do not have permission to perform this action.'); return null; }
  if(!r.ok) throw new Error('PATCH /prefs failed');
  return r.json();
}

async function apiPatchMe(data){
  const r = await fetch(`${API}/me`, {
    method:'PATCH', credentials:'include',
    headers:{ 'Content-Type':'application/json' },
    body: JSON.stringify(data)
  });
  if(r.status === 403){ alert('You do not have permission to perform this action.'); return null; }
  if(!r.ok) throw new Error('PATCH /me failed');
  return r.json();
}

async function apiChangePassword(data){
  const r = await fetch(`${API}/auth/local/change-password`, {
    method:'POST', credentials:'include',
    headers:{ 'Content-Type':'application/json' },
    body: JSON.stringify(data)
  });
  if(r.status === 403){ alert('You do not have permission to perform this action.'); return null; }
  if(!r.ok) throw new Error('POST /auth/local/change-password failed');
  return r.json();
}

async function apiListUsers(){
  const r = await fetch(`${API}/rbac/users`, { credentials:'include' });
  if(!r.ok) throw new Error('GET /rbac/users failed');
  return r.json();
}

/* ---- Program & Template helpers ---- */
async function apiListPrograms(){
  const r = await fetch(`${API}/programs`, { credentials:'include' });
  if(!r.ok) throw new Error('GET /programs failed');
  return r.json();
}
async function apiCreateProgram(data){
  const r = await fetch(`${API}/programs`, {
    method:'POST', credentials:'include',
    headers:{ 'Content-Type':'application/json' },
    body: JSON.stringify(data)
  });
  if(r.status === 403){ alert('You do not have permission to perform this action.'); return null; }
  if(!r.ok) throw new Error('POST /programs failed');
  return r.json();
}
async function apiPatchProgram(programId, data){
  const r = await fetch(`${API}/programs/${encodeURIComponent(programId)}`, {
    method:'PATCH', credentials:'include',
    headers:{ 'Content-Type':'application/json' },
    body: JSON.stringify(data)
  });
  if(r.status === 404) return null;
  if(r.status === 403){ alert('You do not have permission to perform this action.'); return null; }
  if(!r.ok) throw new Error(`PATCH /programs/${programId} failed (${r.status})`);
  return r.json();
}
async function apiDeleteProgram(programId){
  const r = await fetch(`${API}/programs/${encodeURIComponent(programId)}`, {
    method:'DELETE', credentials:'include'
  });
  if(r.status === 404) return null;
  if(r.status === 403){ alert('You do not have permission to perform this action.'); return null; }
  if(!r.ok) throw new Error(`DELETE /programs/${programId} failed (${r.status})`);
  return r.json();
}
async function apiListTemplates(programId){
  const r = await fetch(`${API}/programs/${encodeURIComponent(programId)}/templates`, { credentials:'include' });
  if(!r.ok) throw new Error('GET /programs/:id/templates failed');
  return r.json();
}
async function apiCreateTemplate(programId, data){
  const r = await fetch(`${API}/programs/${encodeURIComponent(programId)}/templates`, {
    method:'POST', credentials:'include',
    headers:{ 'Content-Type':'application/json' },
    body: JSON.stringify(data)
  });
  if(r.status === 403){ alert('You do not have permission to perform this action.'); return null; }
  if(!r.ok) throw new Error('POST /programs/:id/templates failed');
  return r.json();
}
async function apiPatchTemplate(programId, templateId, data){
  const r = await fetch(`${API}/programs/${encodeURIComponent(programId)}/templates/${encodeURIComponent(templateId)}`, {
    method:'PATCH', credentials:'include',
    headers:{ 'Content-Type':'application/json' },
    body: JSON.stringify(data)
  });
  if(r.status === 404) return null;
  if(r.status === 403){ alert('You do not have permission to perform this action.'); return null; }
  if(!r.ok) throw new Error(`PATCH /programs/${programId}/templates/${templateId} failed (${r.status})`);
  return r.json();
}
async function apiDeleteTemplate(programId, templateId){
  const r = await fetch(`${API}/programs/${encodeURIComponent(programId)}/templates/${encodeURIComponent(templateId)}`, {
    method:'DELETE', credentials:'include'
  });
  if(r.status === 404) return null;
  if(r.status === 403){ alert('You do not have permission to perform this action.'); return null; }
  if(!r.ok) throw new Error(`DELETE /programs/${programId}/templates/${templateId} failed (${r.status})`);
  return r.json();
}
async function apiInstantiateProgram(programId) {
  const opts = { method:'POST', credentials:'include' };
  if (TARGET_USER_ID && CURRENT_USER_ID && TARGET_USER_ID !== CURRENT_USER_ID) {
    opts.headers = { 'Content-Type': 'application/json' };
    opts.body = JSON.stringify({ user_id: TARGET_USER_ID });
  }
  const res = await fetch(`${API}/programs/${encodeURIComponent(programId)}/instantiate`, opts);
  if(res.status === 403){ alert('You do not have permission to perform this action.'); return null; }
  if (!res.ok) throw new Error('POST /programs/:id/instantiate failed');
  return res.json();
}

// Preload a program's templates into ANOTHER user's task list (admin/manager only)
async function apiPreloadProgramForUser(userId, programId) {
  const url = `${API}/rbac/users/${encodeURIComponent(userId)}/programs/${encodeURIComponent(programId)}/instantiate`;
  const res = await fetch(url, { method: 'POST', credentials: 'include' });
  if (res.status === 403) { alert('You do not have permission to perform this action.'); return null; }
  if (!res.ok) throw new Error('POST /rbac/users/:id/programs/:program_id/instantiate failed');
  return res.json(); // -> { ok: true, created: <n> }
}


/* ---- TASK helpers ---- */
async function apiGetTasks(params = {}){
  const { include_deleted = false, ...rest } = params;
  if(include_deleted) rest.include_deleted = 'true';
  const usp = new URLSearchParams(rest);
  const r = await fetch(withUser(`${API}/tasks?${usp.toString()}`), { credentials:'include' });
  if(!r.ok) throw new Error('GET /tasks failed');
  return r.json();
}
async function apiPatchTask(taskId, payload) {
  const res = await fetch(withUser(`${API}/tasks/${encodeURIComponent(taskId)}`), {
    method: 'PATCH', credentials:'include',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });
  if (res.status === 404) return null;
  if(res.status === 403){ alert('You do not have permission to perform this action.'); return null; }
  if (!res.ok) throw new Error(`PATCH /tasks/${taskId} failed (${res.status})`);
  return res.json();
}
async function apiPatchScheduledFor(taskId, date) {
  return apiPatchTask(taskId, { scheduled_for: date || null });
}
async function apiCreateTask(data) {
  const res = await fetch(`${API}/tasks`, {
    method: 'POST', credentials:'include',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(withUserBody(data))
  });
  if(res.status === 403){ alert('You do not have permission to perform this action.'); return null; }
  if (!res.ok) throw new Error(`POST /tasks failed (${res.status})`);
  return res.json();
}
async function apiDeleteTask(taskId) {
  const res = await fetch(withUser(`${API}/tasks/${encodeURIComponent(taskId)}`), {
    method: 'DELETE', credentials:'include'
  });
  if (res.status === 404) return null;
  if(res.status === 403){ alert('You do not have permission to perform this action.'); return null; }
  if (!res.ok) throw new Error(`DELETE /tasks/${taskId} failed (${res.status})`);
  return res.json();
}

async function apiRestoreTask(taskId){
  const res = await fetch(withUser(`${API}/tasks/${encodeURIComponent(taskId)}/restore`), {
    method: 'POST', credentials:'include'
  });
  if (res.status === 404) return null;
  if(res.status === 403){ alert('You do not have permission to perform this action.'); return null; }
  if (!res.ok) throw new Error(`POST /tasks/${taskId}/restore failed (${res.status})`);
  return res.json();
}

/* ---- APP ---- */
function Section({title, subtitle, children, right}){
  return (
    <section className="card p-4 md:p-6">
      <div className="flex items-center justify-between gap-4 flex-wrap">
        <div>
          <h2 className="text-xl font-semibold">{title}</h2>
          {subtitle && <p className="text-sm text-slate-500">{subtitle}</p>}
        </div>
        {right}
      </div>
      <div className="mt-4">{children}</div>
    </section>
  );
}
function ProgressBar({value}){
  return (
    <div className="w-full bg-slate-100 h-2 rounded-full overflow-hidden">
      <div className="h-2 bg-anx-sky" style={{width:`${Math.max(0,Math.min(value,100))}%`}}></div>
    </div>
  );
}
function Ring({value=0}){
  const r=42, c=2*Math.PI*r, off=c - (c * value/100);
  return (
    <svg width="120" height="120" viewBox="0 0 120 120" className="mx-auto">
      <circle cx="60" cy="60" r={r} fill="none" stroke="#e5e7eb" strokeWidth="12" />
      <circle cx="60" cy="60" r={r} fill="none" stroke="#0ea5e9" strokeWidth="12" strokeLinecap="round" style={{ strokeDasharray:c, strokeDashoffset:off, transform:'rotate(-90deg)', transformOrigin:'50% 50%'}}/>
      <text x="50%" y="50%" dominantBaseline="middle" textAnchor="middle" className="fill-slate-700 font-semibold">{value}%</text>
    </svg>
  );
}

function App({ me, onSignOut }){
  const [targetUserId, setTargetUserId] = useState(TARGET_USER_ID);
  const [targetUserName, setTargetUserName] = useState(() => {
    if (TARGET_USER_NAME) return TARGET_USER_NAME;
    if (TARGET_USER_ID && (!me?.id || !sameId(TARGET_USER_ID, me.id))) return '';
    return me?.name || 'Halle Angeles';
  });
  const [startDate, setStartDate] = useState(dayjs().format('YYYY-MM-DD'));
  const [numWeeks, setNumWeeks] = useState(6);
  const [weeks, setWeeks] = useState([]);
  const [deletedTasks, setDeletedTasks] = useState([]);
  const [assignPicker, setAssignPicker] = useState(null); // {date}
  const [dragBadge, setDragBadge] = useState(null);       // {wi,ti,task_id}
  const [expandedDays, setExpandedDays] = useState(new Set());
  const [needsInstantiate, setNeedsInstantiate] = useState(false);
  const [programs, setPrograms] = useState([]);
  const [programModal, setProgramModal] = useState({ show:false, program:null });
  const [panelOpen, setPanelOpen] = useLocalStorageState('anx_panel_open', false);
  const [panelWidth, setPanelWidth] = useLocalStorageState('anx_panel_width_px', 260);
  const [showTemplates, setShowTemplates] = useState(false);
  const [templateProgramId, setTemplateProgramId] = useState(null);
  const [openSections, setOpenSections] = useLocalStorageState('anx_panel_openKeys', []);
  const [searchTerm, setSearchTerm] = useState('');
  const [userList, setUserList] = useState([]);
  const searchDebounce = useRef(null);
  const touchHover = useRef(null);
  const panelRef = useRef(null);
  const triggerRef = useRef(null);
  const perms = useMemo(() => new Set(me?.perms || []), [me]);
  const hasPerm = (p) => perms.has(p);
  const isTrainee = (me?.roles || []).includes('trainee');
  const isReadOnly = (me?.roles || []).some(r => r === 'viewer' || r === 'auditor');
  const isPrivileged = (me?.roles || []).includes('admin') || (me?.roles || []).includes('manager');
  const restoreFocus = () => {
    triggerRef.current && triggerRef.current.focus();
  };
  const togglePanel = (e) => {
    if (panelOpen) {
      setPanelOpen(false);
      restoreFocus();
    } else {
      triggerRef.current = e.currentTarget;
      setPanelOpen(true);
    }
  };

  const toggleSection = (key) => {
    setOpenSections(prev => prev.includes(key) ? prev.filter(k => k !== key) : [...prev, key]);
  };

  const handleUserChange = async (e) => {
    const uid = e.target.value; // keep UUID as string
    const sel = userList.find(u => String(u.id) === String(uid)) || {};
    const selectedName = sel.full_name || '';
    setTargetUserId(uid);
    setTargetUserName(selectedName);
    TARGET_USER_ID = uid;
    TARGET_USER_NAME = selectedName;
    writeStoredTrainee(uid, selectedName);
    try {
      await apiPatchPrefs({ trainee: uid }, { skipUser: true });
    } catch (err) {
      console.error('Failed to save trainee preference', err);
    }
    try {
      const prefs = await apiGetPrefs(); // NOTE: server /prefs returns current user's prefs by default
      QS_PROGRAM_ID = prefs.program_id || null;
      if (QS_PROGRAM_ID) {
        const count = await reloadTasks();
        setNeedsInstantiate(count === 0);
      } else {
        setWeeks([]);
        setDeletedTasks([]);
        setNeedsInstantiate(false);
      }
    } catch (err) {
      console.error('Failed to load tasks', err);
    }
  };

  const handleSearchChange = (e) => {
    const val = e.target.value;
    clearTimeout(searchDebounce.current);
    searchDebounce.current = setTimeout(() => setSearchTerm(val), 150);
  };

  const resizeMove = useRafThrottle((e) => {
    const width = Math.max(260, Math.min(400, window.innerWidth - e.clientX));
    setPanelWidth(width);
  });
  const startResize = (e) => {
    e.preventDefault();
    const move = (ev) => resizeMove(ev);
    const up = () => {
      document.removeEventListener('pointermove', move);
      document.removeEventListener('pointerup', up);
    };
    document.addEventListener('pointermove', move);
    document.addEventListener('pointerup', up);
  };

  const [acctName, setAcctName] = useState(me?.name || '');
  const [acctEmail, setAcctEmail] = useState(me?.email || '');
  const [acctUsername, setAcctUsername] = useState(me?.username || '');
  const [pwCurrent, setPwCurrent] = useState('');
  const [pwNew, setPwNew] = useState('');
  const [acctMsg, setAcctMsg] = useState('');
  const [pwMsg, setPwMsg] = useState('');

  useEffect(() => {
    TARGET_USER_ID = targetUserId;
    TARGET_USER_NAME = targetUserName;
  }, [targetUserId, targetUserName]);

  useEffect(() => {
    if (!isPrivileged) return;
    (async () => {
      try {
        const list = await apiListUsers();
        let normalized = Array.isArray(list) ? [...list] : [];
        if (CURRENT_USER_ID) {
          const hasCurrent = normalized.some(u => sameId(u.id, CURRENT_USER_ID));
          if (!hasCurrent) {
            const currentName = me?.name || me?.full_name || me?.username || 'Current user';
            normalized = [
              { id: CURRENT_USER_ID, full_name: currentName, name: currentName },
              ...normalized,
            ];
          }
        }
        setUserList(normalized);
        if (CURRENT_USER_ID) {
          setTargetUserId(String(CURRENT_USER_ID));
        }
      } catch (err) {
        console.error('Failed to load users', err);
      }
    })();
  }, [isPrivileged, me]);

  useEffect(() => {
    if (!targetUserId) return;
    const match = userList.find(u => String(u.id) === String(targetUserId));
    if (match && match.full_name && match.full_name !== targetUserName) {
      setTargetUserName(match.full_name);
      writeStoredTrainee(targetUserId, match.full_name);
    }
  }, [targetUserId, targetUserName, userList]);

  useEffect(() => {
    if (!panelOpen) return;
    const handleKey = (e) => {
      if (e.key === 'Escape') {
        e.preventDefault();
        setPanelOpen(false);
        restoreFocus();
      }
    };
    document.addEventListener('keydown', handleKey);
    return () => document.removeEventListener('keydown', handleKey);
  }, [panelOpen]);
  useFocusTrap(panelOpen, panelRef);

  function buildWeeks(rows){
    const byWeek = {};
    rows.forEach(r => {
      const wk = r.week_number || 0;
      if (!byWeek[wk]) {
        byWeek[wk] = { id: uid(), wk, title:'', theme:'', result:'', purpose:'', actions:'', tasks: [] };
      }
      byWeek[wk].tasks.push({
        id: r.task_id,
        task_id: r.task_id,
        title: r.label,
        notes: r.notes || '',
        completed: r.done,
        scheduled_for: r.scheduled_for
      });
    });
    return Object.values(byWeek).sort((a,b)=> a.wk - b.wk);
  }

  async function reloadTasks(){
    if(!QS_PROGRAM_ID) return 0;
    const rows = await apiGetTasks({ program_id: QS_PROGRAM_ID, include_deleted: true });
    const active = rows.filter(r => !r.deleted);
    setWeeks(buildWeeks(active));
    setDeletedTasks(rows.filter(r => r.deleted));
    return active.length;
  }

  
/* Load tasks */
useEffect(() => {
  async function load() {
    try {
      // 1) Always ask the server first for the current user's preference
      const prefs = await apiGetPrefs(); // NOTE: server /prefs returns current user's prefs by default
      let pid = prefs.program_id || null;

      // 2) If the server has no preference yet, fall back to URL/localStorage
      if (!pid) {
        pid = qs.get('program_id') || localStorage.getItem('anx_program_id') || null;
      }

      if (pid) {
        // 3) Persist + tell server so future logins restore correctly
        QS_PROGRAM_ID = pid;
        localStorage.setItem('anx_program_id', pid);
        try { await apiPatchPrefs({ program_id: pid }); } catch (e) {}

        // 4) Load tasks
        const count = await reloadTasks();
        setNeedsInstantiate(count === 0);
      } else {
        // No program selected yet: clear UI
        localStorage.removeItem('anx_program_id');
        setWeeks([]);
        setDeletedTasks([]);
        setNeedsInstantiate(false);
      }
    } catch (err) {
      console.error('Failed to load tasks', err);
    }
  }
  load();
}, []);

  /* Load programs */
  useEffect(() => {
    (async () => {
      try {
        const list = await apiListPrograms();
        setPrograms(list);
      } catch (err) {
        console.error('Failed to load programs', err);
      }
    })();
  }, []);

  async function handleInstantiate(){
    try {
      const res = await apiInstantiateProgram(QS_PROGRAM_ID);
      if(!res) return;
      await reloadTasks();
      setNeedsInstantiate(false);
    } catch(err){
      console.error('Failed to instantiate program', err);
      alert('Failed to load program tasks');
    }
  }

  const progress = useMemo(()=>{
    const all = weeks.flatMap(w=> w.tasks||[]);
    const done = all.filter(t=> t.completed).length;
    const total = all.length || 1;
    return {done, total, pct: Math.round(100*done/total)};
  }, [weeks]);

  const calDays = useMemo(()=>{
    const s = dayjs(startDate).startOf('week');
    const totalDays = Math.max(7, numWeeks * 7);
    return Array.from({length: totalDays}, (_,i)=> s.add(i,'day'));
  }, [startDate, numWeeks]);

  const scheduledMap = useMemo(()=>{
    const map = {};
    weeks.forEach((w, wi)=> (w.tasks||[]).forEach((t,ti)=>{
      if(t.scheduled_for){
        const key = dayjs(t.scheduled_for).format('YYYY-MM-DD');
        map[key] = map[key] || [];
        map[key].push({ label:`W${w.wk}: ${t.title}`, done: t.completed, wi, ti, task_id: t.task_id });
      }
    }));
    return map;
  }, [weeks]);

  async function refreshPrograms(newId){
    try {
      const list = await apiListPrograms();
      setPrograms(list);
      if(newId !== undefined){
        QS_PROGRAM_ID = newId;
      }
      if(QS_PROGRAM_ID && !list.find(p=> p.program_id === QS_PROGRAM_ID)){
        QS_PROGRAM_ID = list[0]?.program_id || null;
      }
      if(QS_PROGRAM_ID){
        localStorage.setItem('anx_program_id', QS_PROGRAM_ID);
        try { await apiPatchPrefs({ program_id: QS_PROGRAM_ID }); } catch(e){}
        const count = await reloadTasks();
        if(!count){ setNeedsInstantiate(true); }
        else { setNeedsInstantiate(false); }
      } else {
        localStorage.removeItem('anx_program_id');
        setWeeks([]); setDeletedTasks([]); setNeedsInstantiate(false);
      }
    } catch(err){
      console.error('Failed to refresh programs', err);
    }
  }

  async function handleDeleteProgram(programId){
    if(!confirm('Delete this program?')) return;
    try {
      const response = await apiDeleteProgram(programId);
      if(!response || response.deleted !== true) return;
      await refreshPrograms();
    } catch(err){
      console.error('Failed to delete program', err);
      alert('Failed to delete program');
    }
  }

  async function saveAccount(e){
    e.preventDefault();
    setAcctMsg('');
    try {
      const u = await apiPatchMe({ full_name: acctName, email: acctEmail, username: acctUsername });
      if(!u){ setAcctMsg('Save failed'); return; }
      setAcctName(u.name || '');
      setAcctEmail(u.email || '');
      setAcctUsername(u.username || '');
      setAcctMsg('Saved');
    } catch (err) {
      setAcctMsg('Save failed');
    }
  }

  async function changePassword(e){
    e.preventDefault();
    setPwMsg('');
    try {
      const res = await apiChangePassword({ current_password: pwCurrent, new_password: pwNew });
      if(!res){ setPwMsg('Change failed'); return; }
      setPwMsg('Password updated');
      setPwCurrent('');
      setPwNew('');
    } catch (err) {
      setPwMsg('Change failed');
    }
  }

  async function setTaskDate(wi, ti, date, taskId){
    const prevWeeks = structuredClone(weeks);
    setWeeks(prev => {
      const clone = structuredClone(prev);
      if (clone[wi]?.tasks?.[ti]) clone[wi].tasks[ti].scheduled_for = date;
      return clone;
    });
    if (!taskId) { setWeeks(prevWeeks); alert('Failed to save scheduled date'); return; }
    try {
      const row = await apiPatchScheduledFor(taskId, date);
      if (!row || !row.task_id) { setWeeks(prevWeeks); alert('Failed to save scheduled date'); }
    } catch (err) { setWeeks(prevWeeks); alert('Failed to save scheduled date'); }
  }

  function toggleTask(wi, ti){
    const task = weeks[wi]?.tasks?.[ti];
    if(!task) return;
    const prevValue = task.completed;
    const taskId = task.task_id;
    setWeeks(prev => {
      const clone = structuredClone(prev);
      const t = clone[wi]?.tasks?.[ti];
      if(t) t.completed = !prevValue;
      return clone;
    });
    apiPatchTask(taskId, { done: !prevValue }).then(row => {
      if(!row){
        setWeeks(prev => {
          const clone = structuredClone(prev);
          const t = clone[wi]?.tasks?.[ti];
          if(t) t.completed = prevValue;
          return clone;
        });
      }
    }).catch(err => {
      console.error('Failed to update task completion', err);
      setWeeks(prev => {
        const clone = structuredClone(prev);
        const t = clone[wi]?.tasks?.[ti];
        if(t) t.completed = prevValue;
        return clone;
      });
    });
  }

  async function handleAddTask(wi){
    const label = prompt('Task title?');
    if(!label) return;
    try {
      const created = await apiCreateTask({
        label,
        week_number: weeks[wi].wk,
        program_id: QS_PROGRAM_ID
      });
      if(!created) return;
      setWeeks(prev => {
        const clone = structuredClone(prev);
        const task = {
          id: created.task_id,
          task_id: created.task_id,
          title: created.label,
          notes: created.notes || '',
          completed: created.done,
          scheduled_for: created.scheduled_for
        };
        clone[wi].tasks = clone[wi].tasks || [];
        clone[wi].tasks.push(task);
        return clone;
      });
    } catch(err){
      console.error('Failed to create task', err);
      alert('Failed to create task');
    }
  }

  async function handleDeleteTask(wi, ti){
    const task = weeks[wi]?.tasks?.[ti];
    if(!task) return;
    if(!confirm('Delete this task?')) return;
    try {
      const res = await apiDeleteTask(task.task_id);
      if(!res) return;
      const weekNumber = weeks[wi].wk;
      setWeeks(ws => {
        const copy = ws.map(w => ({ ...w, tasks: [...(w.tasks||[])] }));
        copy[wi].tasks.splice(ti,1);
        return copy;
      });
      setDeletedTasks(dt => [...dt, { ...task, label: task.title, week_number: weekNumber }]);
    } catch(err){
      console.error('Failed to delete task', err);
      alert('Failed to delete task');
    }
  }

  async function handleRestoreTask(taskId){
    try {
      const res = await apiRestoreTask(taskId);
      if (!res) { console.warn('Task restore failed'); return; }
      setDeletedTasks(dt => dt.filter(t => t.task_id !== taskId));
      setWeeks(ws => {
        const copy = ws.map(w => ({ ...w, tasks: [...(w.tasks||[])] }));
        const wi = copy.findIndex(w => w.wk === res.week_number);
        const newTask = {
          id: res.task_id,
          task_id: res.task_id,
          title: res.label,
          notes: res.notes || '',
          completed: res.done,
          scheduled_for: res.scheduled_for
        };
        if (wi !== -1) {
          copy[wi].tasks.push(newTask);
        } else {
          copy.push({ id: uid(), wk: res.week_number, title:'', theme:'', result:'', purpose:'', actions:'', tasks:[newTask] });
          copy.sort((a,b)=> a.wk - b.wk);
        }
        return copy;
      });
    } catch(err){
      console.error('Failed to restore task', err);
      alert('Failed to restore task');
    }
  }

  function toggleExpandedDay(key){
    setExpandedDays(prev => {
      const next = new Set(prev);
      if(next.has(key)) next.delete(key); else next.add(key);
      return next;
    });
  }

  function handleDragStart(e){
    if (!(hasPerm('task.assign') && isPrivileged && !isTrainee)) return;
    const { wi, ti, taskid } = e.currentTarget.dataset;
    setDragBadge({ wi: Number(wi), ti: Number(ti), task_id: taskid });
  }
  function handleDragEnd(){
    if (!(hasPerm('task.assign') && isPrivileged && !isTrainee)) return;
    setDragBadge(null);
  }
  function handleDragOver(e){
    if (!(hasPerm('task.assign') && isPrivileged && !isTrainee)) return;
    e.preventDefault();
    e.currentTarget.classList.add('outline-dashed','outline-2','outline-anx-sky');
  }
  function handleDragLeave(e){
    if (!(hasPerm('task.assign') && isPrivileged && !isTrainee)) return;
    e.currentTarget.classList.remove('outline-dashed','outline-2','outline-anx-sky');
  }
  function handleDrop(e, date){
    if (!(hasPerm('task.assign') && isPrivileged && !isTrainee)) return;
    e.preventDefault();
    handleDragLeave(e);
    if(dragBadge){
      setTaskDate(dragBadge.wi, dragBadge.ti, date, dragBadge.task_id);
      setDragBadge(null);
    }
  }

  function handleTouchMove(e){
    if (!(hasPerm('task.assign') && isPrivileged && !isTrainee)) return;
    const touch = e.touches[0];
    const el = document.elementFromPoint(touch.clientX, touch.clientY);
    if(touchHover.current && touchHover.current !== el){
      handleDragLeave({currentTarget: touchHover.current});
      touchHover.current = null;
    }
    if(el && el.dataset && el.dataset.date){
      handleDragOver({preventDefault: ()=>{}, currentTarget: el});
      touchHover.current = el;
    }
    e.preventDefault();
  }
  function handleTouchEnd(e){
    if (!(hasPerm('task.assign') && isPrivileged && !isTrainee)) return;
    const touch = e.changedTouches[0];
    const el = document.elementFromPoint(touch.clientX, touch.clientY);
    if(touchHover.current){
      handleDragLeave({currentTarget: touchHover.current});
      touchHover.current = null;
    }
    if(el && el.dataset && el.dataset.date){
      handleDrop({preventDefault: ()=>{}, currentTarget: el}, el.dataset.date);
    } else {
      setDragBadge(null);
    }
  }

  const weekColumns = useMemo(()=> {
    const sorted = [...weeks].sort((a,b)=> a.wk - b.wk);
    return sorted.map((w,wi)=> ({
      wk: w.wk,
      title: w.title,
      items: (w.tasks||[])
        .map((t, ti) => (!t.scheduled_for ? { label: t.title, wi, ti, task_id: t.task_id } : null))
        .filter(Boolean)
    }));
  }, [weeks]);

  function AssignModal({date, onClose}){
    const visible = weekColumns.filter(c => c.items.length);
    const handleAssign = (it) => { setTaskDate(it.wi, it.ti, date, it.task_id); onClose(); };
    return ReactDOM.createPortal(
      <div className="fm-modal-overlay" role="dialog" aria-modal="true" onClick={onClose} tabIndex={0}>
        <div className="fm-modal" onClick={(e)=> e.stopPropagation()}>
          <div className="fm-modal-header">
            <div className="font-semibold">Assign Task to {fmt(date)}</div>
            <button className="btn btn-ghost" onClick={onClose} aria-label="Close">✕</button>
          </div>
          <div className="fm-modal-body">
            {visible.length ? (
              <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-3">
                {visible.map((col, idx)=> (
                  <div key={idx} className="border rounded-xl overflow-hidden">
                    <div className="px-3 py-2 bg-slate-50 text-sm font-semibold border-b">Week {col.wk}</div>
                    <div className="p-2 grid gap-2">
                      {col.items.map((it, i)=> (
                        <button key={i} className="btn btn-outline justify-start truncate text-left" title={it.label} onClick={()=> handleAssign(it)}>
                          {it.label}
                        </button>
                      ))}
                    </div>
                  </div>
                ))}
              </div>
            ) : (
              <div className="flex items-center justify-center py-8">
                <div className="card p-6 text-center text-sm text-slate-500">All tasks are scheduled!</div>
              </div>
            )}
          </div>
        </div>
      </div>,
      document.body
    );
  }

  function ProgramModal({ program, onClose }){
    const [title, setTitle] = useState(program?.title || '');
    const [weeksCount, setWeeksCount] = useState(program?.total_weeks || 6);
    const [desc, setDesc] = useState(program?.description || '');
    const [showTemplates, setShowTemplates] = useState(false);

    useEffect(()=>{
      setTitle(program?.title || '');
      setWeeksCount(program?.total_weeks || 6);
      setDesc(program?.description || '');
    }, [program]);

    async function handleSave(){
      try {
        const data = { title: title.trim(), total_weeks: Number(weeksCount), description: desc };
        let saved;
        if(program?.program_id){
          saved = await apiPatchProgram(program.program_id, data);
        } else {
          saved = await apiCreateProgram(data);
        }
        if(!saved) return;
        await refreshPrograms(saved.program_id);
        onClose();
      } catch(err){
        console.error('Failed to save program', err);
        alert('Failed to save program');
      }
    }

    async function handleDelete(){
      if(!program?.program_id) return;
      if(!confirm('Delete this program?')) return;
      try {
        const res = await apiDeleteProgram(program.program_id);
        if(!res) return;
        await refreshPrograms();
        onClose();
      } catch(err){
        console.error('Failed to delete program', err);
        alert('Failed to delete program');
      }
    }

    return ReactDOM.createPortal(
      <div className="fm-modal-overlay" role="dialog" aria-modal="true" onClick={onClose} tabIndex={0}>
        <div className="fm-modal max-w-lg" onClick={e=> e.stopPropagation()}>
          <div className="fm-modal-header">
            <div className="font-semibold">{program?.program_id ? 'Edit Program' : 'New Program'}</div>
            <button className="btn btn-ghost" onClick={onClose} aria-label="Close">✕</button>
          </div>
          <div className="fm-modal-body space-y-4">
            <div>
              <label className="text-sm block mb-1">Title</label>
              <input className="input" value={title} onChange={e=>setTitle(e.target.value)} />
            </div>
            <div>
              <label className="text-sm block mb-1">Total Weeks</label>
              <input type="number" min="1" className="input" value={weeksCount} onChange={e=> setWeeksCount(e.target.value)} />
            </div>
            <div>
              <label className="text-sm block mb-1">Description</label>
              <textarea className="textarea" value={desc} onChange={e=> setDesc(e.target.value)} />
            </div>
            <div className="flex items-center justify-between pt-2">
              {program?.program_id && (
                <div className="flex items-center gap-2">
                  {hasPerm('program.delete') && !isTrainee && (
                    <button className="btn btn-outline" onClick={handleDelete}>Delete</button>
                  )}
                  {hasPerm('template.read') && !isTrainee && (
                    <button className="btn btn-outline" onClick={()=> setShowTemplates(true)}>Templates</button>
                  )}
                </div>
              )}
              <div className="ml-auto flex items-center gap-2">
                <button className="btn btn-ghost" onClick={onClose}>Cancel</button>
                <button className="btn btn-primary" onClick={handleSave}>Save</button>
              </div>
            </div>
          </div>
          {showTemplates && program?.program_id && hasPerm('template.read') && !isTrainee && <TemplateModal programId={program.program_id} onClose={()=> setShowTemplates(false)} />}
        </div>
      </div>,
      document.body
    );
  }

  function TemplateModal({ programId, onClose }){
    const [templates, setTemplates] = useState([]);
    const [editing, setEditing] = useState(null);
    const [wk, setWk] = useState(1);
    const [label, setLabel] = useState('');
    const [notes, setNotes] = useState('');
    const [sort, setSort] = useState(1);

    useEffect(()=>{ refresh(); }, [programId]);

    async function refresh(){
      try {
        const list = await apiListTemplates(programId);
        setTemplates(list);
      } catch(err){
        console.error('Failed to load templates', err);
      }
    }

    function startNew(){
      setEditing({});
      setWk(1); setLabel(''); setNotes(''); setSort(1);
    }
    function startEdit(t){
      setEditing(t);
      setWk(t.week_number||1); setLabel(t.label||''); setNotes(t.notes||''); setSort(t.sort_order||1);
    }
    function cancelEdit(){
      setEditing(null);
    }

    async function handleSave(e){
      e.preventDefault();
      try {
        const data = { week_number:Number(wk), label:label.trim(), notes, sort_order:Number(sort) };
        let saved;
        if(editing?.template_id){
          saved = await apiPatchTemplate(programId, editing.template_id, data);
        } else {
          saved = await apiCreateTemplate(programId, data);
        }
        if(!saved) return;
        await refresh();
        setEditing(null);
        if(programId === QS_PROGRAM_ID) await refreshPrograms();
      } catch(err){
        console.error('Failed to save template', err);
        alert('Failed to save template');
      }
    }

    async function handleDelete(id){
      if(!confirm('Delete this template?')) return;
      try {
        const res = await apiDeleteTemplate(programId, id);
        if(!res) return;
        await refresh();
        if(programId === QS_PROGRAM_ID) await refreshPrograms();
      } catch(err){
        console.error('Failed to delete template', err);
        alert('Failed to delete template');
      }
    }

    return ReactDOM.createPortal(
      <div className="fm-modal-overlay" role="dialog" aria-modal="true" onClick={onClose} tabIndex={0}>
        <div className="fm-modal max-w-2xl" onClick={e=> e.stopPropagation()}>
          <div className="fm-modal-header">
            <div className="font-semibold">Manage Templates</div>
            <button className="btn btn-ghost" onClick={onClose} aria-label="Close">✕</button>
          </div>
          <div className="fm-modal-body space-y-4">
            <div className="flex justify-between items-center">
              <div className="text-sm font-semibold">Templates</div>
              {(hasPerm('template.create') || hasPerm('template.update')) && (
                <button className="btn btn-outline" onClick={startNew}>+ New Row</button>
              )}
            </div>
            <div className="space-y-2">
              {templates.map(t=> (
                <div key={t.template_id} className="border rounded p-2 flex items-center justify-between text-sm">
                  <div>
                    <div className="text-sm font-medium">Week {t.week_number} • {t.label}</div>
                    <div className="text-xs text-slate-500">Sort {t.sort_order}{t.notes?` • ${t.notes}`:''}</div>
                  </div>
                  <div className="flex items-center gap-2">
                    <button
                      className="btn btn-ghost"
                      onClick={() => startEdit(t)}
                      title="Edit"
                    >
                      <span aria-hidden="true">✏️</span>
                      <span className="sr-only">Edit</span>
                    </button>
                    {hasPerm('template.delete') && (
                      <button
                        className="btn btn-ghost"
                        onClick={() => handleDelete(t.template_id)}
                        title="Delete"
                      >
                        <span aria-hidden="true">🗑️</span>
                        <span className="sr-only">Delete</span>
                      </button>
                    )}
                  </div>
                </div>
              ))}
            </div>
            {editing && (
              <form onSubmit={handleSave} className="space-y-2 pt-2">
                <div className="grid grid-cols-2 gap-2">
                  <div>
                    <label className="text-sm block mb-1">Week #</label>
                    <input type="number" className="input" value={wk} onChange={e=> setWk(e.target.value)} />
                  </div>
                  <div>
                    <label className="text-sm block mb-1">Sort Order</label>
                    <input type="number" className="input" value={sort} onChange={e=> setSort(e.target.value)} />
                  </div>
                </div>
                <div>
                  <label className="text-sm block mb-1">Label</label>
                  <input className="input" value={label} onChange={e=> setLabel(e.target.value)} />
                </div>
                <div>
                  <label className="text-sm block mb-1">Notes</label>
                  <textarea className="textarea" value={notes} onChange={e=> setNotes(e.target.value)} />
                </div>
                <div className="flex items-center justify-end gap-2">
                  <button type="button" className="btn btn-ghost" onClick={cancelEdit}>Cancel</button>
                  {(hasPerm('template.create') || hasPerm('template.update')) && (
                    <button type="submit" className="btn btn-primary">Save</button>
                  )}
                </div>
              </form>
            )}
          </div>
        </div>
      </div>,
      document.body
    );
  }

  const controlBar = !isTrainee && (
    <div className="flex items-center gap-3">
      <select className="input" value={QS_PROGRAM_ID||''} onChange={e=> refreshPrograms(e.target.value||null)}>
        <option value="">Select program</option>
        {programs.map(p=> <option key={p.program_id} value={p.program_id}>{p.title}</option>)}
      </select>
      {(hasPerm('program.create') || hasPerm('program.update')) ? (
        <button className="btn btn-outline" onClick={()=> setProgramModal({ show: true, program: programs.find(p => p.program_id === QS_PROGRAM_ID) || null })}>Manage</button>
      ) : isReadOnly && (
        <button className="btn btn-outline opacity-50 cursor-not-allowed" title="Read-only users cannot manage programs" disabled>
          <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="currentColor" viewBox="0 0 20 20">
            <path fillRule="evenodd" d="M10 1a4 4 0 00-4 4v3H5a2 2 0 00-2 2v6a2 2 0 002 2h10a2 2 0 002-2v-6a2 2 0 00-2-2h-1V5a4 4 0 00-4-4zm-2 7V5a2 2 0 114 0v3H8z" clipRule="evenodd" />
          </svg>
        </button>
      )}
      <div className="h-6 w-px bg-slate-200" />
      <label className="text-sm text-slate-600">Start</label>
      <input type="date" className="input w-[160px]" value={startDate} onChange={(e)=> setStartDate(e.target.value)} />
      <div className="h-6 w-px bg-slate-200" />
      <label className="text-sm text-slate-600">Weeks</label>
      <div className="flex items-center gap-1">
        <button className="btn btn-outline" onClick={()=> setNumWeeks(w=> Math.max(1, w-1))} aria-label="Decrease weeks">−</button>
        <input type="number" min="1" max="24" step="1" className="input w-16 text-center" value={numWeeks}
               onChange={(e)=> setNumWeeks(()=> { const v = parseInt(e.target.value||'1',10); return isNaN(v) ? 1 : Math.min(24, Math.max(1, v)); })} />
        <button className="btn btn-outline" onClick={()=> setNumWeeks(w=> Math.min(24, w+1))} aria-label="Increase weeks">+</button>
      </div>
      <div className="h-6 w-px bg-slate-200" />
      <button className="btn btn-ghost" title="Jump to today" onClick={()=> setStartDate(dayjs().format('YYYY-MM-DD'))}>Today</button>
    </div>
  );

  return (
    <div className="flex">
      <div className="flex-1 space-y-6 py-6">
          <header className="flex items-center justify-between gap-4 flex-wrap">
            <div className="flex items-center gap-2">
              <div>
                <h1 className="text-2xl md:text-3xl font-bold">ANX Orientation • {targetUserName}</h1>
                <p className="text-sm text-slate-500">{numWeeks}-Week Program • Start {fmt(startDate)}</p>
                {me.roles?.length > 0 && (
                  <div className="text-xs text-slate-500">
                    Roles: {me.roles.join(', ')}
                  </div>
                )}
              </div>
            </div>
              <div className="flex items-center gap-2">
               {controlBar}
               {isTrainee && (
               <button className="btn btn-outline" onClick={onSignOut}>
               Sign out
               </button>
                  )}
              </div>

          </header>

      {!isTrainee && needsInstantiate && (
        <div className="card p-6">
          <p className="mb-4">This program has no tasks yet. Load preset tasks?</p>
          <button className="btn btn-primary" onClick={handleInstantiate}>Load Program Tasks</button>
        </div>
      )}

      {/* KPIs */}
      {!isTrainee && (
        <div className="grid md:grid-cols-4 gap-4">
          <div className="card p-4"><div className="text-sm text-slate-500">Overall Progress</div><Ring value={progress.pct}/></div>
          <div className="card p-4"><div className="text-sm text-slate-500">Tasks Completed</div><div className="text-2xl font-semibold mt-2">{progress.done}/{progress.total}</div></div>
          <div className="card p-4"><div className="text-sm text-slate-500">Weeks</div><div className="text-2xl font-semibold mt-2">{numWeeks}</div></div>
          <div className="card p-4"><div className="text-sm text-slate-500">Start</div><div className="text-2xl font-semibold mt-2">{fmt(startDate)}</div></div>
        </div>
      )}

      {/* Calendar */}
      {(
      <Section title={`${numWeeks}-Week Visual Calendar`} subtitle="Assign tasks by date; click Assign on a day.">
        <div className="grid grid-cols-7 gap-2 text-xs font-medium text-slate-500 mb-2">
          {['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].map(d=> <div key={d} className="text-center">{d}</div>)}
        </div>
        <div className="grid grid-cols-7 gap-2">
          {calDays.map((d,idx)=>{
            const key = d.format('YYYY-MM-DD');
            const items = scheduledMap[key]||[];
            const out = !inRange(d, startDate, numWeeks);
            const expanded = expandedDays.has(key);
            return (
              <div key={idx} data-date={key} className={`card p-2 min-h-[96px] ${out?'opacity-60 bg-slate-50':''}`}
                   onDragOver={hasPerm('task.assign') && isPrivileged && !isTrainee ? handleDragOver : undefined} onDragLeave={hasPerm('task.assign') && isPrivileged && !isTrainee ? handleDragLeave : undefined} onDrop={hasPerm('task.assign') && isPrivileged && !isTrainee ? (e)=>handleDrop(e,key) : undefined}>
                <div className="flex items-center justify-between mb-1">
                  <div className="text-xs font-semibold">{d.format('D')}</div>
                  {hasPerm('task.assign') && isPrivileged && !isTrainee && <button className="btn btn-ghost text-xs" onClick={()=> setAssignPicker({date:key})}>Assign</button>}
                </div>
                <div className="space-y-1">
                  {items.slice(0, expanded ? items.length : 3).map((it,i)=> (
                    <div key={i}
                         className={`relative text-[11px] pl-2 pr-4 py-1 rounded-md border ${it.done?'bg-emerald-50 border-emerald-300':'bg-sky-50 border-sky-300'}`}
                         draggable={hasPerm('task.assign') && isPrivileged && !isTrainee}
                         data-wi={it.wi} data-ti={it.ti} data-taskid={it.task_id}
                         onDragStart={hasPerm('task.assign') && isPrivileged && !isTrainee ? handleDragStart : undefined} onDragEnd={hasPerm('task.assign') && isPrivileged && !isTrainee ? handleDragEnd : undefined}
                         onTouchStart={hasPerm('task.assign') && isPrivileged && !isTrainee ? handleDragStart : undefined} onTouchMove={hasPerm('task.assign') && isPrivileged && !isTrainee ? handleTouchMove : undefined}
                         onTouchEnd={hasPerm('task.assign') && isPrivileged && !isTrainee ? handleTouchEnd : undefined} onTouchCancel={hasPerm('task.assign') && isPrivileged && !isTrainee ? handleTouchEnd : undefined}>
                      {it.label}
                      {hasPerm('task.assign') && isPrivileged && !isTrainee && (
                        <button type="button" aria-label="Remove"
                                className="absolute -top-1 -right-1 text-xs leading-none text-slate-500 hover:text-slate-700"
                                onClick={(e) => { e.stopPropagation(); setTaskDate(it.wi, it.ti, null, it.task_id); }}
                                onMouseDown={(e) => e.stopPropagation()} onTouchStart={(e) => e.stopPropagation()}>
                          ✕
                        </button>
                      )}
                    </div>
                  ))}
                  {items.length>3 && (
                    <button type="button" className="text-[11px] text-slate-500" onClick={()=> toggleExpandedDay(key)}>
                      {expanded ? 'Show less' : `+${items.length-3} more…`}
                    </button>
                  )}
                </div>
              </div>
            );
          })}
        </div>
        {assignPicker && hasPerm('task.assign') && isPrivileged && !isTrainee && <AssignModal date={assignPicker.date} onClose={()=> setAssignPicker(null)} />}
        {programModal.show && <ProgramModal program={programModal.program} onClose={()=> setProgramModal({show:false, program:null})} />}
      </Section>
      )}

      {/* Weeks & Tasks */}
      <Section title="Weeks & Tasks">
        <div className="space-y-6">
          {weeks.map((w, wi)=>{
            const pct = Math.round(100*((w.tasks||[]).filter(t=>t.completed).length / ((w.tasks||[]).length||1)));
            return (
              <div key={w.id} className="card p-4">
                <div className="flex items-center justify-between">
                  <div>
                    <div className="text-lg font-semibold">Week {w.wk}: {w.title}</div>
                    <div className="text-sm text-slate-500">{w.theme}</div>
                  </div>
                  <div className="w-48"><ProgressBar value={pct}/><div className="text-xs text-right mt-1">{pct}%</div></div>
                </div>
                <div className="grid md:grid-cols-2 gap-3 mt-4">
                  {(w.tasks||[]).map((t,ti)=> (
                    <div key={t.id} className={`card p-3 relative ${t.completed?'border-emerald-300 bg-emerald-50':''}`}>
                      {hasPerm('task.delete') && isPrivileged && !isTrainee && (
                        <button type="button" aria-label="Delete" className="absolute top-1 right-1 text-xs text-slate-500 hover:text-slate-700"
                                onClick={()=> handleDeleteTask(wi,ti)}>✕</button>
                      )}
                      <div className="flex items-start gap-3">
                        <input type="checkbox" className="mt-1" checked={t.completed} onChange={()=> toggleTask(wi,ti)} />
                        <div className="flex-1">
                          <div className="font-medium">{t.title}</div>
                          {hasPerm('task.assign') && isPrivileged && !isTrainee && (
                            <div className="mt-2 flex items-center gap-2 text-sm">
                              <span className="text-slate-600">Assigned:</span>
                              <input type="date" className="input w-auto" value={t.scheduled_for||''}
                                     onChange={e=> setTaskDate(wi,ti, e.target.value||null, t.task_id)} />
                            </div>
                          )}
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
                {hasPerm('task.create') && !isTrainee && (
                  <button className="btn btn-outline mt-3" onClick={()=> handleAddTask(wi)}>+ Add Task</button>
                )}
              </div>
            );
          })}
        </div>
      </Section>
      {hasPerm('task.delete') && isPrivileged && !isTrainee && (
      <Section title="Deleted Tasks">
        <div className="space-y-2">
          {deletedTasks.length ? (
            deletedTasks.map(t => (
              <div key={t.task_id} className="flex items-center justify-between">
                <span>{t.label || t.title}</span>
                <button className="btn btn-ghost text-xs" onClick={() => handleRestoreTask(t.task_id)}>Restore</button>
              </div>
            ))
          ) : (
            <div className="text-sm text-slate-500">No deleted tasks</div>
          )}
        </div>
      </Section>
      )}
    </div>
      {panelOpen && (
        <div
          className="fixed inset-0 bg-black/50 md:hidden overscroll-contain touch-none"
          onClick={togglePanel}
          tabIndex={0}
        ></div>
      )}
      {!isTrainee && (
      <button
        id="side-panel-toggle"
        onClick={togglePanel}
        aria-label="Toggle side panel"
        aria-expanded={panelOpen}
        aria-controls="side-panel"
        className="fixed right-0 top-1/2 z-50 transform -translate-y-1/2 p-1 bg-white border rounded-l shadow"
        style={{ right: panelOpen ? panelWidth : 0 }}
      >
        {panelOpen ? (
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth="2" stroke="currentColor" className="w-4 h-4">
            <path strokeLinecap="round" strokeLinejoin="round" d="M15 19l-7-7 7-7" />
          </svg>
        ) : (
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth="2" stroke="currentColor" className="w-4 h-4">
            <path strokeLinecap="round" strokeLinejoin="round" d="M9 5l7 7-7 7" />
          </svg>
        )}
      </button>
      )}
      {/* SidePanel: container uses `card`; buttons use `btn`; fields use `input` for consistent styling */}
      {panelOpen && (
        <div
          className="hidden md:block fixed inset-y-0 z-50 w-1 cursor-col-resize"
          style={{ right: panelWidth }}
          onPointerDown={startResize}
          tabIndex={0}
        ></div>
      )}
      <aside
          id="side-panel"
          ref={panelRef}
          role="dialog"
          aria-modal="true"
          aria-labelledby="panel-heading"
          className={`card bg-slate-50 p-4 space-y-4 transform transition-transform duration-300 fixed inset-y-0 right-0 z-50
                     ${panelOpen ? 'translate-x-0' : 'translate-x-full'}`}
          style={{ width: panelWidth }}
        >
        <h2 id="panel-heading" className="sr-only">Side Panel</h2>
        <div className="flex items-center gap-3 pb-4 border-b border-slate-200">
          <div className="w-10 h-10 rounded-full bg-slate-200 flex items-center justify-center text-sm font-semibold">
            {(acctName||'').split(/\s+/).map(n=>n[0]).join('').slice(0,2).toUpperCase()}
          </div>
          <div className="flex-1 min-w-0">
            <div className="font-medium truncate">{acctName}</div>
            <div className="text-sm text-slate-500 truncate">{acctEmail}</div>
            {me?.roles?.length > 0 && (
              <div className="text-xs text-slate-500 truncate">Role: {me.roles.join(', ')}</div>
            )}
          </div>
          <button
            className="btn btn-ghost text-sm"
            onClick={()=> setOpenSections(prev=> prev.includes('account')? prev : [...prev,'account'])}
          >
            Edit
          </button>
        </div>
        <div className="pt-4 space-y-4">
          {isPrivileged && (
            <div>
              <label htmlFor="target-user" className="text-sm block mb-1">Viewing tasks for</label>
              <select id="target-user" className="input w-full" value={targetUserId} onChange={handleUserChange}>
                {userList.map(u => (
                  <option key={u.id} value={u.id}>{u.full_name}</option>
                ))}
              </select>
            </div>
          )}
          <input
            className="input w-full"
            placeholder="Search…"
            onChange={handleSearchChange}
          />
          {/* Account */}
          <div>
            <h3>
              <button
                id="hdr-account"
                type="button"
                className="btn btn-ghost w-full justify-between text-sm font-semibold"
                aria-expanded={openSections.includes('account')}
                aria-controls="sec-account"
                onClick={()=> toggleSection('account')}
              >
                <span className="flex items-center gap-2"><span aria-hidden="true">👤</span>Account</span>
                <span className={`transition-transform ${openSections.includes('account')? 'rotate-180':''}`}>⌄</span>
              </button>
            </h3>
            {openSections.includes('account') && (
              <div id="sec-account" className="mt-2 space-y-2" aria-labelledby="hdr-account">
                <form className="space-y-2" onSubmit={saveAccount}>
                  <div>
                    <label htmlFor="acct_fullname" className="text-sm block mb-1">Full name</label>
                    <input id="acct_fullname" className="input" value={acctName} onChange={e=> setAcctName(e.target.value)} />
                  </div>
                  <div>
                    <label htmlFor="acct_email" className="text-sm block mb-1">Email</label>
                    <input id="acct_email" className="input" value={acctEmail} onChange={e=> setAcctEmail(e.target.value)} />
                  </div>
                  <div>
                    <label htmlFor="acct_username" className="text-sm block mb-1">Username</label>
                    <input id="acct_username" className="input" value={acctUsername} onChange={e=> setAcctUsername(e.target.value)} />
                  </div>
                  {acctMsg && <div className="text-xs text-slate-500">{acctMsg}</div>}
                  <button className="btn btn-primary w-full mt-2" type="submit">Save</button>
                </form>
              </div>
            )}
          </div>

          {/* Password */}
          <div>
            <h3>
              <button
                id="hdr-password"
                type="button"
                className="btn btn-ghost w-full justify-between text-sm font-semibold"
                aria-expanded={openSections.includes('password')}
                aria-controls="sec-password"
                onClick={()=> toggleSection('password')}
              >
                <span className="flex items-center gap-2"><span aria-hidden="true">🔒</span>Password</span>
                <span className={`transition-transform ${openSections.includes('password')? 'rotate-180':''}`}>⌄</span>
              </button>
            </h3>
            {openSections.includes('password') && (
              <div id="sec-password" className="mt-2 space-y-2" aria-labelledby="hdr-password">
                <form className="space-y-2" onSubmit={changePassword}>
                  <div>
                    <label htmlFor="pw_current" className="text-sm block mb-1">Current Password</label>
                    <input id="pw_current" type="password" className="input" value={pwCurrent} onChange={e=> setPwCurrent(e.target.value)} />
                  </div>
                  <div>
                    <label htmlFor="pw_new" className="text-sm block mb-1">New Password</label>
                    <input id="pw_new" type="password" className="input" value={pwNew} onChange={e=> setPwNew(e.target.value)} />
                  </div>
                  {pwMsg && <div className="text-xs text-slate-500">{pwMsg}</div>}
                  <button className="btn btn-primary w-full mt-2" type="submit">Change Password</button>
                </form>
              </div>
            )}
          </div>

          {/* Programs & Templates */}
          <div>
            <h3>
              <button
                id="hdr-programs"
                type="button"
                className="btn btn-ghost w-full justify-between text-sm font-semibold"
                aria-expanded={openSections.includes('programs')}
                aria-controls="sec-programs"
                onClick={()=> toggleSection('programs')}
              >
                <span className="flex items-center gap-2"><span aria-hidden="true">📦</span>Programs & Templates</span>
                <span className={`transition-transform ${openSections.includes('programs')? 'rotate-180':''}`}>⌄</span>
              </button>
            </h3>
            {openSections.includes('programs') && (
              <div id="sec-programs" className="mt-2 space-y-3" aria-labelledby="hdr-programs">
                <div className="space-y-2">
                  {programs
                    .filter(p => (p.title || '').toLowerCase().includes(searchTerm.toLowerCase()))
                    .map(p => (
                    <div key={p.program_id} className="flex items-center gap-2 text-sm">
                      <span className="flex-1 flex items-center gap-2 truncate"><span aria-hidden="true">📘</span>{p.title}</span>
                      <button
                        className="btn btn-ghost"
                        onClick={() => refreshPrograms(p.program_id)}
                        title="Open"
                      >
                        <span aria-hidden="true">📂</span>
                        <span className="sr-only">Open</span>
                      </button>
                      {hasPerm('template.read') && !isTrainee && (
                        <button
                        className="btn btn-ghost"
                        onClick={() => {
                          setTemplateProgramId(p.program_id);
                          setShowTemplates(true);
                        }}
                        title="Templates"
                      >
                        <span aria-hidden="true">📝</span>
                        <span className="sr-only">Templates</span>
                      </button>
                      )}
                      {hasPerm('program.update') && !isTrainee && (
                        <details className="relative">
                          <summary className="btn btn-ghost px-2 -mr-2" tabIndex={0}>⋯</summary>
                          <div className="absolute right-0 z-10 mt-1 w-28 bg-white border rounded shadow">
                            <button
                              className="btn btn-ghost w-full justify-start"
                              onClick={() => setProgramModal({ show: true, program: p })}
                            >
                              <span aria-hidden="true">✏️</span>
                              <span>Edit</span>
                            </button>
                            {hasPerm('program.delete') && !isTrainee && (
                              <button
                                className="btn btn-ghost w-full justify-start"
                                onClick={() => handleDeleteProgram(p.program_id)}
                              >
                                <span aria-hidden="true">🗑️</span>
                                <span>Delete</span>
                              </button>
                            )}
                          </div>
                        </details>
                      )}
                    </div>
                  ))}
                </div>
                <div className="sticky bottom-0 bg-white pt-2">
                  {(hasPerm('program.create') || hasPerm('program.update')) && !isTrainee && (
                  <button
                    className="btn btn-primary w-full"
                    onClick={() => setProgramModal({ show: true, program: null })}
                  >
                    + New Program
                  </button>
                  )}
                </div>
              </div>
            )}
          </div>

          {/* Utilities */}
          <div>
            <h3>
              <button
                id="hdr-utilities"
                type="button"
                className="btn btn-ghost w-full justify-between text-sm font-semibold"
                aria-expanded={openSections.includes('utilities')}
                aria-controls="sec-utilities"
                onClick={()=> toggleSection('utilities')}
              >
                <span className="flex items-center gap-2"><span aria-hidden="true">🛠️</span>Utilities</span>
                <span className={`transition-transform ${openSections.includes('utilities')? 'rotate-180':''}`}>⌄</span>
              </button>
            </h3>
            {openSections.includes('utilities') && (
              <div id="sec-utilities" className="mt-2 space-y-3" aria-labelledby="hdr-utilities">
                <button className="btn btn-outline w-full" onClick={() => refreshPrograms()}>
                  Refresh Programs
                </button>
                {me.roles?.includes('admin') && (
                <button className="btn-outline w-full" onClick={() => window.location.href = '/admin/role-manager.html'}>
					      Role Manager
				        </button>
                )}
                <button className="btn btn-outline w-full" disabled>
                  Clear Cache (coming soon)
                </button>
                <button className="btn btn-outline w-full" onClick={onSignOut}>
                  Sign out
                </button>
              </div>
            )}
          </div>
        </div>
      </aside>
    {showTemplates && templateProgramId && hasPerm('template.read') && !isTrainee && (
      <TemplateModal
        programId={templateProgramId}
        onClose={() => setShowTemplates(false)}
      />
    )}
  </div>
  );
}

/* ---- ROOT: checks /me; shows AuthPanel or App ---- */
function Root(){
  const [me, setMe] = useState(null);
  const [checked, setChecked] = useState(false);

  async function loadUserAndPrefs(){
    try {
      const user = await apiGetMe();
      if (user){
        setMe(user);
        CURRENT_USER_ID = user.id;
        let targetId = user.id;
        let targetName = user.name;
        TARGET_USER_ID = targetId;
        TARGET_USER_NAME = targetName;
        const stored = readStoredTrainee();
        try {
          const prefs = await apiGetPrefs();
          const prefTrainee = prefs?.trainee ? String(prefs.trainee) : null;
          if (prefTrainee) {
            targetId = prefTrainee;
            if (stored && sameId(stored.id, prefTrainee)) {
              targetName = stored.name || '';
            } else {
              targetName = '';
            }
          } else if (stored?.id) {
            targetId = stored.id;
            targetName = stored.name || '';
          }
        } catch (err) {
          console.error('Failed to load prefs', err);
          if (stored?.id) {
            targetId = stored.id;
            targetName = stored.name || '';
          }
        }
        if (!targetName) {
          if (stored && sameId(stored.id, targetId) && stored.name) {
            targetName = stored.name;
          } else if (sameId(targetId, user.id)) {
            targetName = user.name;
          }
        }
        const normalizedId = targetId ? String(targetId) : targetId;
        TARGET_USER_ID = normalizedId;
        TARGET_USER_NAME = targetName;
        writeStoredTrainee(normalizedId, targetName);
      } else {
        setMe(null);
        CURRENT_USER_ID = null;
        TARGET_USER_ID = null;
        TARGET_USER_NAME = null;
        writeStoredTrainee(null);
      }
    } catch (err) {
      console.error('Failed to initialize user session', err);
      setMe(null);
      CURRENT_USER_ID = null;
      TARGET_USER_ID = null;
      TARGET_USER_NAME = null;
      writeStoredTrainee(null);
    } finally {
      setChecked(true);
    }
  }

  useEffect(()=>{
    loadUserAndPrefs();
  }, []);

  if (!checked){
    return (
      <div className="min-h-screen flex items-center justify-center w-full">
        <div className="max-w-2xl mx-auto card p-6">Loading…</div>
      </div>
    );
  }
  if (!me){
    return (
      <div className="min-h-screen flex items-center justify-center w-full">
        <AuthPanel onAuthed={async ()=> {
          localStorage.removeItem('anx_program_id');
          setChecked(false);
          await loadUserAndPrefs();
        }} />
      </div>
    );
  }
return <App me={me} onSignOut={async () => { const res = await apiLogout(); if(!res) return; writeStoredTrainee(null); window.location.href = '/'; }} />;
}

ReactDOM.createRoot(document.getElementById('root')).render(<Root/>);
</script>
</body>
</html>
